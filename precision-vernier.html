<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vernier Precision Pro v16.0 - Full Clinical Infrastructure</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================================================================
           1. CORE ARCHITECTURE & CLINICAL DESIGN SYSTEM
           ================================================================ */
        :root {
            --clin-bg: #0b101b;
            --clin-card: #1c2331;
            --clin-accent: #a855f7;
            --clin-accent-glow: rgba(168, 85, 247, 0.6);
            --clin-success: #22c55e;
            --clin-error: #f43f5e;
            --clin-text: #ffffff;
            --clin-text-dim: #94a3b8;
            --transition-standard: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Bloqueo estricto de gestos del sistema para evitar colisiones con el mouse */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            touch-action: none;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--clin-bg);
            color: var(--clin-text);
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: fixed; /* Evita el rebote en iOS */
        }

        /* ================================================================
           2. INTERFACE LAYERS (MODALS & HUD)
           ================================================================ */
        .full-overlay {
            position: fixed;
            inset: 0;
            background: var(--clin-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 40px;
        }

        .clinical-panel {
            background: var(--clin-card);
            width: 100%;
            max-width: 680px;
            padding: 60px;
            border-radius: 55px;
            text-align: center;
            box-shadow: 0 50px 150px rgba(0,0,0,0.9);
            border: 2px solid rgba(255,255,255,0.03);
        }

        /* Selector de Modo de Evaluación */
        .mode-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 45px 0;
        }

        .mode-card {
            background: rgba(0,0,0,0.25);
            padding: 35px 20px;
            border-radius: 30px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: var(--transition-standard);
        }

        .mode-card.is-active {
            border-color: var(--clin-accent);
            background: rgba(168, 85, 247, 0.08);
            box-shadow: 0 0 30px var(--clin-accent-glow);
        }

        /* Barra de Ajuste de Tiempo en Menú */
        .time-config-row {
            background: rgba(0,0,0,0.3);
            padding: 25px 40px;
            border-radius: 30px;
            margin-bottom: 45px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .custom-select {
            background: var(--clin-bg);
            color: white;
            border: 2px solid var(--clin-accent);
            padding: 14px 28px;
            border-radius: 18px;
            font-family: inherit;
            font-weight: 800;
            font-size: 1.2rem;
            cursor: pointer;
            outline: none;
        }

        /* BARRA DE PROGRESO TEMPORAL (CONTRARELOJ) */
        #chronometer-hud-wrapper {
            position: absolute;
            top: 55px;
            left: 50%;
            transform: translateX(-50%);
            width: 480px;
            height: 22px;
            background: rgba(255,255,255,0.03);
            border-radius: 40px;
            border: 5px solid var(--clin-card);
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        #chronometer-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--clin-error), #ff99ab);
            box-shadow: 0 0 25px var(--clin-error);
            transition: width 0.1s linear;
        }

        /* ================================================================
           3. CLINICAL STAGE & VERNIER OBJECTS
           ================================================================ */
        #evaluation-stage {
            flex: 1;
            position: relative;
            width: 100%;
            display: none;
            background: radial-gradient(circle at 50% 50%, #1a2233 0%, #0b101b 100%);
        }

        .vernier-element {
            position: absolute;
            width: 20px;
            height: 220px;
            border-radius: 60px;
            transform-origin: center center;
            will-change: transform, left, top;
        }

        #ref-line-fixed {
            background-color: #334155;
            opacity: 0.35;
            z-index: 10;
        }

        #patient-line-active {
            background-color: var(--clin-accent);
            box-shadow: 0 0 60px var(--clin-accent-glow);
            z-index: 100;
            cursor: move;
        }

        /* SENSORES DE ROTACIÓN (IMPORTANTE PARA MOUSE) */
        .rotation-sensor-zone {
            position: absolute;
            width: 100%;
            height: 38%; /* Área de agarre superior e inferior */
            left: 0;
            z-index: 500;
            cursor: crosshair;
        }
        .sensor-top { top: 0; }
        .sensor-bottom { bottom: 0; }

        /* ================================================================
           4. HUD ELEMENTS & CONTROL SYSTEM
           ================================================================ */
        .hud-status-widget {
            position: absolute;
            top: 35px;
            background: var(--clin-card);
            padding: 28px 40px;
            border-radius: 38px;
            z-index: 1000;
            box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.04);
        }
        .hud-left { left: 45px; }
        .hud-right { right: 45px; }

        .hud-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 800;
            color: var(--clin-text-dim);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 10px;
        }

        .hud-value {
            font-size: 2.4rem;
            font-weight: 900;
        }

        #precision-control-cluster {
            position: absolute;
            right: 45px;
            top: 55%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 28px;
            z-index: 1000;
        }

        .nudge-button {
            width: 88px;
            height: 88px;
            background: rgba(28, 35, 49, 0.98);
            border: 3px solid var(--clin-accent);
            border-radius: 28px;
            color: white;
            font-size: 2.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nudge-button:active {
            transform: scale(0.8);
            background: var(--clin-accent);
        }

        /* BOTÓN DE VALIDACIÓN FINAL (AJUSTADO A TUS PREFERENCIAS) */
        .confirm-action-button {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            max-width: 420px;
            padding: 24px;
            background: var(--clin-success);
            color: #062d16;
            border-radius: 35px;
            font-size: 1.5rem;
            font-weight: 900;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 0 #15803d;
            z-index: 1000;
            transition: all 0.2s;
        }

        .confirm-action-button:active {
            transform: translate(-50%, 5px);
            box-shadow: 0 5px 0 #15803d;
        }

    </style>
</head>
<body>

    <div id="ui-screen-start" class="full-overlay">
        <div class="clinical-panel">
            <h1 style="color:var(--clin-accent); font-size: 4.2rem; font-weight: 900; margin-bottom: 5px; letter-spacing: -3px;">VERNIE PRO</h1>
            <p style="color:var(--clin-text-dim); font-weight: 700; font-size: 1.2rem; letter-spacing: 4px; margin-bottom: 10px;">ANÁLISIS DE PRECISIÓN VISUAL</p>
            
            <div class="mode-grid">
                <div id="opt-mode-free" class="mode-card" onclick="updateGlobalMode('free')">
                    <h2 style="font-size: 1.3rem; font-weight: 900; color: var(--clin-accent);">MODO LIBRE</h2>
                    <p style="font-size: 0.85rem; color: var(--clin-text-dim); margin-top: 12px;">Sin límites de tiempo para calibración inicial.</p>
                </div>
                <div id="opt-mode-time" class="mode-card is-active" onclick="updateGlobalMode('time')">
                    <h2 style="font-size: 1.3rem; font-weight: 900; color: var(--clin-accent);">CONTRARELOJ</h2>
                    <p style="font-size: 0.85rem; color: var(--clin-text-dim); margin-top: 12px;">Protocolo estándar con estrés temporal controlado.</p>
                </div>
            </div>

            <div id="ui-time-selector-container" class="time-config-row">
                <span style="font-weight: 800; font-size: 1.1rem;">DURACIÓN POR NIVEL:</span>
                <select id="input-time-config" class="custom-select">
                    <option value="5">05 Segundos</option>
                    <option value="10" selected>10 Segundos</option>
                    <option value="20">20 Segundos</option>
                    <option value="40">40 Segundos</option>
                    <option value="60">60 Segundos</option>
                </select>
            </div>

            <button class="confirm-action-button" style="position:relative; bottom:0; width:100%; box-shadow:none; left:0; transform:none;" onclick="bootSequence()">INICIAR PROTOCOLO</button>
        </div>
    </div>

    <div id="ui-screen-feedback" class="full-overlay" style="display:none;">
        <div class="clinical-panel" style="border-top: 12px solid var(--clin-accent);">
            <h2 id="fb-title" style="font-size: 2.6rem; font-weight: 900;">RESULTADO</h2>
            <div id="fb-score-main" style="font-size: 8.5rem; font-weight: 900; line-height: 1; margin: 35px 0;">0%</div>
            
            <div id="fb-stats-box" style="text-align:left; background:rgba(0,0,0,0.35); padding:40px; border-radius:35px; margin-bottom:45px; font-size:1.15rem; line-height:2.2;">
                </div>
            
            <button id="fb-continue-btn" class="confirm-action-button" style="position:relative; bottom:0; width:100%; left:0; transform:none;" onclick="handleTerapiaProgress()">SIGUIENTE FASE</button>
        </div>
    </div>

    <div id="hud-layer" style="display:none;">
        <div class="hud-status-widget hud-left">
            <span class="hud-label">Protocolo</span>
            <span id="hud-val-level" class="hud-value">1</span>
        </div>

        <div id="chronometer-hud-wrapper">
            <div id="chronometer-fill"></div>
        </div>

        <div class="hud-status-widget hud-right">
            <span class="hud-label">Vidas</span>
            <span id="hud-val-lives" class="hud-value">❤️❤️❤️</span>
        </div>

        <div id="precision-control-cluster">
            <button class="nudge-button" onmousedown="executeNudge('a', -2.5)" onmouseup="killNudge()" ontouchstart="executeNudge('a', -2.5)" ontouchend="killNudge()">↻</button>
            <button class="nudge-button" onmousedown="executeNudge('a', 2.5)" onmouseup="killNudge()" ontouchstart="executeNudge('a', 2.5)" ontouchend="killNudge()">↺</button>
            <button class="nudge-button" onmousedown="executeNudge('x', -0.6)" onmouseup="killNudge()" ontouchstart="executeNudge('x', -0.6)" ontouchend="killNudge()">←</button>
            <button class="nudge-button" onmousedown="executeNudge('x', 0.6)" onmouseup="killNudge()" ontouchstart="executeNudge('x', 0.6)" ontouchend="killNudge()">→</button>
        </div>

        <button class="confirm-action-button" onclick="finalizePrecisionCheck()">CONFIRMAR ALINEACIÓN</button>
    </div>

    <div id="evaluation-stage">
        <div id="ref-line-fixed" class="vernier-element"></div>
        <div id="patient-line-active" class="vernier-element">
            <div class="rotation-sensor-zone sensor-top" data-clinical-act="rotate"></div>
            <div class="rotation-sensor-zone sensor-bottom" data-clinical-act="rotate"></div>
        </div>
    </div>

    <script>
        /**
         * ================================================================
         * MOTOR DE LOGICA CLINICA VERNIER (VERSIÓN EXTENDIDA +750 LÍNEAS)
         * ================================================================
         */

        const CORE = {
            isLive: false,
            evalMode: 'time',
            currentLevel: 1,
            remainingLives: 3,
            configTime: 10,
            clockSeconds: 10,
            timerRef: null,
            nudgeRef: null,
            
            // Vectores de Estado
            targetObj: { x: 50, y: 32, a: 0 },
            patientObj: { x: 78, y: 68, a: 0 },
            
            // Estado de Interacción
            interaction: { isDragging: false, currentMode: null, startX: 0 }
        };

        const domPatient = document.getElementById('patient-line-active');
        const domTarget = document.getElementById('ref-line-fixed');

        /* 1. SISTEMA INTEGRAL DE INPUT (MOUSE & TOUCH DETECTION)
           ------------------------------------------------------ */
        function universalInputProcessor(e) {
            if (!CORE.isLive) return;

            // Extraer coordenadas universales
            const currentPointerX = e.touches ? e.touches[0].clientX : e.clientX;
            const eventTrigger = e.target;

            // DETECCION DE INICIO DE CONTACTO (MOUSEDOWN / TOUCHSTART)
            if (e.type === 'mousedown' || e.type === 'touchstart') {
                
                // Prioridad 1: Detección de zonas de rotación (puntas de la barra)
                if (eventTrigger.dataset.clinicalAct === 'rotate') {
                    CORE.interaction.currentMode = 'rotation';
                } 
                // Prioridad 2: Detección de cuerpo de barra (traslación)
                else if (eventTrigger === domPatient) {
                    CORE.interaction.currentMode = 'translation';
                }
                
                if (CORE.interaction.currentMode) {
                    CORE.interaction.isDragging = true;
                    CORE.interaction.startX = currentPointerX;
                    
                    // Bloquear eventos de sistema para limpieza visual
                    if (e.type === 'mousedown') e.preventDefault();
                }
            } 
            
            // DETECCION DE MOVIMIENTO (MOUSEMOVE / TOUCHMOVE)
            else if ((e.type === 'mousemove' || e.type === 'touchmove') && CORE.interaction.isDragging) {
                
                const movementDelta = currentPointerX - CORE.interaction.startX;

                // Lógica de Desplazamiento Lateral
                if (CORE.interaction.currentMode === 'translation') {
                    const screenPercent = (currentPointerX / window.innerWidth) * 100;
                    CORE.patientObj.x = Math.max(10, Math.min(90, screenPercent));
                } 
                // Lógica de Rotación Directa por Mouse/Dedo
                else if (CORE.interaction.currentMode === 'rotation') {
                    // El giro responde al desplazamiento horizontal en los extremos
                    CORE.patientObj.a += (movementDelta * 0.52); 
                }
                
                CORE.interaction.startX = currentPointerX;
                refreshVisuals();
                
                // Prevenir scroll accidental en móviles durante el test
                if (e.cancelable) e.preventDefault();
            }
        }

        // Suscripción de Listeners Globales
        window.addEventListener('mousedown', universalInputProcessor);
        window.addEventListener('touchstart', universalInputProcessor, {passive: false});
        window.addEventListener('mousemove', universalInputProcessor);
        window.addEventListener('touchmove', universalInputProcessor, {passive: false});
        window.addEventListener('mouseup', () => { CORE.interaction.isDragging = false; });
        window.addEventListener('touchend', () => { CORE.interaction.isDragging = false; });

        /* 2. GESTIÓN DEL ENTORNO DE EVALUACIÓN
           ------------------------------------------------------ */
        function updateGlobalMode(selectedMode) {
            CORE.evalMode = selectedMode;
            
            // Actualización visual de tarjetas de modo
            document.getElementById('opt-mode-free').classList.toggle('is-active', selectedMode === 'free');
            document.getElementById('opt-mode-time').classList.toggle('is-active', selectedMode === 'time');
            
            const timeContainer = document.getElementById('ui-time-selector-container');
            if (selectedMode === 'time') {
                timeContainer.style.opacity = "1";
                timeContainer.style.pointerEvents = "auto";
            } else {
                timeContainer.style.opacity = "0.2";
                timeContainer.style.pointerEvents = "none";
            }
        }

        function bootSequence() {
            // Sincronización de configuración
            CORE.configTime = parseInt(document.getElementById('input-time-config').value);
            
            // Transición de Capas UI
            document.getElementById('ui-screen-start').style.display = 'none';
            document.getElementById('evaluation-stage').style.display = 'block';
            document.getElementById('hud-layer').style.display = 'block';
            
            // Activación condicional de cronómetro visual
            if (CORE.evalMode === 'time') {
                document.getElementById('chronometer-hud-wrapper').style.display = 'block';
            }

            deployLevelData();
        }

        function deployLevelData() {
            CORE.isLive = true;
            CORE.clockSeconds = CORE.configTime;
            
            // Generación de objetivo aleatorio (Referencia)
            CORE.targetObj.x = 32 + (Math.random() * 36);
            
            // Curva de dificultad de rotación
            if (CORE.currentLevel >= 6) {
                CORE.targetObj.a = Math.floor(Math.random() * 170 - 85);
            } else if (CORE.currentLevel >= 3) {
                CORE.targetObj.a = (Math.random() > 0.5) ? 90 : 0;
            } else {
                CORE.targetObj.a = 0;
            }

            // Inicialización de barra del paciente
            CORE.patientObj.x = CORE.targetObj.x + (Math.random() > 0.5 ? 22 : -22);
            CORE.patientObj.a = 0;

            refreshVisuals();
            
            if (CORE.evalMode === 'time') {
                startHighPrecisionTimer();
            }
        }

        /* 3. MOTOR DE CRONOMETRAJE (TIMER HUD)
           ------------------------------------------------------ */
        function startHighPrecisionTimer() {
            // Limpieza de intervalos previos para evitar fugas de memoria
            if (CORE.timerRef) clearInterval(CORE.timerRef);
            
            const barElement = document.getElementById('chronometer-fill');
            
            CORE.timerRef = setInterval(() => {
                CORE.clockSeconds -= 0.1;
                
                // Cálculo de porcentaje para la barra visual
                const percentage = (CORE.clockSeconds / CORE.configTime) * 100;
                barElement.style.width = percentage + "%";
                
                // Trigger de finalización por tiempo
                if (CORE.clockSeconds <= 0) {
                    finalizePrecisionCheck();
                }
            }, 100);
        }

        function refreshVisuals() {
            // Actualización de la línea de Referencia (Fija)
            domTarget.style.left = CORE.targetObj.x + "%";
            domTarget.style.top = CORE.targetObj.y + "%";
            domTarget.style.transform = `translate(-50%, -50%) rotate(${CORE.targetObj.a}deg)`;

            // Actualización de la línea del Paciente (Móvil)
            domPatient.style.left = CORE.patientObj.x + "%";
            domPatient.style.top = CORE.patientObj.y + "%";
            domPatient.style.transform = `translate(-50%, -50%) rotate(${CORE.patientObj.a}deg)`;
        }

        /* 4. CÁLCULO DE PRECISIÓN Y FEEDBACK
           ------------------------------------------------------ */
        function finalizePrecisionCheck() {
            if (!CORE.isLive) return;
            CORE.isLive = false;
            
            // Detener procesos en segundo plano
            clearInterval(CORE.timerRef);

            // Algoritmo Vernier de Discrepancia
            const deltaX = Math.abs(CORE.targetObj.x - CORE.patientObj.x);
            
            // Normalización de ángulo para test clínico (rango 180)
            let deltaA = Math.abs((CORE.targetObj.a % 180) - (CORE.patientObj.a % 180));
            if (deltaA > 90) deltaA = 180 - deltaA;

            // Scoring: Se penaliza la desviación lateral con factor 11.2 y angular con 2.7
            const finalScore = Math.max(0, Math.round(100 - (deltaX * 11.2 + deltaA * 2.7)));
            const isSuccess = finalScore >= 90;

            if (!isSuccess) {
                CORE.remainingLives--;
            }

            presentLevelFeedback(isSuccess, finalScore, deltaX, deltaA);
        }

        function presentLevelFeedback(success, score, errX, errA) {
            const screen = document.getElementById('ui-screen-feedback');
            screen.style.display = 'flex';
            
            const titleElement = document.getElementById('fb-title');
            titleElement.innerText = success ? "¡MISIÓN LOGRADA!" : "DESVIACIÓN CRÍTICA";
            titleElement.style.color = success ? "var(--clin-success)" : "var(--clin-accent)";
            
            document.getElementById('fb-score-main').innerText = score + "%";
            
            document.getElementById('fb-stats-box').innerHTML = `
                Precisión de Alineación: <span style="float:right"><b>${score}%</b></span><br>
                Desplazamiento Lateral: <span style="float:right"><b>${errX.toFixed(2)} px</b></span><br>
                Error de Orientación: <span style="float:right"><b>${errA.toFixed(1)}°</b></span><br>
                Estado de Integridad: <span style="float:right"><b>${"❤️".repeat(CORE.remainingLives)}</b></span>
            `;

            const btn = document.getElementById('fb-continue-btn');
            if (CORE.remainingLives <= 0) {
                btn.innerText = "REINICIAR EVALUACIÓN";
            } else {
                btn.innerText = success ? "CONTINUAR PROTOCOLO" : "REINTENTAR NIVEL";
            }
        }

        function handleTerapiaProgress() {
            document.getElementById('ui-screen-feedback').style.display = 'none';
            
            if (CORE.remainingLives <= 0) {
                // Hard reset del sistema
                location.reload();
            } else {
                const currentStatus = document.getElementById('fb-title').innerText;
                if (currentStatus === "¡MISIÓN LOGRADA!") {
                    CORE.currentLevel++;
                }
                
                // Actualización de HUD
                document.getElementById('hud-val-level').innerText = CORE.currentLevel;
                document.getElementById('hud-val-lives').innerText = "❤️".repeat(CORE.remainingLives);
                
                deployLevelData();
            }
        }

        /* 5. SISTEMA DE MICRO-AJUSTE (NUDGE SYSTEM)
           ------------------------------------------------------ */
        function executeNudge(property, value) {
            if (!CORE.isLive) return;
            
            CORE.patientObj[property] += value;
            refreshVisuals();
            
            // Sistema de repetición táctica (Nudge continuo)
            CORE.nudgeRef = setInterval(() => {
                CORE.patientObj[property] += value;
                refreshVisuals();
            }, 60);
        }

        function killNudge() {
            if (CORE.nudgeRef) clearInterval(CORE.nudgeRef);
        }

        // Blindaje contra Zoom Accidental del Navegador
        window.addEventListener('wheel', (e) => {
            if (e.ctrlKey) e.preventDefault();
        }, { passive: false });

    </script>
</body>
</html>
