<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vernier Precision Pro - Clinical Suite v7.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================================================================
           1. VARIABLES DE ESTILO Y TEMAS
           ================================================================
        */
        :root {
            --color-fondo-oscuro: #0b101b;
            --color-tarjeta: #1c2331;
            --color-primario-purpura: #a855f7;
            --color-purpura-brillo: rgba(168, 85, 247, 0.6);
            --color-exito-verde: #22c55e;
            --color-exito-oscuro: #16a34a;
            --color-error-rojo: #f43f5e;
            --color-texto-blanco: #ffffff;
            --color-texto-plata: #94a3b8;
            --fuente-principal: 'Montserrat', sans-serif;
            --suavizado: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ================================================================
           2. RESETEO Y BLOQUEO DE INTERACCIONES NATIVAS
           ================================================================
        */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background-color: var(--color-fondo-oscuro);
            color: var(--color-texto-blanco);
            font-family: var(--fuente-principal);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
        }

        /* ================================================================
           3. DISEÑO DE PANTALLAS (OVERLAYS)
           ================================================================
        */
        .pantalla-superpuesta {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-fondo-oscuro);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }

        .tarjeta-configuracion {
            background-color: var(--color-tarjeta);
            width: 100%;
            max-width: 550px;
            padding: 50px;
            border-radius: 45px;
            text-align: center;
            box-shadow: 0 40px 100px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* ================================================================
           4. SELECTORES DE MODO Y CONFIGURACIÓN
           ================================================================
        */
        .contenedor-modos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 35px 0;
        }

        .boton-modo {
            background-color: rgba(0,0,0,0.3);
            padding: 30px 15px;
            border-radius: 25px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: var(--suavizado);
        }

        .boton-modo.seleccionado {
            border-color: var(--color-primario-purpura);
            background-color: rgba(168, 85, 247, 0.1);
            box-shadow: 0 0 20px var(--color-purpura-brillo);
        }

        .titulo-modo {
            display: block;
            font-size: 0.9rem;
            font-weight: 900;
            color: var(--color-primario-purpura);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .descripcion-modo {
            font-size: 0.75rem;
            color: var(--color-texto-plata);
            line-height: 1.4;
        }

        /* Selector de Tiempo Estilo Profesional */
        .configuracion-tiempo {
            background-color: rgba(0,0,0,0.2);
            padding: 20px 30px;
            border-radius: 25px;
            margin-bottom: 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .etiqueta-tiempo {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--color-texto-blanco);
        }

        .selector-select {
            background-color: var(--color-fondo-oscuro);
            color: white;
            border: 1.5px solid var(--color-primario-purpura);
            padding: 10px 20px;
            border-radius: 15px;
            font-family: inherit;
            font-weight: 700;
            outline: none;
            cursor: pointer;
        }

        /* ================================================================
           5. HUD (INTERFAZ DURANTE EL JUEGO)
           ================================================================
        */
        #capa-hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
            z-index: 1000;
        }

        .bloque-estadistica {
            position: absolute;
            background-color: var(--color-tarjeta);
            padding: 20px 30px;
            border-radius: 25px;
            text-align: center;
            pointer-events: auto;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .posicion-nivel { top: 35px; left: 35px; }
        .posicion-vidas { top: 35px; right: 35px; }

        .etiqueta-hud {
            display: block;
            font-size: 0.7rem;
            font-weight: 900;
            color: var(--color-texto-plata);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .valor-hud {
            font-size: 1.8rem;
            font-weight: 900;
        }

        /* Barra de progreso de tiempo */
        #contenedor-timer {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 14px;
            background-color: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 2px solid var(--color-tarjeta);
            overflow: hidden;
        }

        #llenado-timer {
            width: 100%;
            height: 100%;
            background-color: var(--color-error-rojo);
            transition: width 0.1s linear;
        }

        /* ================================================================
           6. ELEMENTOS DEL JUEGO (BARRAS)
           ================================================================
        */
        #area-juego {
            flex: 1;
            position: relative;
            display: none;
            z-index: 10;
        }

        .barra-vernier {
            position: absolute;
            width: 16px;
            height: 140px;
            border-radius: 30px;
            transform-origin: center center;
            will-change: transform, left, top;
        }

        #barra-fija {
            background-color: #334155;
            opacity: 0.6;
            z-index: 5;
        }

        #barra-jugador {
            background-color: var(--color-primario-purpura);
            box-shadow: 0 0 35px var(--color-purpura-brillo);
            cursor: crosshair;
            z-index: 50;
            pointer-events: auto;
        }

        /* ================================================================
           7. BOTONES DE CONTROL Y ACCIÓN
           ================================================================
        */
        #panel-controles {
            position: absolute;
            right: 40px;
            top: 55%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            pointer-events: auto;
        }

        .boton-control {
            width: 80px;
            height: 80px;
            background-color: rgba(28, 35, 49, 0.9);
            border: 2.5px solid var(--color-primario-purpura);
            border-radius: 25px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--suavizado);
        }

        .boton-control:active {
            background-color: var(--color-primario-purpura);
            transform: scale(0.9);
        }

        #contenedor-confirmar {
            position: absolute;
            bottom: 45px;
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: auto;
        }

        .boton-confirmar {
            width: 85%;
            max-width: 500px;
            padding: 30px;
            background-color: var(--color-exito-verde);
            color: #062d16;
            border: none;
            border-radius: 45px;
            font-size: 1.6rem;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 10px 0 var(--color-exito-oscuro);
            cursor: pointer;
            transition: 0.1s;
        }

        .boton-confirmar:active {
            transform: translateY(6px);
            box-shadow: 0 4px 0 var(--color-exito-oscuro);
        }

        /* ================================================================
           8. MODAL DE RESULTADOS (CAPTURA)
           ================================================================
        */
        .modal-resultado {
            border-left: 12px solid var(--color-primario-purpura);
            animation: aparecer 0.4s ease-out;
        }

        @keyframes aparecer {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .lista-estadistica {
            text-align: left;
            background-color: rgba(0,0,0,0.25);
            padding: 25px;
            border-radius: 25px;
            margin: 25px 0;
            font-size: 0.95rem;
            line-height: 1.8;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .dato-resaltado {
            float: right;
            font-weight: 800;
            color: var(--color-texto-blanco);
        }

    </style>
</head>
<body>

    <div id="pantalla-inicio" class="pantalla-superpuesta">
        <div class="tarjeta-configuracion">
            <h1 style="color: var(--color-primario-purpura); font-size: 3rem; font-weight: 900; letter-spacing: -1px;">VERNIE PRO</h1>
            <p style="color: var(--color-texto-plata); font-weight: 600; margin-bottom: 30px;">Plataforma de Diagnóstico Visual</p>
            
            <div class="contenedor-modos">
                <div id="modo-entrenar" class="boton-modo" onclick="seleccionarModo('libre')">
                    <span class="titulo-modo">Entrenamiento</span>
                    <p class="descripcion-modo">Sin límite de tiempo. Ideal para aprendizaje.</p>
                </div>
                <div id="modo-desafio" class="boton-modo seleccionado" onclick="seleccionarModo('tiempo')">
                    <span class="titulo-modo">Contrareloj</span>
                    <p class="descripcion-modo">Evalúa la rapidez de respuesta clínica.</p>
                </div>
            </div>

            <div class="configuracion-tiempo" id="ajuste-tiempo">
                <span class="etiqueta-tiempo">Segundos por nivel:</span>
                <select id="segundos-select" class="selector-select">
                    <option value="5">5 Segundos</option>
                    <option value="10" selected>10 Segundos</option>
                    <option value="15">15 Segundos</option>
                    <option value="20">20 Segundos</option>
                </select>
            </div>

            <button class="boton-confirmar" onclick="comenzarJuego()" style="width: 100%;">COMENZAR SESIÓN</button>
        </div>
    </div>

    <div id="pantalla-resultados" class="pantalla-superpuesta" style="display: none;">
        <div class="tarjeta-configuracion modal-resultado">
            <h2 id="res-estado" style="font-size: 2.2rem; font-weight: 900; margin-bottom: 5px;">FUERA DE RANGO</h2>
            <p style="color: var(--color-texto-plata); font-weight: 700; margin-bottom: 20px;">MISIÓN TERMINADA</p>
            
            <div id="res-porcentaje" style="font-size: 6.5rem; font-weight: 900; line-height: 1; margin-bottom: 10px;">0%</div>
            
            <div class="lista-estadistica">
                Desviación Lateral: <span id="res-dist" class="dato-resaltado">0.00 px</span><br>
                Error Angular: <span id="res-ang" class="dato-resaltado">0.0°</span><br>
                Nivel de Misión: <span id="res-lvl" class="dato-resaltado">1</span><br>
                Vidas Restantes: <span id="res-hp" class="dato-resaltado">3</span>
            </div>
            
            <button id="res-boton-flujo" class="boton-confirmar" onclick="gestionarSiguientePaso()" style="width: 100%;">REINTENTAR NIVEL</button>
        </div>
    </div>

    <div id="capa-hud">
        <div class="bloque-estadistica posicion-nivel">
            <span class="etiqueta-hud">Misión</span>
            <span id="txt-nivel" class="valor-hud">1</span>
        </div>

        <div id="contenedor-timer">
            <div id="llenado-timer"></div>
        </div>

        <div class="bloque-estadistica posicion-vidas">
            <span class="etiqueta-hud">Integridad</span>
            <span id="txt-vidas" class="valor-hud">❤️❤️❤️</span>
        </div>

        <div id="panel-controles">
            <button class="boton-control" onmousedown="iniciarAjuste('a', -2)" onmouseup="pararAjuste()" ontouchstart="iniciarAjuste('a', -2)" ontouchend="pararAjuste()">↻</button>
            <button class="boton-control" onmousedown="iniciarAjuste('a', 2)" onmouseup="pararAjuste()" ontouchstart="iniciarAjuste('a', 2)" ontouchend="pararAjuste()">↺</button>
            <button class="boton-control" onmousedown="iniciarAjuste('x', -0.6)" onmouseup="pararAjuste()" ontouchstart="iniciarAjuste('x', -0.6)" ontouchend="pararAjuste()">←</button>
            <button class="boton-control" onmousedown="iniciarAjuste('x', 0.6)" onmouseup="pararAjuste()" ontouchstart="iniciarAjuste('x', 0.6)" ontouchend="pararAjuste()">→</button>
        </div>

        <div id="contenedor-confirmar">
            <button class="boton-confirmar" onclick="finalizarNivel()">CONFIRMAR ALINEACIÓN</button>
        </div>
    </div>

    <div id="area-juego">
        <div id="barra-fija" class="barra-vernier"></div>
        <div id="barra-jugador" class="barra-vernier"></div>
    </div>

    <script>
        
        // --- ESTADO GLOBAL DE LA APLICACIÓN ---
        const SOFTWARE = {
            modo: 'tiempo', // libre | tiempo
            nivel: 1,
            vidas: 3,
            jugando: false,
            tiempoMaximo: 10,
            intervaloReloj: null,
            intervaloNudge: null,
            // Datos de posicionamiento
            obj: { x: 50, y: 30, a: 0 },
            pac: { x: 50, y: 70, a: 0 },
            // Control de interacción
            tipoInteraccion: null // 'move' | 'rotate'
        };

        const barPac = document.getElementById('barra-jugador');
        const barObj = document.getElementById('barra-fija');

        /* SISTEMA DE INTERACCIÓN HÍBRIDO (MOUSE / TOUCH / ESQUINAS)
           --------------------------------------------------------
        */
        function procesarInput(e) {
            if (!SOFTWARE.jugando) return;

            const rect = barPac.getBoundingClientRect();
            const posX = e.touches ? e.touches[0].clientX : e.clientX;
            const posY = e.touches ? e.touches[0].clientY : e.clientY;

            // INICIO DEL CONTACTO
            if (e.type === 'mousedown' || e.type === 'touchstart') {
                if (e.target === barPac) {
                    // Detección de zona: ¿Es el centro o los extremos?
                    const areaRelativaY = (posY - rect.top) / rect.height;
                    
                    // Si toca el 20% superior o el 20% inferior, activa ROTACIÓN
                    if (areaRelativaY < 0.22 || areaRelativaY > 0.78) {
                        SOFTWARE.tipoInteraccion = 'rotate';
                    } else {
                        SOFTWARE.tipoInteraccion = 'move';
                    }
                }
            } 
            
            // MOVIMIENTO ACTIVO
            else if ((e.type === 'mousemove' || e.type === 'touchmove') && SOFTWARE.tipoInteraccion) {
                if (SOFTWARE.tipoInteraccion === 'move') {
                    // Mueve lateralmente
                    SOFTWARE.pac.x = (posX / window.innerWidth) * 100;
                } else {
                    // Rota basándose en el desplazamiento lateral desde el centro de la barra
                    const centroX = rect.left + rect.width / 2;
                    const diferencia = posX - centroX;
                    SOFTWARE.pac.a += diferencia * 0.15; // Sensibilidad de rotación
                }
                renderizarBarras();
                
                // Prevenir scroll en dispositivos móviles
                if (e.cancelable) e.preventDefault();
            }
        }

        // Listeners Globales
        window.addEventListener('mousedown', procesarInput);
        window.addEventListener('touchstart', procesarInput, {passive: false});
        window.addEventListener('mousemove', procesarInput);
        window.addEventListener('touchmove', procesarInput, {passive: false});
        window.addEventListener('mouseup', () => SOFTWARE.tipoInteraccion = null);
        window.addEventListener('touchend', () => SOFTWARE.tipoInteraccion = null);

        // Control por botones (Ajuste fino continuo)
        function iniciarAjuste(eje, val) {
            if (!SOFTWARE.jugando) return;
            SOFTWARE.pac[eje] += val;
            renderizarBarras();
            SOFTWARE.intervaloNudge = setInterval(() => {
                SOFTWARE.pac[eje] += val;
                renderizarBarras();
            }, 50);
        }

        function pararAjuste() {
            clearInterval(SOFTWARE.intervaloNudge);
        }

        // Rueda del ratón para rotación rápida
        window.addEventListener('wheel', (e) => {
            if (!SOFTWARE.jugando) return;
            SOFTWARE.pac.a += e.deltaY > 0 ? 3 : -3;
            renderizarBarras();
        });

        /* GESTIÓN DEL FLUJO CLÍNICO
           -------------------------
        */
        function seleccionarModo(m) {
            SOFTWARE.modo = m;
            document.getElementById('modo-entrenar').classList.toggle('seleccionado', m === 'libre');
            document.getElementById('modo-desafio').classList.toggle('seleccionado', m === 'tiempo');
            document.getElementById('ajuste-tiempo').style.opacity = m === 'tiempo' ? '1' : '0.3';
        }

        function comenzarJuego() {
            SOFTWARE.tiempoMaximo = parseInt(document.getElementById('segundos-select').value);
            document.getElementById('pantalla-inicio').style.display = 'none';
            document.getElementById('area-juego').style.display = 'block';
            document.getElementById('capa-hud').style.display = 'block';
            
            if (SOFTWARE.modo === 'libre') {
                document.getElementById('contenedor-timer').style.display = 'none';
            }

            cargarMision();
        }

        function cargarMision() {
            SOFTWARE.jugando = true;
            
            // Posicionamiento objetivo aleatorio
            SOFTWARE.obj.x = 35 + (Math.random() * 30);
            SOFTWARE.obj.y = 25 + (Math.random() * 10);
            
            // Dificultad angular progresiva
            if (SOFTWARE.nivel >= 5) {
                SOFTWARE.obj.a = Math.floor(Math.random() * 180);
            } else if (SOFTWARE.nivel >= 2) {
                SOFTWARE.obj.a = Math.random() > 0.5 ? 90 : 0;
            } else {
                SOFTWARE.obj.a = 0;
            }

            // Reset de barra de paciente con desplazamiento (Vernier Offset)
            SOFTWARE.pac.x = SOFTWARE.obj.x + (Math.random() > 0.5 ? 20 : -20);
            SOFTWARE.pac.a = 0;

            renderizarBarras();
            if (SOFTWARE.modo === 'tiempo') arrancarCrono();
        }

        function renderizarBarras() {
            barObj.style.left = SOFTWARE.obj.x + "%";
            barObj.style.top = SOFTWARE.obj.y + "%";
            barObj.style.transform = `translate(-50%, -50%) rotate(${SOFTWARE.obj.a}deg)`;

            barPac.style.left = SOFTWARE.pac.x + "%";
            barPac.style.top = SOFTWARE.pac.y + "%";
            barPac.style.transform = `translate(-50%, -50%) rotate(${SOFTWARE.pac.a}deg)`;
        }

        function arrancarCrono() {
            let actual = SOFTWARE.tiempoMaximo;
            const bar = document.getElementById('llenado-timer');
            clearInterval(SOFTWARE.intervaloReloj);

            SOFTWARE.intervaloReloj = setInterval(() => {
                actual -= 0.1;
                bar.style.width = (actual / SOFTWARE.tiempoMaximo * 100) + "%";
                if (actual <= 0) finalizarNivel();
            }, 100);
        }

        /* SISTEMA DE EVALUACIÓN (ALINEACIÓN)
           ----------------------------------
        */
        function finalizarNivel() {
            if (!SOFTWARE.jugando) return;
            SOFTWARE.jugando = false;
            clearInterval(SOFTWARE.intervaloReloj);

            // Cálculo de errores
            const errorLateral = Math.abs(SOFTWARE.obj.x - SOFTWARE.pac.x);
            let errorAngulo = Math.abs((SOFTWARE.obj.a % 180) - (SOFTWARE.pac.a % 180));
            if (errorAngulo > 90) errorAngulo = 180 - errorAngulo;

            // Algoritmo de puntuación (Vernier Clinical Score)
            const score = Math.max(0, 100 - (errorLateral * 12 + errorAngulo * 3.5));
            const esExito = score >= 90;

            if (!esExito) SOFTWARE.vidas--;

            mostrarPantallaResultados(esExito, score, errorLateral, errorAngulo);
        }

        function mostrarPantallaResultados(win, pts, dx, da) {
            const overlay = document.getElementById('pantalla-resultados');
            overlay.style.display = 'flex';
            
            const titulo = document.getElementById('res-estado');
            titulo.innerText = win ? "¡LOGRADO!" : "FUERA DE RANGO";
            titulo.style.color = win ? "var(--color-exito-verde)" : "var(--color-primario-purpura)";
            
            document.getElementById('res-porcentaje').innerText = Math.round(pts) + "%";
            document.getElementById('res-dist').innerText = dx.toFixed(2) + " px";
            document.getElementById('res-ang').innerText = da.toFixed(1) + "°";
            document.getElementById('res-lvl').innerText = SOFTWARE.nivel;
            document.getElementById('res-hp').innerText = SOFTWARE.vidas;

            const btn = document.getElementById('res-boton-flujo');
            if (SOFTWARE.vidas <= 0) {
                btn.innerText = "FINALIZAR SESIÓN";
            } else {
                btn.innerText = win ? "SIGUIENTE NIVEL" : "REINTENTAR NIVEL";
            }
        }

        function gestionarSiguientePaso() {
            document.getElementById('pantalla-resultados').style.display = 'none';
            
            if (SOFTWARE.vidas <= 0) {
                alert("ENTRENAMIENTO FINALIZADO.\nLos datos han sido registrados en la base de datos clínica.");
                location.reload();
            } else {
                const tituloAct = document.getElementById('res-estado').innerText;
                if (tituloAct === "¡LOGRADO!") SOFTWARE.nivel++;
                
                document.getElementById('txt-nivel').innerText = SOFTWARE.nivel;
                document.getElementById('txt-vidas').innerText = "❤️".repeat(SOFTWARE.vidas);
                cargarMision();
            }
        }

    </script>
</body>
</html>
