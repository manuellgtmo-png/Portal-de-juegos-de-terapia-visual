<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precisión Vernier PRO - Versión Final Expandida</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES DE DISEÑO --- */
        :root { 
            --navy-bg: #0f172a; 
            --navy-card: #1e293b;
            --vernier-purple: #a855f7; 
            --green-neon: #22c55e;
            --danger-red: #f43f5e;
            --text-main: #f8fafc;
            --slate-gray: #475569;
        }

        /* --- BASE DEL DOCUMENTO --- */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
        }

        body { 
            margin: 0; padding: 0; 
            background-color: var(--navy-bg); 
            color: var(--text-main); 
            font-family: 'Montserrat', sans-serif; 
            overflow: hidden; 
            touch-action: none;
            width: 100vw; height: 100vh;
        }

        /* --- INTERFAZ HUD (ESTADÍSTICAS) --- */
        #hud-container { 
            position: absolute; top: 0; width: 100%; padding: 25px; 
            display: none; justify-content: space-between; align-items: flex-start; 
            z-index: 100; pointer-events: none;
        }

        .stat-panel { 
            background: var(--navy-card); 
            padding: 15px 25px; 
            border-radius: 25px; 
            font-weight: 900; 
            border: 1px solid rgba(255,255,255,0.1); 
            display: flex; flex-direction: column; 
            align-items: center; 
            min-width: 110px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .stat-label { 
            font-size: 0.75rem; 
            color: #94a3b8; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: 5px; 
        }

        .stat-value { font-size: 1.8rem; color: white; }

        /* --- ELEMENTOS DE JUEGO (LÍNEAS) --- */
        #game-canvas { 
            width: 100vw; height: 100vh; 
            position: relative; 
            overflow: hidden; 
        }
        
        .vernier-line { 
            position: absolute; 
            border-radius: 50px; 
            width: 14px; height: 180px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            transform-origin: center;
            will-change: transform, top, left;
            z-index: 10;
        }

        #target-line { 
            background-color: var(--slate-gray); 
            opacity: 0.7;
            z-index: 5; 
        }

        #player-line { 
            background-color: var(--vernier-purple); 
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4); 
            cursor: grab;
            z-index: 15;
        }

        #player-line:active { cursor: grabbing; box-shadow: 0 0 45px rgba(168, 85, 247, 0.7); }

        /* --- BOTÓN DE ACCIÓN PRINCIPAL --- */
        #confirm-action-btn { 
            position: absolute; 
            bottom: 45px; left: 50%; 
            transform: translateX(-50%); 
            width: 88%; max-width: 480px; 
            height: 85px; 
            background: var(--green-neon); 
            color: var(--navy-bg); 
            border: none; 
            border-radius: 45px; 
            font-size: 1.6rem; 
            cursor: pointer; 
            font-weight: 900; 
            text-transform: uppercase; 
            box-shadow: 0 10px 0 #16a34a; 
            z-index: 200; 
            transition: transform 0.1s, box-shadow 0.1s;
            display: none;
        }

        #confirm-action-btn:active { 
            transform: translateX(-50%) translateY(5px); 
            box-shadow: 0 5px 0 #16a34a; 
        }

        /* --- OVERLAYS Y MODALES --- */
        .full-screen-overlay { 
            position: fixed; inset: 0; 
            background: rgba(15, 23, 42, 0.98); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            padding: 20px; text-align: center; 
            z-index: 400; 
        }

        .glass-card { 
            background: var(--navy-card); 
            padding: 50px; 
            border-radius: 50px; 
            width: 95%; max-width: 600px; 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
        }

        /* --- MENSAJES DE ERROR --- */
        #error-toast {
            position: fixed; top: 45%; left: 50%; 
            transform: translate(-50%, -50%) scale(0);
            background: var(--danger-red); 
            color: white; 
            padding: 40px 70px; 
            border-radius: 35px;
            font-weight: 900; 
            font-size: 2.5rem; 
            z-index: 500; 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; 
            border: 8px solid white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        #error-toast.active { transform: translate(-50%, -50%) scale(1); }

    </style>
</head>
<body>

    <div id="error-toast">¡DESALINEADO!</div>

    <div id="screen-start" class="full-screen-overlay">
        <div class="glass-card">
            <h1 style="color:var(--vernier-purple); font-size: 2.8rem; margin-bottom: 10px; font-weight: 900;">VERNIER PRO</h1>
            <p style="color: #94a3b8; font-size: 1.1rem; margin-bottom: 40px;">Sistema de Entrenamiento Visual</p>
            
            <div style="background: rgba(0,0,0,0.2); padding: 30px; border-radius: 35px; text-align: left; margin-bottom: 40px;">
                <p style="margin: 0 0 10px 0; color: var(--green-neon); font-weight: bold;">OBJETIVO:</p>
                <p style="margin: 0; font-size: 0.95rem; line-height: 1.6;">
                    Alinea la barra morada con la gris. El margen de error permitido es del <b>10%</b>. 
                    A partir del nivel 5, prepárate para alineaciones <b>diagonales</b>.
                </p>
            </div>

            <button onclick="iniciarSesion()" style="background:var(--green-neon); color:var(--navy-bg); width:100%; border-radius:50px; padding:25px; font-weight:900; border:none; cursor:pointer; font-size: 1.5rem; box-shadow: 0 8px 0 #16a34a;">
                INICIAR MISIÓN
            </button>
        </div>
    </div>

    <div id="screen-success" class="full-screen-overlay" style="display: none;">
        <div class="glass-card" style="border: 3px solid var(--green-neon);">
            <h2 style="color:var(--green-neon); font-size: 2.5rem; margin: 0;">¡BIEN HECHO!</h2>
            <div style="margin: 40px 0; background: rgba(0,0,0,0.3); padding: 40px; border-radius: 40px;">
                <p style="text-transform: uppercase; color: #94a3b8; letter-spacing: 2px; font-size: 0.8rem; margin-bottom: 10px;">Exactitud Lograda</p>
                <div id="txt-precision" style="font-size: 5rem; font-weight: 900; color: var(--vernier-purple); line-height: 1;">98%</div>
            </div>
            <button onclick="continuarAlSiguienteNivel()" style="background:var(--green-neon); color:var(--navy-bg); width:100%; border-radius:50px; padding:25px; font-weight:900; border:none; cursor:pointer; font-size: 1.5rem;">
                SIGUIENTE RETO
            </button>
        </div>
    </div>

    <div id="hud-container">
        <div class="stat-panel"><span class="stat-label">Nivel</span><span id="display-nivel" class="stat-value">1</span></div>
        <div class="stat-panel"><span class="stat-label">Vidas</span><span id="display-vidas" class="stat-value">❤️❤️❤️</span></div>
    </div>

    <div id="game-canvas">
        <div id="target-line" class="vernier-line"></div>
        <div id="player-line" class="vernier-line"></div>
        <button id="confirm-action-btn" onclick="procesarVerificacion()">CONFIRMAR ALINEACIÓN</button>
    </div>

    <script>
        // --- CONSTANTES DE INTEGRACIÓN (GOOGLE SHEETS) ---
        const WEB_APP_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const SHEET_MAP = {
            paciente: "entry.369874016",
            juego: "entry.1353470174",
            nivel: "entry.721051298",
            aciertos: "entry.873272199",
            fallos: "entry.1030094511",
            fecha: "entry.845098414"
        };

        // --- ESTADO DEL JUEGO ---
        let nivel = 1, vidas = 3, aciertosTotales = 0, fallosTotales = 0;
        let dataFija = {x: 0, y: 0, angulo: 0};
        let dataMovil = {x: 0, y: 0, angulo: 0};
        let juegoEstaActivo = false;
        let estaSiendoArrastrado = false;

        // --- FLUJO DE INICIO ---
        function iniciarSesion() {
            document.getElementById('screen-start').style.display = 'none';
            document.getElementById('hud-container').style.display = 'flex';
            document.getElementById('confirm-action-btn').style.display = 'block';
            juegoEstaActivo = true;
            prepararEscenario();
        }

        function prepararEscenario() {
            // Algoritmo de Safe Zone (Evita que nazcan en bordes o sobre el botón)
            // X entre 25% y 75% | Y entre 20% y 60%
            dataFija.x = 25 + (Math.random() * 50);
            dataFija.y = 20 + (Math.random() * 40);

            // Determinar orientación según nivel
            let chance = Math.random();
            if (nivel >= 5 && chance > 0.6) {
                dataFija.angulo = 45; // Modo Diagonal
            } else if (chance > 0.3) {
                dataFija.angulo = 90; // Modo Vertical
            } else {
                dataFija.angulo = 0;  // Modo Horizontal
            }

            // Posición inicial del jugador (Alejado del objetivo)
            dataMovil.x = dataFija.x > 50 ? 15 : 85;
            dataMovil.y = 65; // Parte inferior del área de juego
            dataMovil.angulo = dataFija.angulo;

            renderizarLíneas();
        }

        function renderizarLíneas() {
            const elFijo = document.getElementById('target-line');
            const elMovil = document.getElementById('player-line');

            elFijo.style.left = dataFija.x + "%";
            elFijo.style.top = dataFija.y + "%";
            elFijo.style.transform = `translate(-50%, -50%) rotate(${dataFija.angulo}deg)`;

            elMovil.style.left = dataMovil.x + "%";
            elMovil.style.top = dataMovil.y + "%";
            elMovil.style.transform = `translate(-50%, -50%) rotate(${dataMovil.angulo}deg)`;
        }

        // --- LÓGICA DE INTERACCIÓN (SOPORTE TOTAL PC Y MÓVIL) ---
        const lineaJugador = document.getElementById('player-line');

        // Función unificada para manejar el movimiento
        const manejarMovimiento = (e) => {
            if (!estaSiendoArrastrado || !juegoEstaActivo) return;
            
            const pointer = e.touches ? e.touches[0] : e;
            
            // Cálculo de posición en porcentaje
            let nuevoX = (pointer.clientX / window.innerWidth) * 100;
            let nuevoY = (pointer.clientY / window.innerHeight) * 100;

            // REGLA DE ORO: No permitimos que la línea baje del 75% (Zona del botón)
            dataMovil.x = nuevoX;
            dataMovil.y = Math.min(nuevoY, 74); 

            renderizarLíneas();
        };

        // Eventos de inicio
        const activarArrastre = (e) => {
            if(juegoEstaActivo) {
                estaSiendoArrastrado = true;
                if(e.type === 'touchstart') e.preventDefault();
            }
        };

        // Enlace de eventos (PC + MÓVIL)
        lineaJugador.addEventListener('mousedown', activarArrastre);
        lineaJugador.addEventListener('touchstart', activarArrastre, {passive: false});

        window.addEventListener('mousemove', manejarMovimiento);
        window.addEventListener('touchmove', manejarMovimiento, {passive: false});

        window.addEventListener('mouseup', () => estaSiendoArrastrado = false);
        window.addEventListener('touchend', () => estaSiendoArrastrado = false);

        // --- VALIDACIÓN Y MATEMÁTICAS ---
        function procesarVerificacion() {
            if (!juegoEstaActivo) return;

            // Distancia Euclidiana para soportar cualquier ángulo (H, V, Diag)
            const dx = dataFija.x - dataMovil.x;
            const dy = dataFija.y - dataMovil.y;
            const distanciaError = Math.sqrt(dx*dx + dy*dy);

            // EL MARGEN DEL 10%: 
            // En un sistema de 100 unidades, una barra de 180px representa ~25 unidades.
            // Un 10% de error es aprox 2.5 a 3.5 unidades.
            const margenPermitido = 3.6; 

            if (distanciaError <= margenPermitido) {
                marcarAcierto(distanciaError);
            } else {
                marcarFallo();
            }
        }

        function marcarAcierto(err) {
            juegoEstaActivo = false;
            aciertosTotales++;
            
            // Cálculo visual de precisión
            let score = Math.max(0, 100 - (err * 6)).toFixed(1);
            document.getElementById('txt-precision').innerText = score + "%";
            document.getElementById('screen-success').style.display = 'flex';
        }

        function marcarFallo() {
            juegoEstaActivo = false;
            fallosTotales++;
            vidas--;
            
            document.getElementById('display-vidas').innerText = "❤️".repeat(Math.max(0, vidas));
            
            const toast = document.getElementById('error-toast');
            toast.classList.add('active');

            setTimeout(() => {
                toast.classList.remove('active');
                if (vidas <= 0) {
                    finalizarYEnviar();
                } else {
                    juegoEstaActivo = true;
                    prepararEscenario();
                }
            }, 1400);
        }

        function continuarAlSiguienteNivel() {
            nivel++;
            document.getElementById('display-nivel').innerText = nivel;
            document.getElementById('screen-success').style.display = 'none';
            juegoEstaActivo = true;
            prepararEscenario();
        }

        // --- FINALIZACIÓN ---
        function finalizarYEnviar() {
            const formData = new FormData();
            formData.append(SHEET_MAP.paciente, localStorage.getItem('pacienteActual') || "Manu");
            formData.append(SHEET_MAP.juego, "Vernier PRO - Master");
            formData.append(SHEET_MAP.nivel, nivel);
            formData.append(SHEET_MAP.aciertos, aciertosTotales);
            formData.append(SHEET_MAP.fallos, fallosTotales);
            formData.append(SHEET_MAP.fecha, new Date().toLocaleDateString());

            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: formData })
                .then(() => {
                    alert("SESIÓN COMPLETADA\nNivel alcanzado: " + nivel);
                    location.reload();
                })
                .catch(() => location.reload());
        }
    </script>
</body>
</html>
