<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vernier Precision Pro - Clinical Suite v9.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================================================================
           1. SISTEMA DE VARIABLES Y DISEÑO ATÓMICO
           ================================================================
        */
        :root {
            --fondo-principal: #0b101b;
            --fondo-tarjeta: #1c2331;
            --purpura-clinico: #a855f7;
            --purpura-resplandor: rgba(168, 85, 247, 0.6);
            --verde-exito: #22c55e;
            --verde-oscuro: #16a34a;
            --rojo-alerta: #f43f5e;
            --blanco-puro: #ffffff;
            --gris-plata: #94a3b8;
            --fuente: 'Montserrat', sans-serif;
            --transicion: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ================================================================
           2. RESETEO Y SEGURIDAD DE INTERFAZ (EVITA ZOOM Y SCROLL)
           ================================================================
        */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            /* Bloqueo nativo de gestos táctiles del sistema */
            touch-action: none;
        }

        body {
            background-color: var(--fondo-principal);
            color: var(--blanco-puro);
            font-family: var(--fuente);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: fixed; /* Asegura que la pantalla no se desplace en iOS */
        }

        /* ================================================================
           3. PANTALLAS DE CONTROL (OVERLAYS)
           ================================================================
        */
        .capa-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--fondo-principal);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9000;
            padding: 20px;
        }

        .contenedor-configuracion {
            background-color: var(--fondo-tarjeta);
            width: 100%;
            max-width: 580px;
            padding: 50px;
            border-radius: 45px;
            text-align: center;
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Bloque de Modos de Juego */
        .grid-modos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 35px 0;
        }

        .tarjeta-modo {
            background-color: rgba(0,0,0,0.3);
            padding: 25px 15px;
            border-radius: 25px;
            border: 2.5px solid transparent;
            cursor: pointer;
            transition: var(--transicion);
        }

        .tarjeta-modo.activa {
            border-color: var(--purpura-clinico);
            background-color: rgba(168, 85, 247, 0.12);
            box-shadow: 0 0 25px var(--purpura-resplandor);
        }

        .tarjeta-modo h3 {
            font-size: 0.85rem;
            font-weight: 900;
            color: var(--purpura-clinico);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tarjeta-modo p {
            font-size: 0.75rem;
            color: var(--gris-plata);
            line-height: 1.5;
            font-weight: 500;
        }

        /* Selector de Tiempo Dinámico */
        .contenedor-tiempo {
            background-color: rgba(0,0,0,0.25);
            padding: 20px 30px;
            border-radius: 25px;
            margin-bottom: 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transicion);
        }

        .etiqueta-tiempo {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--blanco-puro);
        }

        .select-clinico {
            background-color: var(--fondo-principal);
            color: var(--blanco-puro);
            border: 2px solid var(--purpura-clinico);
            padding: 10px 18px;
            border-radius: 15px;
            font-family: inherit;
            font-weight: 800;
            outline: none;
            cursor: pointer;
        }

        /* ================================================================
           4. HUD - INTERFAZ DURANTE LA EVALUACIÓN
           ================================================================
        */
        #interfaz-hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
            z-index: 1000;
        }

        .widget-hud {
            position: absolute;
            background-color: var(--fondo-tarjeta);
            padding: 18px 28px;
            border-radius: 25px;
            text-align: center;
            pointer-events: auto;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .hud-mision { top: 35px; left: 35px; }
        .hud-integridad { top: 35px; right: 35px; }

        .texto-mini {
            display: block;
            font-size: 0.7rem;
            font-weight: 900;
            color: var(--gris-plata);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .texto-grande {
            font-size: 1.8rem;
            font-weight: 900;
        }

        /* Barra de Tiempo Superior */
        #crono-container {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 14px;
            background-color: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 3px solid var(--fondo-tarjeta);
            overflow: hidden;
        }

        #crono-bar {
            width: 100%;
            height: 100%;
            background-color: var(--rojo-alerta);
            transition: width 0.1s linear;
        }

        /* ================================================================
           5. ESCENARIO CLÍNICO (BARRAS DE VERNIER)
           ================================================================
        */
        #escenario-clinico {
            flex: 1;
            position: relative;
            width: 100%;
            display: none;
            z-index: 10;
        }

        .barra-vernier {
            position: absolute;
            width: 16px;
            height: 160px;
            border-radius: 40px;
            transform-origin: center center;
            will-change: transform, left, top;
        }

        #barra-objetivo {
            background-color: #334155;
            opacity: 0.6;
            z-index: 5;
        }

        #barra-paciente {
            background-color: var(--purpura-clinico);
            box-shadow: 0 0 45px var(--purpura-resplandor);
            z-index: 100;
            cursor: move;
            pointer-events: auto;
        }

        /* Zonas de Detección de Rotación (Handles Invisibles) */
        .zona-rotacion {
            position: absolute;
            width: 100%;
            height: 25%;
            left: 0;
            z-index: 110;
        }
        .zona-superior { top: 0; }
        .zona-inferior { bottom: 0; }

        /* ================================================================
           6. CONTROLES LATERALES Y VALIDACIÓN
           ================================================================
        */
        #panel-botones {
            position: absolute;
            right: 40px;
            top: 55%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            pointer-events: auto;
        }

        .boton-ajuste {
            width: 80px;
            height: 80px;
            background-color: rgba(28, 35, 49, 0.95);
            border: 2.5px solid var(--purpura-clinico);
            border-radius: 25px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transicion);
        }

        .boton-ajuste:active {
            background-color: var(--purpura-clinico);
            transform: scale(0.9);
        }

        #zona-confirmar {
            position: absolute;
            bottom: 45px;
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: auto;
        }

        .boton-validar {
            width: 85%;
            max-width: 500px;
            padding: 30px;
            background-color: var(--verde-exito);
            color: #062d16;
            border: none;
            border-radius: 45px;
            font-size: 1.6rem;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 10px 0 var(--verde-oscuro);
            cursor: pointer;
            transition: 0.1s;
        }

        .boton-validar:active {
            transform: translateY(6px);
            box-shadow: 0 4px 0 var(--verde-oscuro);
        }

        /* ================================================================
           7. PANTALLA DE RESULTADOS (MODAL)
           ================================================================
        */
        .modal-resultado {
            border-left: 15px solid var(--purpura-clinico);
            animation: entradaSuave 0.4s ease-out;
        }

        @keyframes entradaSuave {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .bloque-datos {
            text-align: left;
            background-color: rgba(0,0,0,0.25);
            padding: 25px;
            border-radius: 30px;
            margin: 25px 0;
            font-size: 0.95rem;
            line-height: 1.8;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .valor-resaltado {
            float: right;
            font-weight: 800;
            color: var(--blanco-puro);
        }

    </style>
</head>
<body>

    <div id="pantalla-inicio" class="capa-overlay">
        <div class="contenedor-configuracion">
            <h1 style="color: var(--purpura-clinico); font-size: 3.2rem; font-weight: 900; letter-spacing: -1.5px;">VERNIE PRO</h1>
            <p style="color: var(--gris-plata); font-weight: 600; margin-bottom: 25px;">Protocolo de Hiperagudeza Visual</p>
            
            <div class="grid-modos">
                <div id="btn-libre" class="tarjeta-modo" onclick="configurarModo('libre')">
                    <h3>Entrenamiento</h3>
                    <p>Sesión abierta sin presión temporal para aprendizaje del paciente.</p>
                </div>
                <div id="btn-tiempo" class="tarjeta-modo activa" onclick="configurarModo('tiempo')">
                    <h3>Contrareloj</h3>
                    <p>Evaluación estandarizada bajo parámetros de tiempo clínico.</p>
                </div>
            </div>

            <div id="wrapper-tiempo" class="contenedor-tiempo">
                <span class="etiqueta-tiempo">Límite por Nivel:</span>
                <select id="select-tiempo" class="select-clinico">
                    <option value="5">5 Segundos</option>
                    <option value="10" selected>10 Segundos</option>
                    <option value="15">15 Segundos</option>
                    <option value="20">20 Segundos</option>
                </select>
            </div>

            <button class="boton-validar" style="width: 100%; position: relative; bottom: 0;" onclick="iniciarSoftware()">INICIAR PROTOCOLO</button>
        </div>
    </div>

    <div id="pantalla-resultados" class="capa-overlay" style="display: none;">
        <div class="contenedor-configuracion modal-resultado">
            <h2 id="res-titulo" style="font-size: 2.2rem; font-weight: 900; margin-bottom: 5px;">FUERA DE RANGO</h2>
            <p style="color: var(--gris-plata); font-weight: 700; margin-bottom: 15px;">RESULTADOS DEL TEST</p>
            
            <div id="res-score" style="font-size: 7rem; font-weight: 900; line-height: 1; color: var(--blanco-puro);">0%</div>
            
            <div class="bloque-datos">
                Desviación Lateral: <span id="res-x" class="valor-resaltado">0.00 px</span><br>
                Error Angular: <span id="res-a" class="valor-resaltado">0.0°</span><br>
                Misión Alcanzada: <span id="res-lvl" class="valor-resaltado">1</span><br>
                Estado Integridad: <span id="res-hp" class="valor-resaltado">❤️❤️❤️</span>
            </div>
            
            <button id="res-boton-accion" class="boton-validar" style="width: 100%;" onclick="flujoSiguienteNivel()">CONTINUAR</button>
        </div>
    </div>

    <div id="interfaz-hud">
        <div class="widget-hud hud-mision">
            <span class="texto-mini">Misión</span>
            <span id="txt-mision" class="texto-grande">1</span>
        </div>

        <div id="crono-container">
            <div id="crono-bar"></div>
        </div>

        <div class="widget-hud hud-integridad">
            <span class="texto-mini">Integridad</span>
            <span id="txt-vidas" class="texto-grande">❤️❤️❤️</span>
        </div>

        <div id="panel-botones">
            <button class="boton-ajuste" onmousedown="nudge('a', -2)" onmouseup="stopNudge()" ontouchstart="nudge('a', -2)" ontouchend="stopNudge()">↻</button>
            <button class="boton-ajuste" onmousedown="nudge('a', 2)" onmouseup="stopNudge()" ontouchstart="nudge('a', 2)" ontouchend="stopNudge()">↺</button>
            <button class="boton-ajuste" onmousedown="nudge('x', -0.6)" onmouseup="stopNudge()" ontouchstart="nudge('x', -0.6)" ontouchend="stopNudge()">←</button>
            <button class="boton-ajuste" onmousedown="nudge('x', 0.6)" onmouseup="stopNudge()" ontouchstart="nudge('x', 0.6)" ontouchend="stopNudge()">→</button>
        </div>

        <div id="zona-confirmar">
            <button class="boton-validar" onclick="evaluarPrecision()">CONFIRMAR ALINEACIÓN</button>
        </div>
    </div>

    <div id="escenario-clinico">
        <div id="barra-objetivo" class="barra-vernier"></div>
        <div id="barra-paciente" class="barra-vernier">
            <div class="zona-rotacion zona-superior" data-tipo="rotate"></div>
            <div class="zona-rotacion zona-inferior" data-tipo="rotate"></div>
        </div>
    </div>

    <script>
        
        /**
         * OBJETO DE ESTADO GLOBAL
         * Centraliza toda la información de la sesión para evitar pérdida de datos.
         */
        const SESION = {
            nivel: 1,
            vidas: 3,
            estaActivo: false,
            modoSeleccionado: 'tiempo', // 'libre' o 'tiempo'
            tiempoLimite: 10,
            tiempoRestante: 10,
            idIntervaloCrono: null,
            idIntervaloNudge: null,
            
            // Coordenadas de las barras (%)
            objetivo: { x: 50, y: 30, a: 0 },
            paciente: { x: 50, y: 70, a: 0 },
            
            // Control de Arrastre
            tipoDeDrag: null // 'move' o 'rotate'
        };

        const domPac = document.getElementById('barra-paciente');
        const domObj = document.getElementById('barra-objetivo');

        /* SISTEMA DE INTERACCIÓN HÍBRIDO (MOUSE/TOUCH/ZOOM-BLOCK)
           ------------------------------------------------------
        */
        function manejarInput(e) {
            if (!SESION.estaActivo) return;

            // Obtener coordenadas normalizadas
            const coordX = e.touches ? e.touches[0].clientX : e.clientX;
            const coordY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = domPac.getBoundingClientRect();

            // CASO: INICIO DE TOQUE/CLICK
            if (e.type === 'mousedown' || e.type === 'touchstart') {
                const destino = e.target;
                
                // Si toca una zona de rotación (extremos de la barra)
                if (destino.dataset.tipo === 'rotate') {
                    SESION.tipoDeDrag = 'rotate';
                } 
                // Si toca el cuerpo de la barra
                else if (destino === domPac) {
                    SESION.tipoDeDrag = 'move';
                }
            } 
            
            // CASO: MOVIMIENTO ACTIVO
            else if ((e.type === 'mousemove' || e.type === 'touchmove') && SESION.tipoDeDrag) {
                if (SESION.tipoDeDrag === 'move') {
                    // Actualización de posición lateral (X)
                    const porcentajeX = (coordX / window.innerWidth) * 100;
                    SESION.paciente.x = Math.min(Math.max(porcentajeX, 5), 95);
                } 
                else if (SESION.tipoDeDrag === 'rotate') {
                    // Lógica de Palanca: Rotación basada en distancia X desde el centro
                    const centroBarraX = rect.left + rect.width / 2;
                    const deltaX = coordX - centroBarraX;
                    SESION.paciente.a += deltaX * 0.15; // Sensibilidad calibrada
                }
                
                actualizarVisuales();
                
                // Evitar que el navegador intente hacer scroll o zoom
                if (e.cancelable) e.preventDefault();
            }
        }

        // Event Listeners Globales para robustez
        window.addEventListener('mousedown', manejarInput);
        window.addEventListener('touchstart', manejarInput, {passive: false});
        window.addEventListener('mousemove', manejarInput);
        window.addEventListener('touchmove', manejarInput, {passive: false});
        window.addEventListener('mouseup', () => SESION.tipoDeDrag = null);
        window.addEventListener('touchend', () => SESION.tipoDeDrag = null);

        /* FUNCIONES DE AJUSTE DE PRECISIÓN (BOTONES)
           -----------------------------------------
        */
        function nudge(eje, cantidad) {
            if (!SESION.estaActivo) return;
            
            SESION.paciente[eje] += cantidad;
            actualizarVisuales();
            
            // Repetir el movimiento mientras se mantenga presionado
            clearInterval(SESION.idIntervaloNudge);
            SESION.idIntervaloNudge = setInterval(() => {
                SESION.paciente[eje] += cantidad;
                actualizarVisuales();
            }, 50);
        }

        function stopNudge() {
            clearInterval(SESION.idIntervaloNudge);
        }

        // Rueda del ratón para rotación de alta resolución
        window.addEventListener('wheel', (e) => {
            if (!SESION.estaActivo) return;
            SESION.paciente.a += e.deltaY > 0 ? 2.5 : -2.5;
            actualizarVisuales();
        });

        /* FLUJO DE SESIÓN Y GESTIÓN DE NIVELES
           ------------------------------------
        */
        function configurarModo(modo) {
            SESION.modoSeleccionado = modo;
            document.getElementById('btn-libre').classList.toggle('activa', modo === 'libre');
            document.getElementById('btn-tiempo').classList.toggle('activa', modo === 'tiempo');
            
            // Mostrar/Ocultar selector de tiempo con animación de opacidad
            const wrap = document.getElementById('wrapper-tiempo');
            if (modo === 'tiempo') {
                wrap.style.opacity = "1";
                wrap.style.pointerEvents = "auto";
            } else {
                wrap.style.opacity = "0.2";
                wrap.style.pointerEvents = "none";
            }
        }

        function iniciarSoftware() {
            // Capturar tiempo del selector
            SESION.tiempoLimite = parseInt(document.getElementById('select-tiempo').value);
            
            // Transición de pantallas
            document.getElementById('pantalla-inicio').style.display = 'none';
            document.getElementById('escenario-clinico').style.display = 'block';
            document.getElementById('interfaz-hud').style.display = 'block';
            
            // Ocultar barra de crono si es modo libre
            if (SESION.modoSeleccionado === 'libre') {
                document.getElementById('crono-container').style.display = 'none';
            }

            prepararMision();
        }

        function prepararMision() {
            SESION.estaActivo = true;
            SESION.tiempoRestante = SESION.tiempoLimite;
            
            // Generar posición aleatoria del objetivo (Área central)
            SESION.objetivo.x = 35 + (Math.random() * 30);
            SESION.objetivo.y = 22 + (Math.random() * 12);
            
            // Progresión angular según nivel
            if (SESION.nivel >= 5) {
                SESION.objetivo.a = Math.floor(Math.random() * 180);
            } else if (SESION.nivel >= 2) {
                SESION.objetivo.a = Math.random() > 0.5 ? 90 : 0;
            } else {
                SESION.objetivo.a = 0;
            }

            // Posición inicial del paciente (Desplazado a la derecha)
            SESION.paciente.x = SESION.objetivo.x + 22;
            SESION.paciente.a = 0;

            actualizarVisuales();
            
            if (SESION.modoSeleccionado === 'tiempo') {
                iniciarContrareloj();
            }
        }

        function actualizarVisuales() {
            // Actualizar Barra Fija
            domObj.style.left = SESION.objetivo.x + "%";
            domObj.style.top = SESION.objetivo.y + "%";
            domObj.style.transform = `translate(-50%, -50%) rotate(${SESION.objetivo.a}deg)`;

            // Actualizar Barra del Paciente
            domPac.style.left = SESION.paciente.x + "%";
            domPac.style.top = SESION.paciente.y + "%";
            domPac.style.transform = `translate(-50%, -50%) rotate(${SESION.paciente.a}deg)`;
        }

        function iniciarContrareloj() {
            clearInterval(SESION.idIntervaloCrono);
            const barra = document.getElementById('crono-bar');
            
            SESION.idIntervaloCrono = setInterval(() => {
                SESION.tiempoRestante -= 0.1;
                const porcentajeBarra = (SESION.tiempoRestante / SESION.tiempoLimite) * 100;
                barra.style.width = porcentajeBarra + "%";
                
                if (SESION.tiempoRestante <= 0) {
                    evaluarPrecision();
                }
            }, 100);
        }

        /* ALGORITMO DE EVALUACIÓN CLÍNICA
           -------------------------------
        */
        function evaluarPrecision() {
            if (!SESION.estaActivo) return;
            SESION.estaActivo = false;
            clearInterval(SESION.idIntervaloCrono);

            // 1. Error de traslación (Eje X)
            const errorX = Math.abs(SESION.objetivo.x - SESION.paciente.x);
            
            // 2. Error angular (Eje A) normalizado
            let errorA = Math.abs((SESION.objetivo.a % 180) - (SESION.paciente.a % 180));
            if (errorA > 90) errorA = 180 - errorA;

            // 3. Cálculo de Puntuación (Penalización Vernier)
            // Penalizamos el error lateral x12 y el angular x3.5
            const puntuacion = Math.max(0, 100 - (errorX * 12 + errorA * 3.5));
            const exito = puntuacion >= 90;

            if (!exito) {
                SESION.vidas--;
            }

            lanzarModalResultados(exito, puntuacion, errorX, errorA);
        }

        function lanzarModalResultados(esExito, pts, ex, ea) {
            const overlay = document.getElementById('pantalla-resultados');
            overlay.style.display = 'flex';
            
            const titulo = document.getElementById('res-titulo');
            titulo.innerText = esExito ? "¡MISIÓN LOGRADA!" : "FUERA DE RANGO";
            titulo.style.color = esExito ? "var(--verde-exito)" : "var(--purpura-clinico)";
            
            document.getElementById('res-score').innerText = Math.round(pts) + "%";
            document.getElementById('res-x').innerText = ex.toFixed(2) + " px";
            document.getElementById('res-a').innerText = ea.toFixed(1) + "°";
            document.getElementById('res-lvl').innerText = SESION.nivel;
            document.getElementById('res-hp').innerText = "❤️".repeat(SESION.vidas);

            const btn = document.getElementById('res-boton-accion');
            if (SESION.vidas <= 0) {
                btn.innerText = "FINALIZAR SESIÓN";
            } else {
                btn.innerText = esExito ? "SIGUIENTE NIVEL" : "REINTENTAR NIVEL";
            }
        }

        function flujoSiguienteNivel() {
            document.getElementById('pantalla-resultados').style.display = 'none';
            
            if (SESION.vidas <= 0) {
                alert("Protocolo Clínico Finalizado.\nLos datos están listos para ser guardados.");
                location.reload();
            } else {
                // Si el último resultado fue éxito, subimos nivel
                const tituloEstado = document.getElementById('res-titulo').innerText;
                if (tituloEstado === "¡MISIÓN LOGRADA!") {
                    SESION.nivel++;
                }
                
                // Actualizar HUD
                document.getElementById('txt-mision').innerText = SESION.nivel;
                document.getElementById('txt-vidas').innerText = "❤️".repeat(SESION.vidas);
                
                prepararMision();
            }
        }

    </script>
</body>
</html>
