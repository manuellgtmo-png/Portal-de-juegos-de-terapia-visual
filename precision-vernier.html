<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vernier Precision Pro v15.0 - Clinical Full Suite</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================================================================
           1. ARQUITECTURA DE DISEÑO (ESTILOS GLOBALES)
           ================================================================ */
        :root {
            --color-fondo: #0b101b;
            --color-interfaz: #1c2331;
            --color-purpura-neon: #a855f7;
            --color-purpura-glow: rgba(168, 85, 247, 0.7);
            --color-verde-clinico: #22c55e;
            --color-rojo-urgencia: #f43f5e;
            --color-texto-principal: #ffffff;
            --color-texto-muted: #94a3b8;
            --fuente-base: 'Montserrat', sans-serif;
        }

        /* Bloqueo absoluto de comportamientos del navegador para evitar errores en el test */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--color-fondo);
            color: var(--color-texto-principal);
            font-family: var(--fuente-base);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: fixed;
        }

        /* ================================================================
           2. COMPONENTES DE INTERFAZ DE USUARIO (UI)
           ================================================================ */
        .capa-modal {
            position: fixed;
            inset: 0;
            background: var(--color-fondo);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 30px;
        }

        .contenedor-configuracion {
            background: var(--color-interfaz);
            width: 100%;
            max-width: 650px;
            padding: 60px;
            border-radius: 50px;
            text-align: center;
            box-shadow: 0 40px 120px rgba(0,0,0,0.9);
            border: 2px solid rgba(255,255,255,0.05);
        }

        /* SELECTORES DE MODO Y TIEMPO */
        .grid-modos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 40px 0;
        }

        .boton-modo {
            background: rgba(0,0,0,0.2);
            padding: 30px 15px;
            border-radius: 25px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .boton-modo.activo {
            border-color: var(--color-purpura-neon);
            background: rgba(168, 85, 247, 0.1);
            box-shadow: 0 0 25px var(--color-purpura-glow);
        }

        .fila-ajuste-tiempo {
            background: rgba(0,0,0,0.3);
            padding: 25px 35px;
            border-radius: 30px;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .select-personalizado {
            background: var(--color-fondo);
            color: white;
            border: 2px solid var(--color-purpura-neon);
            padding: 12px 25px;
            border-radius: 15px;
            font-family: inherit;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            outline: none;
        }

        /* BARRA DE TIEMPO (HUD) */
        #contenedor-cronometro-hud {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 450px;
            height: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 30px;
            border: 4px solid var(--color-interfaz);
            overflow: hidden;
            display: none;
            z-index: 1000;
        }

        #barra-progreso-tiempo {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--color-rojo-urgencia), #ff8fa3);
            box-shadow: 0 0 20px var(--color-rojo-urgencia);
            transition: width 0.1s linear;
        }

        /* ================================================================
           3. ESCENARIO CLÍNICO Y LÍNEAS DE TEST
           ================================================================ */
        #escenario-juego {
            flex: 1;
            position: relative;
            width: 100%;
            display: none;
            background: radial-gradient(circle at center, #161d2b 0%, #0b101b 100%);
        }

        .linea-evaluacion {
            position: absolute;
            width: 18px;
            height: 210px;
            border-radius: 50px;
            transform-origin: center center;
            will-change: transform, left, top;
        }

        #linea-referencia-fija {
            background-color: #334155;
            opacity: 0.4;
            z-index: 5;
        }

        #linea-paciente-movil {
            background-color: var(--color-purpura-neon);
            box-shadow: 0 0 50px var(--color-purpura-glow);
            z-index: 100;
            cursor: grab;
        }

        /* ZONAS DE GIRO (MOUSE & TOUCH) */
        .zona-interaccion-giro {
            position: absolute;
            width: 100%;
            height: 35%; /* Tercio superior e inferior para rotación */
            left: 0;
            z-index: 200;
            cursor: pointer;
        }
        .punta-superior { top: 0; }
        .punta-inferior { bottom: 0; }

        /* ================================================================
           4. HUD Y PANELES DE CONTROL
           ================================================================ */
        .widget-info-hud {
            position: absolute;
            top: 35px;
            background: var(--color-interfaz);
            padding: 25px 35px;
            border-radius: 35px;
            z-index: 1000;
            box-shadow: 0 20px 45px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .hud-mision { left: 40px; }
        .hud-integridad { right: 40px; }

        .etiqueta-hud {
            display: block;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--color-texto-muted);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 8px;
        }

        .valor-hud {
            font-size: 2.2rem;
            font-weight: 900;
        }

        #panel-botones-precision {
            position: absolute;
            right: 40px;
            top: 55%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 25px;
            z-index: 1000;
        }

        .boton-nudge {
            width: 85px;
            height: 85px;
            background: rgba(28, 35, 49, 0.98);
            border: 3px solid var(--color-purpura-neon);
            border-radius: 25px;
            color: white;
            font-size: 2.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .boton-nudge:active {
            transform: scale(0.85);
            background: var(--color-purpura-neon);
        }

        .boton-validar-test {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 600px;
            padding: 35px;
            background: var(--color-verde-clinico);
            color: #062d16;
            border-radius: 50px;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            box-shadow: 0 12px 0 #15803d;
            z-index: 1000;
        }

    </style>
</head>
<body>

    <div id="pantalla-inicio" class="capa-modal">
        <div class="contenedor-configuracion">
            <h1 style="color:var(--color-purpura-neon); font-size: 4rem; font-weight: 900; margin-bottom: 10px; letter-spacing: -2px;">VERNIE PRO</h1>
            <p style="color:var(--color-texto-muted); font-weight: 700; font-size: 1.1rem; letter-spacing: 3px;">SUITE DE EVALUACIÓN CLÍNICA</p>
            
            <div class="grid-modos">
                <div id="opcion-practica" class="boton-modo" onclick="cambiarConfigModo('libre')">
                    <h2 style="font-size: 1.2rem; font-weight: 900; color: var(--color-purpura-neon);">PRACTICA</h2>
                    <p style="font-size: 0.8rem; color: var(--color-texto-muted); margin-top: 10px;">Entrenamiento sin presión temporal.</p>
                </div>
                <div id="opcion-test" class="boton-modo activo" onclick="cambiarConfigModo('tiempo')">
                    <h2 style="font-size: 1.2rem; font-weight: 900; color: var(--color-purpura-neon);">CONTRARELOJ</h2>
                    <p style="font-size: 0.8rem; color: var(--color-texto-muted); margin-top: 10px;">Protocolo con límite de tiempo.</p>
                </div>
            </div>

            <div id="seccion-tiempo-config" class="fila-ajuste-tiempo">
                <span style="font-weight: 800; font-size: 1.1rem;">SEGUNDOS POR MISIÓN:</span>
                <select id="select-tiempo-mision" class="select-personalizado">
                    <option value="5">5 seg</option>
                    <option value="10" selected>10 seg</option>
                    <option value="15">15 seg</option>
                    <option value="30">30 seg</option>
                    <option value="60">60 seg</option>
                </select>
            </div>

            <button class="boton-validar-test" style="position:relative; bottom:0; width:100%; box-shadow:none; left:0; transform:none;" onclick="iniciarEjercicioClinico()"> COMENZAR TEST</button>
        </div>
    </div>

    <div id="pantalla-feedback" class="capa-modal" style="display:none;">
        <div class="contenedor-configuracion" style="border-top: 10px solid var(--color-purpura-neon);">
            <h2 id="feedback-titulo" style="font-size: 2.5rem; font-weight: 900;">RESULTADO</h2>
            <div id="feedback-porcentaje" style="font-size: 8rem; font-weight: 900; line-height: 1; margin: 30px 0;">0%</div>
            
            <div id="feedback-detalles" style="text-align:left; background:rgba(0,0,0,0.3); padding:35px; border-radius:30px; margin-bottom:40px; font-size:1.1rem; line-height:2;">
                </div>
            
            <button id="boton-accion-feedback" class="boton-validar-test" style="position:relative; bottom:0; width:100%; left:0; transform:none;" onclick="avanzarFlujoTerapia()">SIGUIENTE PASO</button>
        </div>
    </div>

    <div id="interfaz-hud" style="display:none;">
        <div class="widget-info-hud hud-mision">
            <span class="etiqueta-hud">Misión</span>
            <span id="valor-hud-mision" class="valor-hud">1</span>
        </div>

        <div id="contenedor-cronometro-hud">
            <div id="barra-progreso-tiempo"></div>
        </div>

        <div class="widget-info-hud hud-integridad">
            <span class="etiqueta-hud">Integridad</span>
            <span id="valor-hud-vidas" class="valor-hud">❤️❤️❤️</span>
        </div>

        <div id="panel-botones-precision">
            <button class="boton-nudge" onmousedown="nudgeEjecutar('a', -2)" onmouseup="nudgeDetener()" ontouchstart="nudgeEjecutar('a', -2)" ontouchend="nudgeDetener()">↻</button>
            <button class="boton-nudge" onmousedown="nudgeEjecutar('a', 2)" onmouseup="nudgeDetener()" ontouchstart="nudgeEjecutar('a', 2)" ontouchend="nudgeDetener()">↺</button>
            <button class="boton-nudge" onmousedown="nudgeEjecutar('x', -0.5)" onmouseup="nudgeDetener()" ontouchstart="nudgeEjecutar('x', -0.5)" ontouchend="nudgeDetener()">←</button>
            <button class="boton-nudge" onmousedown="nudgeEjecutar('x', 0.5)" onmouseup="nudgeDetener()" ontouchstart="nudgeEjecutar('x', 0.5)" ontouchend="nudgeDetener()">→</button>
        </div>

        <button class="boton-validar-test" onclick="evaluarPrecisionClinica()">CONFIRMAR ALINEACIÓN</button>
    </div>

    <div id="escenario-juego">
        <div id="linea-referencia-fija" class="linea-evaluacion"></div>
        <div id="linea-paciente-movil" class="linea-evaluacion">
            <div class="zona-interaccion-giro punta-superior" data-accion="girar"></div>
            <div class="zona-interaccion-giro punta-inferior" data-accion="girar"></div>
        </div>
    </div>

    <script>
        /**
         * ================================================================
         * MOTOR LÓGICO DE VERNIE PRO (PRECISIÓN AUMENTADA)
         * ================================================================
         */

        const SISTEMA = {
            nivel: 1,
            vidas: 3,
            activo: false,
            modo: 'tiempo',
            segundosConfig: 10,
            segundosReloj: 10,
            intervaloReloj: null,
            intervaloNudge: null,
            
            // Datos de posicionamiento
            referencia: { x: 50, y: 30, angulo: 0 },
            paciente: { x: 75, y: 65, angulo: 0 },
            
            // Captura de mouse/touch
            arrastre: { activo: false, modo: null, inicioX: 0 }
        };

        const barPac = document.getElementById('linea-paciente-movil');
        const barRef = document.getElementById('linea-referencia-fija');

        /* 1. MOTOR DE INTERACCIÓN HÍBRIDO (MOUSE Y TÁCTIL)
           ------------------------------------------------ */
        function procesarInputEntrada(e) {
            if (!SISTEMA.activo) return;

            const xActual = e.touches ? e.touches[0].clientX : e.clientX;
            const target = e.target;

            // DETECCIÓN DE INICIO DE CONTACTO
            if (e.type === 'mousedown' || e.type === 'touchstart') {
                if (target.dataset.accion === 'girar') {
                    SISTEMA.arrastre.modo = 'rotar';
                } else if (target === barPac) {
                    SISTEMA.arrastre.modo = 'mover';
                }
                
                if (SISTEMA.arrastre.modo) {
                    SISTEMA.arrastre.activo = true;
                    SISTEMA.arrastre.inicioX = xActual;
                    if (e.type === 'mousedown') e.preventDefault();
                }
            } 
            
            // MOVIMIENTO DINÁMICO (GIRO Y TRASLACIÓN)
            else if ((e.type === 'mousemove' || e.type === 'touchmove') && SISTEMA.arrastre.activo) {
                const deltaX = xActual - SISTEMA.arrastre.inicioX;

                if (SISTEMA.arrastre.modo === 'mover') {
                    const posPct = (xActual / window.innerWidth) * 100;
                    SISTEMA.paciente.x = Math.max(10, Math.min(90, posPct));
                } 
                else if (SISTEMA.arrastre.modo === 'rotar') {
                    // GIRO DIRECTO: Movimiento horizontal en las puntas genera rotación
                    SISTEMA.paciente.angulo += deltaX * 0.5; 
                }
                
                SISTEMA.arrastre.inicioX = xActual;
                renderizarObjetos();
                
                if (e.cancelable) e.preventDefault();
            }
        }

        // Suscripción a eventos globales
        window.addEventListener('mousedown', procesarInputEntrada);
        window.addEventListener('touchstart', procesarInputEntrada, {passive: false});
        window.addEventListener('mousemove', procesarInputEntrada);
        window.addEventListener('touchmove', procesarInputEntrada, {passive: false});
        window.addEventListener('mouseup', () => SISTEMA.arrastre.activo = false);
        window.addEventListener('touchend', () => SISTEMA.arrastre.activo = false);

        /* 2. GESTIÓN DE SESIÓN Y MODOS
           ------------------------------------------------ */
        function cambiarConfigModo(m) {
            SISTEMA.modo = m;
            document.getElementById('opcion-practica').classList.toggle('activo', m === 'libre');
            document.getElementById('opcion-test').classList.toggle('activo', m === 'tiempo');
            
            const seccionTiempo = document.getElementById('seccion-tiempo-config');
            seccionTiempo.style.opacity = (m === 'tiempo') ? "1" : "0.2";
            seccionTiempo.style.pointerEvents = (m === 'tiempo') ? "auto" : "none";
        }

        function iniciarEjercicioClinico() {
            SISTEMA.segundosConfig = parseInt(document.getElementById('select-tiempo-mision').value);
            
            document.getElementById('pantalla-inicio').style.display = 'none';
            document.getElementById('escenario-juego').style.display = 'block';
            document.getElementById('interfaz-hud').style.display = 'block';
            
            if (SISTEMA.modo === 'tiempo') {
                document.getElementById('contenedor-cronometro-hud').style.display = 'block';
            }

            prepararNuevaMision();
        }

        function prepararNuevaMision() {
            SISTEMA.activo = true;
            SISTEMA.segundosReloj = SISTEMA.segundosConfig;
            
            // Generar Referencia Aleatoria
            SISTEMA.referencia.x = 35 + (Math.random() * 30);
            
            // Inclinación según nivel de dificultad
            if (SISTEMA.nivel >= 5) {
                SISTEMA.referencia.angulo = Math.floor(Math.random() * 180 - 90);
            } else if (SISTEMA.nivel >= 2) {
                SISTEMA.referencia.angulo = (Math.random() > 0.5) ? 90 : 0;
            } else {
                SISTEMA.referencia.angulo = 0;
            }

            // Posición inicial del paciente con error inducido
            SISTEMA.paciente.x = SISTEMA.referencia.x + (Math.random() > 0.5 ? 20 : -20);
            SISTEMA.paciente.angulo = 0;

            renderizarObjetos();
            if (SISTEMA.modo === 'tiempo') activarCronometroHud();
        }

        /* 3. MOTOR DEL CRONÓMETRO (CONTRARELOJ)
           ------------------------------------------------ */
        function activarCronometroHud() {
            clearInterval(SISTEMA.intervaloReloj);
            const barra = document.getElementById('barra-progreso-tiempo');
            
            SISTEMA.intervaloReloj = setInterval(() => {
                SISTEMA.segundosReloj -= 0.1;
                const pctCrono = (SISTEMA.segundosReloj / SISTEMA.segundosConfig) * 100;
                barra.style.width = pctCrono + "%";
                
                if (SISTEMA.segundosReloj <= 0) {
                    evaluarPrecisionClinica();
                }
            }, 100);
        }

        function renderizarObjetos() {
            // Aplicar transformaciones CSS a la Referencia
            barRef.style.left = SISTEMA.referencia.x + "%";
            barRef.style.top = SISTEMA.referencia.y + "%";
            barRef.style.transform = `translate(-50%, -50%) rotate(${SISTEMA.referencia.angulo}deg)`;

            // Aplicar transformaciones CSS al Paciente
            barPac.style.left = SISTEMA.paciente.x + "%";
            barPac.style.top = SISTEMA.paciente.y + "%";
            barPac.style.transform = `translate(-50%, -50%) rotate(${SISTEMA.paciente.angulo}deg)`;
        }

        /* 4. EVALUACIÓN Y RESULTADOS CLÍNICOS
           ------------------------------------------------ */
        function evaluarPrecisionClinica() {
            if (!SISTEMA.activo) return;
            SISTEMA.activo = false;
            clearInterval(SISTEMA.intervaloReloj);

            // Cálculos de desviación
            const errorX = Math.abs(SISTEMA.referencia.x - SISTEMA.paciente.x);
            let errorA = Math.abs((SISTEMA.referencia.angulo % 180) - (SISTEMA.paciente.angulo % 180));
            if (errorA > 90) errorA = 180 - errorA;

            // Score Final: Vernier penaliza fuerte el error lateral
            const scoreFinal = Math.max(0, Math.round(100 - (errorX * 11.5 + errorA * 2.8)));
            const pasoMision = scoreFinal >= 90;

            if (!pasoMision) {
                SISTEMA.vidas--;
            }

            mostrarPantallaFeedback(pasoMision, scoreFinal, errorX, errorA);
        }

        function mostrarPantallaFeedback(exito, pts, dx, da) {
            document.getElementById('pantalla-feedback').style.display = 'flex';
            
            const titulo = document.getElementById('feedback-titulo');
            titulo.innerText = exito ? "¡MISIÓN COMPLETADA!" : "DESVIACIÓN FUERA DE RANGO";
            titulo.style.color = exito ? "var(--color-verde-clinico)" : "var(--color-purpura-neon)";
            
            document.getElementById('feedback-porcentaje').innerText = pts + "%";
            document.getElementById('feedback-detalles').innerHTML = `
                Precisión de Alineación: <span style="float:right"><b>${pts}%</b></span><br>
                Desviación Lateral: <span style="float:right"><b>${dx.toFixed(2)} px</b></span><br>
                Error de Rotación: <span style="float:right"><b>${da.toFixed(1)}°</b></span><br>
                Estado de Integridad: <span style="float:right"><b>${"❤️".repeat(SISTEMA.vidas)}</b></span>
            `;

            const btn = document.getElementById('boton-accion-feedback');
            if (SISTEMA.vidas <= 0) {
                btn.innerText = "REINICIAR PROTOCOLO";
            } else {
                btn.innerText = exito ? "SIGUIENTE MISIÓN" : "REINTENTAR NIVEL";
            }
        }

        function avanzarFlujoTerapia() {
            document.getElementById('pantalla-feedback').style.display = 'none';
            
            if (SISTEMA.vidas <= 0) {
                location.reload();
            } else {
                const tituloAct = document.getElementById('feedback-titulo').innerText;
                if (tituloAct === "¡MISIÓN COMPLETADA!") {
                    SISTEMA.nivel++;
                }
                
                document.getElementById('valor-hud-mision').innerText = SISTEMA.nivel;
                document.getElementById('valor-hud-vidas').innerText = "❤️".repeat(SISTEMA.vidas);
                prepararNuevaMision();
            }
        }

        /* 5. AJUSTES DE PRECISIÓN POR BOTONES
           ------------------------------------------------ */
        function nudgeEjecutar(eje, val) {
            if (!SISTEMA.activo) return;
            
            SISTEMA.paciente[eje] += val;
            renderizarObjetos();
            
            SISTEMA.intervaloNudge = setInterval(() => {
                SISTEMA.paciente[eje] += val;
                renderizarObjetos();
            }, 50);
        }

        function nudgeDetener() {
            clearInterval(SISTEMA.intervaloNudge);
        }

        /* BLOQUEADOR DE ZOOM DE RUEDA DE RATÓN */
        window.addEventListener('wheel', (e) => {
            if (e.ctrlKey) e.preventDefault();
        }, { passive: false });

    </script>
</body>
</html>
