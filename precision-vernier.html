<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precisi√≥n Vernier PRO - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --vernier-purple: #8b5cf6; 
            --vernier-dark: #6d28d9;
            --green-success: #22c55e;
            --green-dark: #16a34a;
            --slate: #1e293b;
            --danger: #ef4444;
        }

        body { 
            margin: 0; background: #ffffff; color: var(--slate); 
            font-family: 'Montserrat', sans-serif; overflow: hidden; touch-action: none;
            width: 100vw; height: 100vh;
        }

        /* --- INTERFAZ HUD --- */
        #ui-layer { 
            position: absolute; top: 0; width: 100%; padding: 15px; 
            display: none; justify-content: space-between; box-sizing: border-box; 
            z-index: 100; pointer-events: none;
        }
        .stat-box { 
            background: white; padding: 10px 15px; border-radius: 18px; 
            font-weight: 900; border: 2px solid #f1f5f9; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; min-width: 80px; 
        }
        .label { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; }

        #patient-tag {
            position: absolute; top: 95px; left: 15px; font-size: 0.8rem;
            background: var(--vernier-purple); color: white; padding: 8px 15px; border-radius: 12px; font-weight: bold;
        }

        /* --- √ÅREA DE JUEGO --- */
        #game-area { width: 100vw; height: 100vh; position: relative; background: white; overflow: hidden; }
        
        .line { 
            position: absolute; background: var(--slate); border-radius: 10px; 
            touch-action: none;
        }
        .v-line { width: 6px; height: 160px; }
        .h-line { width: 160px; height: 6px; }

        #mobile-line { background: var(--vernier-purple); cursor: grab; z-index: 50; }
        #mobile-line:active { cursor: grabbing; scale: 1.05; }

        /* --- CRON√ìMETRO BARRA --- */
        #timer-container { 
            position: absolute; top: 25px; left: 50%; transform: translateX(-50%); 
            width: 250px; height: 12px; background: #f1f5f9; border-radius: 10px; overflow: hidden;
            display: none; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #timer-fill { width: 100%; height: 100%; background: var(--danger); transition: width 0.1s linear; }

        /* --- OVERLAYS Y CARDS --- */
        .overlay { 
            position: fixed; inset: 0; background: rgba(248, 250, 252, 0.98); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 25px; text-align: center; z-index: 200; 
        }
        .card { 
            background: white; padding: 40px; border-radius: 40px; 
            width: 85%; max-width: 550px; box-shadow: 0 25px 60px rgba(0,0,0,0.1); border: 2px solid #f1f5f9;
        }

        .mode-option {
            background: #f8fafc; border: 2px solid #e2e8f0; padding: 20px;
            border-radius: 25px; margin-bottom: 15px; cursor: pointer; transition: 0.2s;
            text-align: left; position: relative;
        }
        .mode-option:hover { border-color: var(--vernier-purple); background: #f5f3ff; }
        .mode-option h3 { margin: 0; color: var(--vernier-purple); text-transform: uppercase; font-size: 1rem; }
        .mode-option p { margin: 5px 0 0; font-size: 0.85rem; color: #64748b; }

        button.primary-btn { 
            background: var(--green-success); color: white; border: none; padding: 22px; 
            border-radius: 50px; font-size: 1.3rem; cursor: pointer; font-weight: 900; 
            text-transform: uppercase; box-shadow: 0 8px 0 var(--green-dark); transition: all 0.1s; width: 100%; 
        }
        button.primary-btn:active { transform: translateY(4px); box-shadow: 0 4px 0 var(--green-dark); }

        #confirm-btn { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 400px; z-index: 100;
        }

        /* --- ANIMACIONES --- */
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .critical-time { animation: blink 0.3s infinite; }
    </style>
</head>
<body>

    <div id="intro-screen" class="overlay">
        <div class="card">
            <h1 style="color: var(--vernier-purple); font-weight: 900;">MISI√ìN VERNIER PRO</h1>
            <p>Selecciona tu modo de entrenamiento visual:</p>
            
            <div class="mode-option" onclick="prepararModo('entrenamiento')">
                <h3>‚è±Ô∏è Modo Cronometrado</h3>
                <p>T√≥mate tu tiempo para alinear con precisi√≥n m√°xima. Registraremos cu√°nto tardas en lograrlo.</p>
            </div>

            <div class="mode-option" onclick="prepararModo('contrareloj')">
                <h3>üî• Modo Contrareloj</h3>
                <p>¬°Rapidez extrema! Alinea antes de que la barra de tiempo llegue a cero. Cada nivel es m√°s corto.</p>
            </div>
        </div>
    </div>

    <div id="instruction-screen" class="overlay" style="display: none;">
        <div class="card">
            <h2 id="inst-title" style="color: var(--vernier-purple)"></h2>
            <div id="inst-body" style="background: #f1f5f9; padding: 20px; border-radius: 20px; margin: 20px 0; font-size: 0.9rem; line-height: 1.5;"></div>
            <button class="primary-btn" onclick="iniciarJuego()">¬°ENTENDIDO, EMPEZAR!</button>
        </div>
    </div>

    <div id="level-screen" class="overlay" style="display: none;">
        <div class="card">
            <h2 style="color: var(--green-success)">¬°OBJETIVO ALINEADO!</h2>
            <div style="margin: 25px 0; background: #f8fafc; padding: 25px; border-radius: 25px; text-align: center;">
                <p style="margin: 5px 0;">Precisi√≥n Lograda</p>
                <div id="res-precision" style="font-size: 3rem; font-weight: 900; color: var(--vernier-purple);">0%</div>
                <p style="margin: 15px 0 5px;">Tiempo de Resoluci√≥n: <strong id="res-tiempo">0s</strong></p>
            </div>
            <button class="primary-btn" onclick="proximoReto()">SIGUIENTE NIVEL</button>
        </div>
    </div>

    <div id="ui-layer">
        <div class="stat-box"><span class="label">Nivel</span><span id="txt-nivel">1</span></div>
        <div class="stat-box"><span class="label">Vidas</span><span id="txt-vidas">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
        <div id="patient-tag">Paciente: <span id="txt-paciente">---</span></div>
    </div>

    <div id="game-area">
        <div id="timer-container"><div id="timer-fill"></div></div>
        <div id="fixed-line" class="line"></div>
        <div id="mobile-line" class="line"></div>
        <button id="confirm-btn" class="primary-btn" style="display:none;" onclick="validar()">CONFIRMAR ALINEACI√ìN</button>
    </div>

    <script>
        // --- CONSTANTES Y SONIDOS ---
        const audioClick = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'); 
        const audioError = new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'); 
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const ENTRIES = { paciente: "entry.369874016", juego: "entry.1353470174", nivel: "entry.721051298", aciertos: "entry.873272199", fallos: "entry.1030094511", fecha: "entry.845098414" };

        // --- ESTADO DEL JUEGO ---
        let modoSeleccionado = '';
        let nivel = 1, vidas = 3, fallosTotales = 0, aciertosTotales = 0;
        let posActual = { x: 50, y: 70 }, esVertical = true, juegoActivo = false;
        let tiempoNivel = 0, timerInterval, contrarelojRestante = 10;

        // --- MANEJO DE INICIO Y MODOS ---
        function prepararModo(modo) {
            modoSeleccionado = modo;
            document.getElementById('intro-screen').style.display = 'none';
            const instScreen = document.getElementById('instruction-screen');
            const title = document.getElementById('inst-title');
            const body = document.getElementById('inst-body');

            if(modo === 'entrenamiento') {
                title.innerText = "Modo Cronometrado";
                body.innerHTML = "‚Ä¢ No hay prisa, busca la perfecci√≥n.<br>‚Ä¢ El reloj contar√° cu√°nto tardas en decidir.<br>‚Ä¢ Arrastra la barra morada con el dedo.<br>‚Ä¢ Presiona CONFIRMAR cuando creas que est√°n alineadas.";
            } else {
                title.innerText = "Modo Contrareloj";
                body.innerHTML = "‚Ä¢ ¬°Debes ser r√°pido!<br>‚Ä¢ Tienes una barra de tiempo en la parte superior.<br>‚Ä¢ Si llega a cero, perder√°s una vida.<br>‚Ä¢ La precisi√≥n sigue siendo obligatoria.";
            }
            instScreen.style.display = 'flex';
        }

        function iniciarJuego() {
            document.getElementById('instruction-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            document.getElementById('confirm-btn').style.display = 'block';
            document.getElementById('txt-paciente').innerText = localStorage.getItem('pacienteActual') || "Explorador";
            if(modoSeleccionado === 'contrareloj') document.getElementById('timer-container').style.display = 'block';
            juegoActivo = true;
            generarReto();
        }

        // --- L√ìGICA DE GENERACI√ìN ---
        function generarReto() {
            esVertical = Math.random() > 0.5;
            const fLine = document.getElementById('fixed-line');
            const mLine = document.getElementById('mobile-line');

            if(esVertical) {
                fLine.className = mLine.className = "line v-line";
                fLine.style.left = "50%"; fLine.style.top = "20%";
                posActual = { x: Math.random() > 0.5 ? 20 : 80, y: 60 };
            } else {
                fLine.className = mLine.className = "line h-line";
                fLine.style.top = "40%"; fLine.style.left = "20%";
                posActual = { x: 60, y: Math.random() > 0.5 ? 20 : 80 };
            }
            actualizarPosicionVisual();
            iniciarCronometro();
        }

        // --- CRON√ìMETRO Y TIEMPO ---
        function iniciarCronometro() {
            clearInterval(timerInterval);
            tiempoNivel = 0;
            if(modoSeleccionado === 'contrareloj') {
                let duracion = Math.max(3.5, 12 - nivel); 
                contrarelojRestante = duracion;
                const fill = document.getElementById('timer-fill');
                fill.classList.remove('critical-time');
                
                timerInterval = setInterval(() => {
                    contrarelojRestante -= 0.1;
                    tiempoNivel += 0.1;
                    fill.style.width = (contrarelojRestante / duracion * 100) + "%";
                    if(contrarelojRestante < 3) fill.classList.add('critical-time');
                    if(contrarelojRestante <= 0) {
                        clearInterval(timerInterval);
                        registrarError("¬°TIEMPO AGOTADO!");
                    }
                }, 100);
            } else {
                timerInterval = setInterval(() => { tiempoNivel += 0.1; }, 100);
            }
        }

        // --- SISTEMA DE ARRASTRE (DRAG) ---
        let isDragging = false;
        const mLine = document.getElementById('mobile-line');

        const startDragging = () => { if(juegoActivo) isDragging = true; };
        const whileDragging = (e) => {
            if(!isDragging || !juegoActivo) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;

            if(esVertical) {
                posActual.x = (x / window.innerWidth) * 100;
            } else {
                posActual.y = (y / window.innerHeight) * 100;
            }
            actualizarPosicionVisual();
        };
        const stopDragging = () => { isDragging = false; };

        mLine.addEventListener('mousedown', startDragging);
        mLine.addEventListener('touchstart', startDragging);
        window.addEventListener('mousemove', whileDragging);
        window.addEventListener('touchmove', whileDragging);
        window.addEventListener('mouseup', stopDragging);
        window.addEventListener('touchend', stopDragging);

        function actualizarPosicionVisual() {
            mLine.style.left = posActual.x + "%";
            mLine.style.top = posActual.y + "%";
        }

        // --- VALIDACI√ìN Y RESULTADOS ---
        function validar() {
            if(!juegoActivo) return;
            clearInterval(timerInterval);

            let distError = esVertical ? Math.abs(50 - posActual.x) : Math.abs(40 - posActual.y);
            let margenTolerancia = Math.max(0.1, 1.8 - (nivel * 0.22));

            if(distError <= margenTolerancia) {
                audioClick.play();
                aciertosTotales++;
                mostrarResumen(distError);
            } else {
                registrarError("DESALINEADO");
            }
        }

        function registrarError(msg) {
            audioError.play();
            vidas--; fallosTotales++;
            document.getElementById('txt-vidas').innerText = "‚ù§Ô∏è".repeat(Math.max(0, vidas));
            if(vidas <= 0) {
                finalizarSesion();
            } else {
                alert(msg);
                juegoActivo = true;
                generarReto();
            }
        }

        function mostrarResumen(error) {
            juegoActivo = false;
            let perc = (100 - (error * 6)).toFixed(1);
            if(perc > 100) perc = 100;
            document.getElementById('res-precision').innerText = perc + "%";
            document.getElementById('res-tiempo').innerText = tiempoNivel.toFixed(2) + "s";
            document.getElementById('level-screen').style.display = 'flex';
        }

        function proximoReto() {
            nivel++;
            document.getElementById('txt-nivel').innerText = nivel;
            document.getElementById('level-screen').style.display = 'none';
            juegoActivo = true;
            generarReto();
        }

        function finalizarSesion() {
            clearInterval(timerInterval);
            juegoActivo = false;
            
            const data = new FormData();
            data.append(ENTRIES.paciente, localStorage.getItem('pacienteActual') || "An√≥nimo");
            data.append(ENTRIES.juego, "Vernier PRO - " + modoSeleccionado);
            data.append(ENTRIES.nivel, nivel);
            data.append(ENTRIES.aciertos, aciertosTotales);
            data.append(ENTRIES.fallos, fallosTotales);
            data.append(ENTRIES.fecha, new Date().toISOString().split('T')[0]);

            fetch(FORM_URL, { method: 'POST', mode: 'no-cors', body: data });
            
            alert("SESI√ìN FINALIZADA\nNivel: " + nivel + "\nModo: " + modoSeleccionado);
            location.reload();
        }
    </script>
</body>
</html>
