<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vernier Precisi√≥n PRO - Edici√≥n Definitiva</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           CONFIGURACI√ìN DE VARIABLES Y TEMAS
           ========================================= */
        :root {
            --navy-dark: #0f172a;
            --navy-card: #1e293b;
            --vernier-purple: #a855f7;
            --vernier-light: #c084fc;
            --green-neon: #22c55e;
            --green-glow: #4ade80;
            --danger-red: #f43f5e;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --slate-gray: #475569;
            --transition-speed: 0.3s;
        }

        /* =========================================
           RESET Y ESTILOS BASE
           ========================================= */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--navy-dark);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            touch-action: none;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           ANIMACIONES CSS
           ========================================= */
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(168, 85, 247, 0); }
            100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
        }

        @keyframes slide-up {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* =========================================
           INTERFAZ HUD (TOP BAR)
           ========================================= */
        #hud-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 25px;
            display: none; /* Se activa al iniciar */
            justify-content: space-between;
            align-items: flex-start;
            z-index: 100;
            pointer-events: none;
        }

        .hud-item {
            background: var(--navy-card);
            padding: 15px 25px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .hud-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: 1.5px;
            margin-bottom: 5px;
        }

        .hud-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: white;
        }

        /* =========================================
           SISTEMA DE TIEMPO (PROGRESS BAR)
           ========================================= */
        #timer-wrapper {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 14px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            overflow: hidden;
            display: none;
            z-index: 90;
            border: 2px solid var(--navy-dark);
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        #timer-progress {
            width: 100%;
            height: 100%;
            background: var(--danger-red);
            transition: width 0.1s linear;
        }

        /* =========================================
           ELEMENTOS DEL JUEGO (L√çNEAS)
           ========================================= */
        #game-arena {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .vernier-line {
            position: absolute;
            width: 14px;
            height: 180px;
            border-radius: 25px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.4);
            transform-origin: center;
            will-change: transform, top, left;
            z-index: 10;
        }

        #line-fixed {
            background-color: var(--slate-gray);
            opacity: 0.8;
            z-index: 5;
        }

        #line-mobile {
            background-color: var(--vernier-purple);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
            cursor: grab;
            z-index: 20;
        }

        #line-mobile:active {
            cursor: grabbing;
            box-shadow: 0 0 50px rgba(168, 85, 247, 0.8);
            transform: translate(-50%, -50%) scale(1.05);
        }

        /* =========================================
           BOT√ìN DE ACCI√ìN
           ========================================= */
        #btn-verify {
            position: absolute;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: 88%;
            max-width: 500px;
            height: 90px;
            background: var(--green-neon);
            color: var(--navy-dark);
            border: none;
            border-radius: 45px;
            font-size: 1.7rem;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 12px 0 #16a34a;
            z-index: 200;
            cursor: pointer;
            display: none;
            transition: transform 0.1s;
        }

        #btn-verify:active {
            transform: translateX(-50%) translateY(6px);
            box-shadow: 0 6px 0 #16a34a;
        }

        /* =========================================
           MEN√öS, MODALES Y OVERLAYS
           ========================================= */
        .game-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            padding: 25px;
            text-align: center;
        }

        .modal-card {
            background: var(--navy-card);
            padding: 50px;
            border-radius: 50px;
            width: 100%;
            max-width: 600px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
            animation: slide-up 0.5s ease-out;
        }

        .mode-selector {
            background: rgba(255,255,255,0.03);
            border: 2px solid rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 35px;
            margin: 20px 0;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-align: left;
            width: 100%;
        }

        .mode-selector:hover {
            border-color: var(--vernier-purple);
            background: rgba(168, 85, 247, 0.1);
            transform: translateY(-5px);
        }

        .mode-selector h3 {
            margin: 0;
            color: var(--vernier-purple);
            font-size: 1.4rem;
            font-weight: 900;
        }

        .mode-selector p {
            margin: 10px 0 0;
            font-size: 0.95rem;
            color: var(--text-dim);
            line-height: 1.5;
        }

        /* PANTALLA DE √âXITO ESTILO VIDEOJUEGO */
        #victory-screen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--navy-card);
            padding: 60px;
            border-radius: 60px;
            text-align: center;
            z-index: 700;
            transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 5px solid var(--green-neon);
            width: 90%;
            max-width: 550px;
            box-shadow: 0 0 100px rgba(34, 197, 94, 0.3);
        }

        #victory-screen.active {
            transform: translate(-50%, -50%) scale(1);
        }

        .precision-badge {
            margin: 40px 0;
            background: rgba(0,0,0,0.4);
            padding: 40px;
            border-radius: 45px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #precision-value {
            font-size: 5.5rem;
            font-weight: 900;
            color: var(--vernier-purple);
            line-height: 1;
            text-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
        }

        /* TOAST DE ERROR */
        #toast-alert {
            position: fixed;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--danger-red);
            color: white;
            padding: 45px 90px;
            border-radius: 40px;
            font-weight: 900;
            font-size: 2.8rem;
            z-index: 800;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 10px solid white;
            pointer-events: none;
        }
        #toast-alert.active { transform: translate(-50%, -50%) scale(1); }

    </style>
</head>
<body>

    <div id="toast-alert">¬°REINTENTAR!</div>

    <div id="overlay-modes" class="game-overlay">
        <div class="modal-card">
            <h1 style="color:var(--vernier-purple); font-size: 3rem; margin-bottom: 10px; font-weight: 900;">MISI√ìN VERNIER</h1>
            <p style="color: var(--text-dim); margin-bottom: 40px;">Entrenamiento de Hiperagudeza Visual</p>
            
            <div class="mode-selector" onclick="irAConfiguracion('entrenamiento')">
                <h3>‚è±Ô∏è MODO CRONOMETRADO</h3>
                <p>Enfoque en la precisi√≥n absoluta. Medimos cu√°nto tardas en lograr la alineaci√≥n perfecta.</p>
            </div>
            
            <div class="mode-selector" onclick="irAConfiguracion('contrareloj')">
                <h3>üî• MODO CONTRARELOJ</h3>
                <p>Desaf√≠o bajo presi√≥n. Tienes segundos limitados para alinear antes de perder una vida.</p>
            </div>
        </div>
    </div>

    <div id="overlay-setup" class="game-overlay" style="display: none;">
        <div class="modal-card">
            <h2 id="setup-title" style="color: var(--vernier-purple); font-size: 2rem;">INSTRUCCIONES</h2>
            <div id="setup-body" style="margin: 35px 0; line-height: 1.8; text-align: left; color: #cbd5e1; font-size: 1.1rem;"></div>
            
            <div id="time-picker-area" style="display: none;">
                <p style="font-weight: bold; margin-bottom: 10px;">Dificultad (Tiempo inicial):</p>
                <input type="range" id="input-time-slider" min="3" max="15" value="10" 
                       style="width: 100%; margin: 25px 0;" 
                       oninput="document.getElementById('display-time-val').innerText = this.value">
                <div style="font-size: 4rem; font-weight: 900; color: white;"><span id="display-time-val">10</span>s</div>
            </div>

            <button onclick="iniciarPartidaReal()" style="background:var(--green-neon); color:var(--navy-dark); width:100%; border-radius:50px; padding:30px; font-weight:900; border:none; margin-top:30px; cursor:pointer; font-size: 1.6rem; box-shadow: 0 8px 0 #16a34a;">
                ¬°COMENZAR AHORA!
            </button>
        </div>
    </div>

    <div id="victory-screen">
        <h2 style="color:var(--green-neon); font-size: 3rem; margin: 0;">¬°OBJETIVO LOGRADO!</h2>
        <div class="precision-badge">
            <p style="text-transform: uppercase; letter-spacing: 3px; color: var(--text-dim); font-size: 0.9rem; margin-bottom: 15px;">Precisi√≥n de Alineaci√≥n</p>
            <div id="precision-value">100%</div>
        </div>
        <button onclick="cargarSiguienteNivel()" style="background:var(--green-neon); color:var(--navy-dark); width:100%; border-radius:50px; padding:25px; font-weight:900; border:none; cursor:pointer; font-size: 1.5rem;">
            CONTINUAR MISI√ìN
        </button>
    </div>

    <div id="hud-interface">
        <div class="hud-item">
            <span class="hud-label">Nivel</span>
            <span id="val-nivel" class="hud-value">1</span>
        </div>
        
        <div id="timer-wrapper">
            <div id="timer-progress"></div>
        </div>

        <div class="hud-item">
            <span class="hud-label">Vidas</span>
            <span id="val-vidas" class="hud-value">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
        </div>
    </div>

    <div id="game-arena">
        <div id="line-fixed" class="vernier-line"></div>
        <div id="line-mobile" class="vernier-line"></div>
        <button id="btn-verify" onclick="validarAlineacionFinal()">CONFIRMAR ALINEACI√ìN</button>
    </div>

    <script>
        /* =========================================
           SISTEMA DE DATOS Y GOOGLE SHEETS
           ========================================= */
        const FORM_ENDPOINT = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const FORM_MAP = {
            paciente: "entry.369874016",
            juego: "entry.1353470174",
            nivel: "entry.721051298",
            aciertos: "entry.873272199",
            fallos: "entry.1030094511",
            fecha: "entry.845098414"
        };

        /* =========================================
           VARIABLES DE ESTADO GLOBAL
           ========================================= */
        let estado = {
            nivelActual: 1,
            vidasRestantes: 3,
            modoJuego: '', // 'entrenamiento' o 'contrareloj'
            aciertosTotales: 0,
            fallosTotales: 0,
            juegoActivo: false,
            tiempoInicial: 10,
            cronometro: null,
            segundosRestantes: 10
        };

        let posFija = { x: 0, y: 0, angulo: 0 };
        let posMovil = { x: 0, y: 0, angulo: 0 };

        /* =========================================
           FLUJO DE NAVEGACI√ìN
           ========================================= */
        function irAConfiguracion(modoSeleccionado) {
            console.log("Cambiando a modo:", modoSeleccionado);
            estado.modoJuego = modoSeleccionado;
            
            document.getElementById('overlay-modes').style.display = 'none';
            document.getElementById('overlay-setup').style.display = 'flex';
            
            const titulo = document.getElementById('setup-title');
            const cuerpo = document.getElementById('setup-body');
            const areaTiempo = document.getElementById('time-picker-area');

            if(modoSeleccionado === 'entrenamiento') {
                titulo.innerText = "ENTRENAMIENTO LIBRE";
                cuerpo.innerHTML = "‚Ä¢ Tu misi√≥n es alinear la barra <b>morada</b> con la <b>gris</b>.<br>‚Ä¢ El sistema permite un margen de error del <b>10%</b>.<br>‚Ä¢ No hay l√≠mite de tiempo. Prioriza la exactitud visual.<br>‚Ä¢ A partir del nivel 5, las barras podr√°n aparecer en <b>diagonal</b>.";
                areaTiempo.style.display = 'none';
            } else {
                titulo.innerText = "RETO CONTRARELOJ";
                cuerpo.innerHTML = "‚Ä¢ ¬°Misi√≥n Cr√≠tica! Alinea las barras antes de que el tiempo se agote.<br>‚Ä¢ Si el reloj llega a cero, perder√°s una vida.<br>‚Ä¢ El tiempo disponible disminuir√° gradualmente en cada nivel.<br>‚Ä¢ Mant√©n la calma y la precisi√≥n.";
                areaTiempo.style.display = 'block';
            }
        }

        function iniciarPartidaReal() {
            console.log("Iniciando partida...");
            estado.tiempoInicial = parseInt(document.getElementById('input-time-slider').value);
            
            document.getElementById('overlay-setup').style.display = 'none';
            document.getElementById('hud-interface').style.display = 'flex';
            document.getElementById('btn-verify').style.display = 'block';
            
            if(estado.modoJuego === 'contrareloj') {
                document.getElementById('timer-wrapper').style.display = 'block';
            }
            
            estado.juegoActivo = true;
            generarNuevoReto();
        }

        /* =========================================
           GENERACI√ìN DE NIVELES (MATEM√ÅTICAS)
           ========================================= */
        function generarNuevoReto() {
            console.log("Generando nivel:", estado.nivelActual);
            
            // Definici√≥n de Zona Segura (25% a 75% de la pantalla)
            posFija.x = 25 + (Math.random() * 50);
            posFija.y = 20 + (Math.random() * 35); // Solo parte superior media

            // L√≥gica de Rotaci√≥n (Nivel 5 introduce diagonales)
            let semillaAleatoria = Math.random();
            if (estado.nivelActual >= 5 && semillaAleatoria > 0.6) {
                posFija.angulo = 45; // Diagonal
            } else if (semillaAleatoria > 0.3) {
                posFija.angulo = 90; // Vertical
            } else {
                posFija.angulo = 0;  // Horizontal
            }

            // Posicionamiento de la barra del jugador
            posMovil.x = posFija.x > 50 ? 15 : 85; // Aparece en el lado opuesto
            posMovil.y = 65; // Altura est√°ndar de inicio
            posMovil.angulo = posFija.angulo;

            dibujarElementos();
            
            if(estado.modoJuego === 'contrareloj') {
                iniciarCuentaRegresiva();
            }
        }

        function dibujarElementos() {
            const elFijo = document.getElementById('line-fixed');
            const elMovil = document.getElementById('line-mobile');

            elFijo.style.left = posFija.x + "%";
            elFijo.style.top = posFija.y + "%";
            elFijo.style.transform = `translate(-50%, -50%) rotate(${posFija.angulo}deg)`;

            elMovil.style.left = posMovil.x + "%";
            elMovil.style.top = posMovil.y + "%";
            elMovil.style.transform = `translate(-50%, -50%) rotate(${posMovil.angulo}deg)`;
        }

        /* =========================================
           SISTEMA DE ARRASTRE (MOUSE & TOUCH)
           ========================================= */
        let dragEnProgreso = false;
        const targetMovil = document.getElementById('line-mobile');

        // Handlers para Touch
        targetMovil.addEventListener('touchstart', (e) => {
            if(!estado.juegoActivo) return;
            dragEnProgreso = true;
            // No prevenimos default aqu√≠ para permitir scroll si fuera necesario, 
            // pero el body tiene touch-action: none.
        }, { passive: true });

        // Handlers para Mouse
        targetMovil.addEventListener('mousedown', (e) => {
            if(!estado.juegoActivo) return;
            dragEnProgreso = true;
        });

        // Movimiento Unificado
        window.addEventListener('pointermove', (e) => {
            if (!dragEnProgreso || !estado.juegoActivo) return;
            
            let xPct = (e.clientX / window.innerWidth) * 100;
            let yPct = (e.clientY / window.innerHeight) * 100;

            // REGLA DE SEGURIDAD: Impedir que la barra baje del 74% (Zona de bot√≥n)
            posMovil.x = xPct;
            posMovil.y = Math.min(yPct, 74); 

            dibujarElementos();
        });

        window.addEventListener('pointerup', () => {
            dragEnProgreso = false;
        });

        /* =========================================
           L√ìGICA DE TIEMPO (CONTRARELOJ)
           ========================================= */
        function iniciarCuentaRegresiva() {
            clearInterval(estado.cronometro);
            
            // El tiempo se reduce 0.4s por nivel, m√≠nimo 2.5s
            let tiempoParaEsteNivel = Math.max(2.5, estado.tiempoInicial - (estado.nivelActual * 0.4));
            estado.segundosRestantes = tiempoParaEsteNivel;
            
            const barra = document.getElementById('timer-progress');
            
            estado.cronometro = setInterval(() => {
                estado.segundosRestantes -= 0.1;
                let porcentaje = (estado.segundosRestantes / tiempoParaEsteNivel) * 100;
                barra.style.width = porcentaje + "%";

                if(estado.segundosRestantes <= 0) {
                    clearInterval(estado.cronometro);
                    procesarFallo("¬°TIEMPO AGOTADO!");
                }
            }, 100);
        }

        /* =========================================
           VALIDACI√ìN Y RESULTADOS
           ========================================= */
        function validarAlineacionFinal() {
            if (!estado.juegoActivo) return;
            
            clearInterval(estado.cronometro);
            
            // Pit√°goras para calcular error de distancia real (puntos en plano cartesiano %)
            const diferenciaX = posFija.x - posMovil.x;
            const diferenciaY = posFija.y - posMovil.y;
            const errorAbsoluto = Math.sqrt(diferenciaX * diferenciaX + diferenciaY * diferenciaY);

            // Umbral del 10% de la longitud de la barra (La barra mide aprox 180px)
            // En unidades de porcentaje de pantalla, esto equivale a ~3.8 unidades
            const margenDeExito = 3.8; 

            if (errorAbsoluto <= margenDeExito) {
                procesarAcierto(errorAbsoluto);
            } else {
                procesarFallo("¬°DESALINEADO!");
            }
        }

        function procesarAcierto(dist) {
            console.log("¬°Acierto! Error:", dist);
            estado.juegoActivo = false;
            estado.aciertosTotales++;
            
            // Calcular porcentaje visual de precisi√≥n para el usuario
            let precisionVisual = Math.max(0, 100 - (dist * 5)).toFixed(0);
            document.getElementById('precision-value').innerText = precisionVisual + "%";
            
            // Mostrar pantalla de victoria
            document.getElementById('victory-screen').classList.add('active');
        }

        function procesarFallo(mensaje) {
            console.log("Fallo:", mensaje);
            estado.juegoActivo = false;
            estado.fallosTotales++;
            estado.vidasRestantes--;
            
            // Actualizar HUD de vidas
            document.getElementById('val-vidas').innerText = "‚ù§Ô∏è".repeat(Math.max(0, estado.vidasRestantes));
            
            // Mostrar Toast de error
            const toast = document.getElementById('toast-alert');
            toast.innerText = mensaje;
            toast.classList.add('active');

            setTimeout(() => {
                toast.classList.remove('active');
                if (estado.vidasRestantes <= 0) {
                    finalizarYEnviarResultados();
                } else {
                    estado.juegoActivo = true;
                    generarNuevoReto();
                }
            }, 1500);
        }

        function cargarSiguienteNivel() {
            estado.nivelActual++;
            document.getElementById('val-nivel').innerText = estado.nivelActual;
            document.getElementById('victory-screen').classList.remove('active');
            estado.juegoActivo = true;
            generarNuevoReto();
        }

        /* =========================================
           ENV√çO DE DATOS A GOOGLE SHEETS
           ========================================= */
        function finalizarYEnviarResultados() {
            console.log("Finalizando sesi√≥n y enviando datos...");
            
            const payload = new FormData();
            payload.append(FORM_MAP.paciente, localStorage.getItem('pacienteActual') || "Manu");
            payload.append(FORM_MAP.juego, "Vernier PRO - " + estado.modoJuego);
            payload.append(FORM_MAP.nivel, estado.nivelActual);
            payload.append(FORM_MAP.aciertos, estado.aciertosTotales);
            payload.append(FORM_MAP.fallos, estado.fallosTotales);
            payload.append(FORM_MAP.fecha, new Date().toLocaleDateString());

            // Env√≠o as√≠ncrono modo 'no-cors' para Google Forms
            fetch(FORM_ENDPOINT, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: payload 
            }).then(() => {
                alert("ENTRENAMIENTO COMPLETADO\nNivel Alcanzado: " + estado.nivelActual);
                location.reload();
            }).catch((err) => {
                console.error("Error al enviar:", err);
                location.reload();
            });
        }
    </script>
</body>
</html>
