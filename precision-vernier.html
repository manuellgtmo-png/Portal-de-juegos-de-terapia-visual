<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vernier Precision Pro | Clínica Visual</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           ESTILOS BASE Y VARIABLES (SISTEMA DARK)
           ========================================= */
        :root {
            --bg-dark: #0b0f1a;
            --card-dark: #1e2533;
            --purple-neon: #a855f7;
            --purple-glow: rgba(168, 85, 247, 0.4);
            --green-ui: #22c55e;
            --green-shadow: #16a34a;
            --red-ui: #f43f5e;
            --text-silver: #94a3b8;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           HUD SUPERIOR (ESTADÍSTICAS)
           ========================================= */
        #top-hud {
            position: absolute;
            top: 25px;
            left: 0;
            width: 100%;
            padding: 0 50px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 100;
            pointer-events: none;
        }

        .hud-module {
            background: var(--card-dark);
            padding: 15px 20px;
            border-radius: 18px;
            text-align: center;
            min-width: 120px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            pointer-events: auto;
        }

        .hud-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 900;
            color: var(--text-silver);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 5px;
        }

        .hud-value {
            font-size: 1.6rem;
            font-weight: 900;
        }

        /* BARRA DE TIEMPO DINÁMICA */
        #timer-container {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            height: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #timer-fill {
            width: 100%;
            height: 100%;
            background: var(--red-ui);
            transition: width 0.1s linear;
        }

        /* =========================================
           ESCENARIO Y ELEMENTOS VERNIER
           ========================================= */
        #arena {
            flex: 1;
            position: relative;
            width: 100%;
            z-index: 10;
        }

        .vernier-bar {
            position: absolute;
            width: 10px;
            height: 110px;
            border-radius: 50px;
            transform-origin: center center;
            will-change: transform, left, top;
        }

        #bar-fixed {
            background-color: #334155;
            opacity: 0.8;
            z-index: 5;
        }

        #bar-player {
            background-color: var(--purple-neon);
            box-shadow: 0 0 25px var(--purple-glow);
            z-index: 20;
            cursor: grab;
        }

        /* =========================================
           CONTROLES LATERALES DE PRECISIÓN
           ========================================= */
        #side-panel {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 200;
        }

        .btn-precision {
            width: 75px;
            height: 75px;
            background: transparent;
            border: 2px solid var(--purple-neon);
            border-radius: 20px;
            color: white;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-precision:active {
            background: var(--purple-neon);
            transform: scale(0.92);
        }

        /* BOTÓN DE VALIDACIÓN FINAL */
        #confirm-alignment {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 450px;
            height: 85px;
            background: var(--green-ui);
            color: var(--bg-dark);
            border: none;
            border-radius: 45px;
            font-size: 1.6rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 10px 0 var(--green-shadow);
            cursor: pointer;
            z-index: 300;
        }

        #confirm-alignment:active {
            transform: translateX(-50%) translateY(6px);
            box-shadow: 0 4px 0 var(--green-shadow);
        }

        /* =========================================
           SISTEMA DE RESULTADOS (MODAL)
           ========================================= */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(11, 15, 26, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-result {
            background: var(--card-dark);
            width: 100%;
            max-width: 480px;
            padding: 50px 40px;
            border-radius: 40px;
            text-align: center;
            border-left: 8px solid var(--purple-neon);
            box-shadow: 0 40px 80px rgba(0,0,0,0.6);
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .res-title {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--purple-neon);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .res-subtitle {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-silver);
            margin-bottom: 25px;
        }

        .res-score {
            font-size: 5.5rem;
            font-weight: 900;
            color: var(--white);
            margin-bottom: 20px;
        }

        .res-details {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--white);
            margin-bottom: 35px;
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 20px;
        }

        .btn-restart {
            background: var(--green-ui);
            color: var(--bg-dark);
            padding: 22px 45px;
            border-radius: 30px;
            border: none;
            font-weight: 900;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 8px 0 var(--green-shadow);
            transition: 0.1s;
        }

        .btn-restart:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 var(--green-shadow);
        }

    </style>
</head>
<body>

    <div id="top-hud">
        <div class="hud-module">
            <span class="hud-label">Misión</span>
            <span id="lvl-val" class="hud-value">1</span>
        </div>
        
        <div id="timer-container">
            <div id="timer-fill"></div>
        </div>

        <div class="hud-module">
            <span class="hud-label">Integridad</span>
            <span id="hp-val" class="hud-value">❤️❤️❤️</span>
        </div>
    </div>

    <div id="side-panel">
        <button class="btn-precision" onmousedown="startNudge('ang', -2)" onmouseup="stopNudge()" ontouchstart="startNudge('ang', -2)" ontouchend="stopNudge()">↻</button>
        <button class="btn-precision" onmousedown="startNudge('ang', 2)" onmouseup="stopNudge()" ontouchstart="startNudge('ang', 2)" ontouchend="stopNudge()">↺</button>
        <button class="btn-precision" onmousedown="startNudge('x', -0.5)" onmouseup="stopNudge()" ontouchstart="startNudge('x', -0.5)" ontouchend="stopNudge()">←</button>
        <button class="btn-precision" onmousedown="startNudge('x', 0.5)" onmouseup="stopNudge()" ontouchstart="startNudge('x', 0.5)" ontouchend="stopNudge()">→</button>
    </div>

    <div id="arena">
        <div id="bar-fixed" class="vernier-bar"></div>
        <div id="bar-player" class="vernier-bar"></div>
        <button id="confirm-alignment" onclick="processValidation()">Confirmar Alineación</button>
    </div>

    <div id="result-overlay" class="overlay">
        <div class="modal-result">
            <h2 id="modal-title" class="res-title">FUERA DE RANGO</h2>
            <p id="modal-sub" class="res-subtitle">MISIÓN TERMINADA</p>
            <div id="modal-score" class="res-score">55%</div>
            <div id="modal-stats" class="res-details">
                Desviación Lateral: X.XX px<br>
                Error Angular: Y.3°<br>
                Vidas restantes: N
            </div>
            <button id="modal-btn" class="btn-restart" onclick="closeResults()">REINTERTAR NIVEL</button>
        </div>
    </div>

    <script>
        /* =========================================
           LÓGICA DEL SOFTWARE (JAVASCRIPT)
           ========================================= */

        // 1. CONFIGURACIÓN Y ESTADO INICIAL
        const GOOGLE_SHEETS_URL = "TU_URL_DE_APPS_SCRIPT_AQUI";

        const gameState = {
            level: 1,
            hp: 3,
            isActive: true,
            timer: null,
            baseTime: 12,
            currentTime: 12,
            nudgeInterval: null
        };

        const targetPos = { x: 50, y: 30, ang: 0 };
        const playerPos = { x: 50, y: 70, ang: 0 };

        // 2. INICIALIZADOR DE NIVEL
        function initLevel() {
            gameState.isActive = true;
            
            // Generación aleatoria para la barra objetivo (evitando los bordes)
            targetPos.x = 30 + (Math.random() * 40);
            targetPos.y = 25 + (Math.random() * 10);
            
            // Rotación progresiva: Nivel 1 (0°), Nivel 2 (90°), Nivel 3+ (Aleatorio)
            if (gameState.level === 1) targetPos.ang = 0;
            else if (gameState.level === 2) targetPos.ang = 90;
            else targetPos.ang = Math.floor(Math.random() * 180);

            // Posición inicial del jugador (descentrado para forzar el ajuste)
            playerPos.x = targetPos.x + (Math.random() > 0.5 ? 15 : -15);
            playerPos.y = 65; 
            playerPos.ang = 0;

            updateVisuals();
            startTimer();
        }

        // 3. ACTUALIZACIÓN DE INTERFAZ
        function updateVisuals() {
            const tBar = document.getElementById('bar-fixed');
            const pBar = document.getElementById('bar-player');

            tBar.style.left = targetPos.x + "%";
            tBar.style.top = targetPos.y + "%";
            tBar.style.transform = `translate(-50%, -50%) rotate(${targetPos.ang}deg)`;

            pBar.style.left = playerPos.x + "%";
            pBar.style.top = playerPos.y + "%";
            pBar.style.transform = `translate(-50%, -50%) rotate(${playerPos.ang}deg)`;
        }

        // 4. CONTROL HÍBRIDO (TOUCH DRAG)
        let isDragging = false;
        const playerBarEl = document.getElementById('bar-player');

        playerBarEl.addEventListener('touchstart', (e) => {
            if(gameState.isActive) isDragging = true;
        });

        window.addEventListener('touchmove', (e) => {
            if (!isMoving || !gameState.isActive) return;
            
            let touchX = e.touches[0].clientX;
            let percentX = (touchX / window.innerWidth) * 100;
            
            playerPos.x = Math.min(Math.max(percentX, 5), 95);
            updateVisuals();
            e.preventDefault();
        }, { passive: false });

        window.addEventListener('touchend', () => isDragging = false);

        // 5. CONTROL HÍBRIDO (BOTONES DE PRECISIÓN)
        function startNudge(axis, val) {
            if (!gameState.isActive) return;
            // Aplicamos un primer movimiento inmediato
            applyNudge(axis, val);
            // Iniciamos repetición para "mantener pulsado"
            gameState.nudgeInterval = setInterval(() => applyNudge(axis, val), 100);
        }

        function stopNudge() {
            clearInterval(gameState.nudgeInterval);
        }

        function applyNudge(axis, val) {
            if (axis === 'x') playerPos.x += val;
            if (axis === 'ang') playerPos.ang += val;
            updateVisuals();
        }

        // 6. GESTIÓN DEL TIEMPO
        function startTimer() {
            let limit = Math.max(3, gameState.baseTime - (gameState.level * 0.7));
            gameState.currentTime = limit;
            const barFill = document.getElementById('timer-fill');

            clearInterval(gameState.timer);
            gameState.timer = setInterval(() => {
                gameState.currentTime -= 0.1;
                barFill.style.width = (gameState.currentTime / limit * 100) + "%";
                
                if (gameState.currentTime <= 0) {
                    processValidation();
                }
            }, 100);
        }

        // 7. VALIDACIÓN CLÍNICA (VERNIER ACCURACY)
        function processValidation() {
            if (!gameState.isActive) return;
            gameState.isActive = false;
            clearInterval(gameState.timer);

            // Cálculo de errores
            const errorX = Math.abs(targetPos.x - playerPos.x);
            let errorAng = Math.abs((targetPos.ang % 180) - (playerPos.ang % 180));
            if (errorAng > 90) errorAng = Math.abs(180 - errorAng);

            // Algoritmo de puntuación (Prioridad 1: Alineación lateral, Prioridad 2: Ángulo)
            const finalScore = Math.max(0, 100 - (errorX * 18 + errorAng * 3.5));
            const isSuccess = finalScore >= 88;

            if (!isSuccess) gameState.hp--;

            showResults(isSuccess, finalScore, errorX, errorAng);
            sendDataToCloud(finalScore);
        }

        // 8. DESPLIEGUE DE RESULTADOS (MODAL ESTILO JUEGO)
        function showResults(success, score, ex, ea) {
            const overlay = document.getElementById('result-overlay');
            const title = document.getElementById('modal-title');
            const sub = document.getElementById('modal-sub');
            const scoreDisp = document.getElementById('modal-score');
            const stats = document.getElementById('modal-stats');
            const btn = document.getElementById('modal-btn');

            overlay.style.display = 'flex';
            scoreDisp.innerText = Math.round(score) + "%";
            
            if (success) {
                title.innerText = "¡LOGRADO!";
                title.style.color = "var(--green-ui)";
                sub.innerText = "ALINEACIÓN COMPLETADA";
                btn.innerText = "SIGUIENTE NIVEL";
            } else {
                title.innerText = "FUERA DE RANGO";
                title.style.color = "var(--purple-neon)";
                sub.innerText = "MISIÓN TERMINADA";
                btn.innerText = gameState.hp > 0 ? "REINTENTAR NIVEL" : "FINALIZAR SESIÓN";
            }

            stats.innerHTML = `
                Desviación Lateral: ${ex.toFixed(2)} px<br>
                Error Angular: ${ea.toFixed(1)}°<br>
                Vidas restantes: ${Math.max(0, gameState.hp)}
            `;
        }

        function closeResults() {
            document.getElementById('result-overlay').style.display = 'none';
            
            if (gameState.hp <= 0) {
                location.reload(); // Reinicio total si pierde vidas
            } else {
                // Si tuvo éxito, sube nivel. Si no, repite el mismo.
                const wasSuccess = document.getElementById('modal-title').innerText === "¡LOGRADO!";
                if (wasSuccess) gameState.level++;
                
                document.getElementById('lvl-val').innerText = gameState.level;
                document.getElementById('hp-val').innerText = "❤️".repeat(gameState.hp);
                initLevel();
            }
        }

        // 9. CONEXIÓN CON GOOGLE SHEETS
        async function sendDataToCloud(score) {
            if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes("TU_URL")) return;

            const payload = {
                paciente: "ID_CLINICO_001",
                nivel: gameState.level,
                precision: score.toFixed(2),
                fecha: new Date().toLocaleString()
            };

            try {
                fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.warn("Fallo en sincronización cloud:", e);
            }
        }

        // Lanzar primer nivel al cargar
        initLevel();

    </script>
</body>
</html>
