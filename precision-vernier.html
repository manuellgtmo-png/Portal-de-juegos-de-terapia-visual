<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precisi√≥n Vernier PRO - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --navy-dark: #0f172a; 
            --navy-card: #1e293b;
            --vernier-purple: #a855f7; 
            --green-neon: #22c55e;
            --danger-red: #f43f5e;
            --text-main: #f8fafc;
        }

        /* --- RESET Y BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; background: var(--navy-dark); color: var(--text-main); 
            font-family: 'Montserrat', sans-serif; overflow: hidden; touch-action: none;
            width: 100vw; height: 100vh;
        }

        /* --- HUD (INDICADORES SUPERIORES) --- */
        #ui-layer { 
            position: absolute; top: 0; width: 100%; padding: 25px; 
            display: none; justify-content: space-between; align-items: flex-start; z-index: 100;
        }
        .stat-box { 
            background: var(--navy-card); padding: 15px 25px; border-radius: 25px; 
            font-weight: 900; border: 1px solid rgba(255,255,255,0.1); 
            display: flex; flex-direction: column; align-items: center; min-width: 100px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }

        #patient-info {
            position: absolute; top: 110px; left: 25px; font-size: 0.9rem;
            background: var(--vernier-purple); color: white; padding: 12px 25px; 
            border-radius: 20px; font-weight: 700; box-shadow: 0 5px 15px rgba(168, 85, 247, 0.3);
        }

        /* --- ELEMENTOS DEL JUEGO --- */
        #game-area { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        
        .line { 
            position: absolute; border-radius: 50px; touch-action: none; 
            z-index: 10; transition: box-shadow 0.3s ease;
        }
        .v-line { width: 12px; height: 180px; }
        .h-line { width: 180px; height: 12px; }

        #fixed-line { background: #475569; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
        #mobile-line { 
            background: var(--vernier-purple); 
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.6); 
            cursor: grab;
        }
        #mobile-line:active { cursor: grabbing; box-shadow: 0 0 40px rgba(168, 85, 247, 0.9); }

        /* --- BOT√ìN DE ACCI√ìN --- */
        #confirm-btn { 
            position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%); 
            width: 88%; max-width: 480px; z-index: 200; height: 85px;
            background: var(--green-neon); color: var(--navy-dark); border: none; 
            border-radius: 45px; font-size: 1.6rem; cursor: pointer; font-weight: 900; 
            text-transform: uppercase; box-shadow: 0 10px 0 #16a34a; transition: all 0.1s ease;
        }
        #confirm-btn:active { transform: translateX(-50%) translateY(5px); box-shadow: 0 5px 0 #16a34a; }

        /* --- SISTEMA DE TIEMPO --- */
        #timer-container { 
            position: absolute; top: 35px; left: 50%; transform: translateX(-50%); 
            width: 260px; height: 15px; background: rgba(255,255,255,0.05); 
            border-radius: 20px; overflow: hidden; display: none; z-index: 90;
            border: 2px solid var(--navy-dark);
        }
        #timer-fill { width: 100%; height: 100%; background: var(--danger-red); transition: width 0.1s linear; }

        /* --- MENSAJES DE ESTADO --- */
        #game-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: var(--danger-red); color: white; padding: 45px 90px; border-radius: 35px;
            font-weight: 900; font-size: 2.8rem; z-index: 500; 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; border: 8px solid white; text-align: center;
            box-shadow: 0 0 100px rgba(244, 63, 94, 0.5);
        }
        #game-msg.active { transform: translate(-50%, -50%) scale(1); }

        /* --- PANTALLAS (OVERLAYS) --- */
        .overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 20px; text-align: center; z-index: 400; 
        }
        .card { 
            background: var(--navy-card); padding: 55px; border-radius: 55px; width: 92%; max-width: 620px; 
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 40px 80px rgba(0,0,0,0.6);
        }

        .mode-option {
            background: rgba(255,255,255,0.04); border: 2px solid rgba(255,255,255,0.1);
            padding: 30px; border-radius: 35px; margin-bottom: 25px; cursor: pointer; text-align: left;
            transition: all 0.3s ease;
        }
        .mode-option:hover { background: rgba(168, 85, 247, 0.1); border-color: var(--vernier-purple); transform: translateY(-3px); }
        .mode-option h3 { margin: 0; font-size: 1.3rem; color: var(--vernier-purple); }
        .mode-option p { margin: 8px 0 0; font-size: 0.9rem; color: #94a3b8; line-height: 1.4; }

        input[type="range"] { 
            width: 100%; margin: 35px 0; -webkit-appearance: none; background: #334155; 
            height: 12px; border-radius: 10px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 35px; height: 35px; background: var(--vernier-purple); 
            border-radius: 50%; cursor: pointer; border: 4px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div id="game-msg">¬°DESALINEADO!</div>

    <div id="intro-screen" class="overlay">
        <div class="card">
            <h1 style="color: var(--vernier-purple); font-size: 2.6rem; font-weight: 900; margin-bottom: 40px;">MISI√ìN VERNIER PRO</h1>
            <div class="mode-option" onclick="gestionarFlujoConfig('entrenamiento')">
                <h3>‚è±Ô∏è MODO CRONOMETRADO</h3>
                <p>Terapia de precisi√≥n absoluta. Se registrar√° tu tiempo de respuesta y exactitud en cada nivel sin l√≠mites.</p>
            </div>
            <div class="mode-option" onclick="gestionarFlujoConfig('contrareloj')">
                <h3>üî• MODO CONTRARELOJ</h3>
                <p>Desaf√≠o de agudeza visual bajo presi√≥n. Tienes segundos limitados para alinear las barras antes del fallo.</p>
            </div>
        </div>
    </div>

    <div id="setup-screen" class="overlay" style="display: none;">
        <div class="card">
            <h2 id="setup-title" style="color: var(--vernier-purple); font-size: 1.8rem;">INSTRUCCIONES</h2>
            <div id="setup-body" style="margin: 30px 0; font-size: 1rem; line-height: 1.7; color: #cbd5e1; text-align: left;"></div>
            
            <div id="time-config-area" style="display: none;">
                <p style="font-weight: 700; color: white;">Ajusta el tiempo base por nivel:</p>
                <input type="range" id="time-slider" min="3" max="15" value="10" oninput="document.getElementById('val-time').innerText = this.value">
                <div style="font-size: 3.5rem; font-weight: 900; color: white;"><span id="val-time">10</span>s</div>
            </div>

            <button class="primary-btn" style="background:var(--green-neon); color:var(--navy-dark); width:100%; border-radius:50px; padding:25px; font-weight:900; border:none; margin-top:30px; cursor:pointer; font-size: 1.4rem;" onclick="iniciarMisionReal()">INICIAR ENTRENAMIENTO</button>
        </div>
    </div>

    <div id="level-screen" class="overlay" style="display: none;">
        <div class="card" style="border: 3px solid var(--green-neon); background: linear-gradient(to bottom, var(--navy-card), #0f172a);">
            <h2 style="color: var(--green-neon); font-size: 2.5rem; margin-top: 0;">¬°OBJETIVO LOGRADO!</h2>
            <div style="margin: 35px 0; background: rgba(0,0,0,0.4); padding: 40px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.05);">
                <p style="text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; font-size: 0.8rem; margin-bottom: 10px;">Precisi√≥n de Alineaci√≥n</p>
                <div id="res-precision" style="color: var(--vernier-purple); font-size: 4.8rem; font-weight: 900; line-height: 1;">0%</div>
                <div style="margin-top:30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                    <p style="font-size: 1.2rem;">Tiempo de Respuesta: <span id="res-tiempo" style="color:white; font-weight:900;">0s</span></p>
                </div>
            </div>
            <button class="primary-btn" style="background:var(--green-neon); color:var(--navy-dark); width:100%; border-radius:50px; padding:25px; font-weight:900; border:none; cursor:pointer;" onclick="irSiguienteNivel()">CONTINUAR MISI√ìN</button>
        </div>
    </div>

    <div id="ui-layer">
        <div class="stat-box"><span class="label">Nivel</span><span id="txt-nivel" style="font-size: 1.8rem; color: white;">1</span></div>
        <div class="stat-box"><span class="label">Vidas</span><span id="txt-vidas" style="font-size: 1.8rem;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
        <div id="patient-info">Paciente: <span id="txt-paciente">Explorador</span></div>
    </div>

    <div id="game-area">
        <div id="timer-container"><div id="timer-fill"></div></div>
        <div id="fixed-line" class="line"></div>
        <div id="mobile-line" class="line"></div>
        <button id="confirm-btn" onclick="validarAlineacion()">CONFIRMAR ALINEACI√ìN</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE DATOS (GOOGLE SHEETS) ---
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const FORM_ENTRIES = { 
            paciente: "entry.369874016", 
            juego: "entry.1353470174", 
            nivel: "entry.721051298", 
            aciertos: "entry.873272199", 
            fallos: "entry.1030094511", 
            fecha: "entry.845098414" 
        };

        // --- VARIABLES GLOBALES DE ESTADO ---
        let modoSeleccionado = '', nivelActual = 1, contadorVidas = 3;
        let totalAciertos = 0, totalFallos = 0;
        let posLineaMovil = { x: 50, y: 50 }, esNivelVertical = true, estadoJuegoActivo = false;
        let cronometroNivel = 0, intervaloTimer, tiempoLimiteConfig = 10;

        // --- FLUJO DE INICIO ---
        function gestionarFlujoConfig(modo) {
            modoSeleccionado = modo;
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'flex';
            
            const titulo = document.getElementById('setup-title');
            const cuerpo = document.getElementById('setup-body');
            const areaConfig = document.getElementById('time-config-area');

            if(modo === 'entrenamiento') {
                titulo.innerText = "MODO CRONOMETRADO";
                cuerpo.innerHTML = "‚Ä¢ Tu objetivo es alinear la barra morada con la gris de forma perfecta.<br>‚Ä¢ El sistema registrar√° tu precisi√≥n y velocidad.<br>‚Ä¢ <b>Usa tu dedo o mouse</b> para arrastrar la barra morada.<br>‚Ä¢ No hay l√≠mite de tiempo, prioriza la exactitud.";
                areaConfig.style.display = 'none';
            } else {
                titulo.innerText = "MODO CONTRARELOJ";
                cuerpo.innerHTML = "‚Ä¢ ¬°Misi√≥n Cr√≠tica! Debes alinear las barras antes de que el tiempo se agote.<br>‚Ä¢ Si el cron√≥metro llega a cero, perder√°s una vida autom√°ticamente.<br>‚Ä¢ El tiempo disponible se reduce levemente en cada nivel.";
                areaConfig.style.display = 'block';
            }
        }

        function iniciarMisionReal() {
            tiempoLimiteConfig = parseInt(document.getElementById('time-slider').value);
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            document.getElementById('txt-paciente').innerText = localStorage.getItem('pacienteActual') || "Manu";
            
            if(modoSeleccionado === 'contrareloj') {
                document.getElementById('timer-container').style.display = 'block';
            }
            estadoJuegoActivo = true;
            prepararNuevoReto();
        }

        // --- L√ìGICA CORE DEL JUEGO ---
        function prepararNuevoReto() {
            esNivelVertical = Math.random() > 0.5;
            const lineaFija = document.getElementById('fixed-line');
            const lineaMovil = document.getElementById('mobile-line');

            if(esNivelVertical) {
                lineaFija.className = lineaMovil.className = "line v-line";
                lineaFija.style.left = "50%"; 
                lineaFija.style.top = "15%";
                posLineaMovil = { x: Math.random() > 0.5 ? 20 : 80, y: 50 };
            } else {
                lineaFija.className = lineaMovil.className = "line h-line";
                lineaFija.style.top = "30%"; 
                lineaFija.style.left = "15%";
                posLineaMovil = { x: 50, y: Math.random() > 0.5 ? 15 : 45 };
            }
            
            renderizarPosicion();
            iniciarControlTiempo();
        }

        function iniciarControlTiempo() {
            clearInterval(intervaloTimer);
            cronometroNivel = 0;
            
            if(modoSeleccionado === 'contrareloj') {
                let tiempoMax = Math.max(2.2, tiempoLimiteConfig - (nivelActual * 0.4));
                let tiempoRestante = tiempoMax;
                intervaloTimer = setInterval(() => {
                    tiempoRestante -= 0.1;
                    cronometroNivel += 0.1;
                    document.getElementById('timer-fill').style.width = (tiempoRestante / tiempoMax * 100) + "%";
                    if(tiempoRestante <= 0) {
                        clearInterval(intervaloTimer);
                        ejecutarFallo("¬°TIEMPO AGOTADO!");
                    }
                }, 100);
            } else {
                intervaloTimer = setInterval(() => { cronometroNivel += 0.1; }, 100);
            }
        }

        // --- SISTEMA DE ARRASTRE (MOUSE & TOUCH) ---
        let estaArrastrando = false;
        const elemBarra = document.getElementById('mobile-line');

        const inicioDrag = (e) => { if(estadoJuegoActivo) estaArrastrando = true; };
        
        const moviendoDrag = (e) => {
            if(!estaArrastrando || !estadoJuegoActivo) return;
            const evento = e.touches ? e.touches[0] : e;
            
            if(esNivelVertical) {
                posLineaMovil.x = (evento.clientX / window.innerWidth) * 100;
            } else {
                let yPorcentaje = (evento.clientY / window.innerHeight) * 100;
                // L√çMITE DE SEGURIDAD: No permite bajar la barra m√°s all√° del 72% para no tapar el bot√≥n
                posLineaMovil.y = Math.min(yPorcentaje, 72);
            }
            renderizarPosicion();
        };

        const finDrag = () => { estaArrastrando = false; };

        // Registro de Eventos Expandido (PC + Tablet + Mobile)
        elemBarra.addEventListener('mousedown', inicioDrag);
        elemBarra.addEventListener('touchstart', inicioDrag, {passive: true});
        window.addEventListener('mousemove', moviendoDrag);
        window.addEventListener('touchmove', moviendoDrag, {passive: false});
        window.addEventListener('mouseup', finDrag);
        window.addEventListener('touchend', finDrag);

        function renderizarPosicion() {
            elemBarra.style.left = posLineaMovil.x + "%";
            elemBarra.style.top = posLineaMovil.y + "%";
        }

        // --- VALIDACI√ìN Y ENV√çO DE DATOS ---
        function validarAlineacion() {
            if(!estadoJuegoActivo) return;
            clearInterval(intervaloTimer);
            
            let calculoError = esNivelVertical ? Math.abs(50 - posLineaMovil.x) : Math.abs(30 - posLineaMovil.y);
            let margenTolerancia = Math.max(0.1, 1.7 - (nivelActual * 0.15));

            if(calculoError <= margenTolerancia) {
                totalAciertos++;
                estadoJuegoActivo = false;
                let precisionVisual = Math.max(0, (100 - (calculoError * 8))).toFixed(1);
                document.getElementById('res-precision').innerText = precisionVisual + "%";
                document.getElementById('res-tiempo').innerText = cronometroNivel.toFixed(2) + "s";
                document.getElementById('level-screen').style.display = 'flex';
            } else {
                ejecutarFallo("¬°DESALINEADO!");
            }
        }

        function ejecutarFallo(mensaje) {
            estadoJuegoActivo = false;
            totalFallos++;
            contadorVidas--;
            document.getElementById('txt-vidas').innerText = "‚ù§Ô∏è".repeat(Math.max(0, contadorVidas));
            
            const feedback = document.getElementById('game-msg');
            feedback.innerText = mensaje;
            feedback.classList.add('active');

            setTimeout(() => {
                feedback.classList.remove('active');
                if(contadorVidas <= 0) terminarSesionYEnviar();
                else { 
                    estadoJuegoActivo = true; 
                    prepararNuevoReto(); 
                }
            }, 1300);
        }

        function irSiguienteNivel() {
            nivelActual++;
            document.getElementById('txt-nivel').innerText = nivelActual;
            document.getElementById('level-screen').style.display = 'none';
            estadoJuegoActivo = true;
            prepararNuevoReto();
        }

        function terminarSesionYEnviar() {
            const payload = new FormData();
            payload.append(FORM_ENTRIES.paciente, localStorage.getItem('pacienteActual') || "Manu");
            payload.append(FORM_ENTRIES.juego, "Vernier PRO - " + modoSeleccionado);
            payload.append(FORM_ENTRIES.nivel, nivelActual);
            payload.append(FORM_ENTRIES.aciertos, totalAciertos);
            payload.append(FORM_ENTRIES.fallos, totalFallos);
            payload.append(FORM_ENTRIES.fecha, new Date().toISOString().split('T')[0]);

            fetch(GOOGLE_FORM_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: payload 
            }).then(() => {
                alert("ENTRENAMIENTO FINALIZADO\nNivel alcanzado: " + nivelActual);
                location.reload();
            }).catch(() => {
                location.reload();
            });
        }
    </script>
</body>
</html>
