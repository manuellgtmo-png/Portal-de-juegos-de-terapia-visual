<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Precisi√≥n Vernier PRO - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --navy-dark: #0f172a; 
            --navy-card: #1e293b;
            --vernier-purple: #a855f7; 
            --green-neon: #22c55e;
            --danger-red: #f43f5e;
            --text-main: #f8fafc;
            --slate-blue: #334155;
        }

        body { 
            margin: 0; background: var(--navy-dark); color: var(--text-main); 
            font-family: 'Montserrat', sans-serif; overflow: hidden; touch-action: none;
            width: 100vw; height: 100vh;
        }

        /* --- HUD DE DATOS --- */
        #ui-layer { 
            position: absolute; top: 0; width: 100%; padding: 20px; 
            display: none; justify-content: space-between; box-sizing: border-box; z-index: 100;
        }
        .stat-box { 
            background: var(--navy-card); padding: 12px 20px; border-radius: 20px; 
            font-weight: 900; border: 1px solid rgba(255,255,255,0.1); 
            display: flex; flex-direction: column; align-items: center; min-width: 90px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        #patient-tag {
            position: absolute; top: 110px; left: 20px; font-size: 0.85rem;
            background: var(--vernier-purple); color: white; padding: 10px 20px; 
            border-radius: 15px; font-weight: bold; box-shadow: 0 5px 15px rgba(168, 85, 247, 0.4);
        }

        /* --- √ÅREA DE PRUEBA --- */
        #game-area { width: 100vw; height: 100vh; position: relative; background: var(--navy-dark); overflow: hidden; }
        
        .line { 
            position: absolute; border-radius: 20px; touch-action: none; 
            transition: box-shadow 0.3s ease;
        }
        .v-line { width: 10px; height: 180px; }
        .h-line { width: 180px; height: 10px; }

        #fixed-line { background: #475569; box-shadow: 0 0 20px rgba(71, 85, 105, 0.4); }
        #mobile-line { 
            background: var(--vernier-purple); cursor: grab; z-index: 50; 
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.6);
        }
        #mobile-line:active { cursor: grabbing; scale: 1.05; box-shadow: 0 0 40px rgba(168, 85, 247, 0.8); }

        /* --- SISTEMA DE TIEMPO --- */
        #timer-container { 
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%); 
            width: 280px; height: 12px; background: rgba(255,255,255,0.05); 
            border-radius: 20px; overflow: hidden; display: none; border: 1px solid rgba(255,255,255,0.1);
        }
        #timer-fill { width: 100%; height: 100%; background: var(--danger-red); transition: width 0.1s linear; }

        /* --- FEEDBACK GAMEPLAY --- */
        #game-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: var(--danger-red); color: white; padding: 40px 80px; border-radius: 30px;
            font-weight: 900; font-size: 2.5rem; z-index: 500; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; text-transform: uppercase; border: 6px solid white; box-shadow: 0 0 100px rgba(244, 63, 94, 0.6);
        }
        #game-msg.active { transform: translate(-50%, -50%) scale(1); }

        /* --- MEN√öS Y CAPAS --- */
        .overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 30px; text-align: center; z-index: 400; 
        }
        .card { 
            background: var(--navy-card); padding: 50px; border-radius: 50px; 
            width: 90%; max-width: 600px; border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }

        .mode-option {
            background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1);
            padding: 25px; border-radius: 30px; margin-bottom: 20px; cursor: pointer;
            transition: all 0.3s; text-align: left;
        }
        .mode-option:hover { background: rgba(168, 85, 247, 0.1); border-color: var(--vernier-purple); transform: translateY(-5px); }
        .mode-option h3 { margin: 0; color: var(--vernier-purple); font-size: 1.2rem; }
        .mode-option p { margin: 8px 0 0; font-size: 0.9rem; color: #94a3b8; line-height: 1.4; }

        input[type="range"] { 
            width: 100%; height: 15px; border-radius: 10px; background: var(--slate-blue);
            outline: none; -webkit-appearance: none; margin: 30px 0;
        }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 30px; height: 30px; background: var(--vernier-purple); border-radius: 50%; cursor: pointer; border: 3px solid white; }

        button.primary-btn { 
            background: var(--green-neon); color: var(--navy-dark); border: none; padding: 25px; 
            border-radius: 60px; font-size: 1.5rem; cursor: pointer; font-weight: 900; 
            text-transform: uppercase; width: 100%; transition: all 0.2s; box-shadow: 0 10px 0 #16a34a;
        }
        button.primary-btn:active { transform: translateY(5px); box-shadow: 0 5px 0 #16a34a; }

        #confirm-btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 85%; max-width: 450px; }
    </style>
</head>
<body>

    <div id="game-msg">¬°DESALINEADO!</div>

    <div id="intro-screen" class="overlay">
        <div class="card">
            <h1 style="color: var(--vernier-purple); font-size: 2.5rem; font-weight: 900; margin-bottom: 30px;">MISI√ìN VERNIER PRO</h1>
            
            <div class="mode-option" onclick="prepararInstruccion('entrenamiento')">
                <h3>‚è±Ô∏è MODO CRONOMETRADO</h3>
                <p>Terapia de precisi√≥n pura. El sistema medir√° tus milisegundos de respuesta sin presi√≥n de tiempo.</p>
            </div>

            <div class="mode-option" onclick="prepararInstruccion('contrareloj')">
                <h3>üî• MODO CONTRARELOJ</h3>
                <p>Desaf√≠o de agilidad. Alinea las barras antes de que el cron√≥metro se agote. T√∫ eliges la dificultad.</p>
            </div>
        </div>
    </div>

    <div id="setup-screen" class="overlay" style="display: none;">
        <div class="card">
            <h2 id="setup-title" style="color: var(--vernier-purple)">INSTRUCCIONES</h2>
            <div id="setup-body" style="text-align: left; margin: 25px 0; line-height: 1.6; color: #cbd5e1;"></div>
            
            <div id="time-config" style="display: none;">
                <p style="font-weight: 700;">Ajusta el tiempo l√≠mite inicial:</p>
                <input type="range" id="time-slider" min="3" max="15" value="10" oninput="document.getElementById('val-time').innerText = this.value">
                <div style="font-size: 3rem; font-weight: 900;"><span id="val-time">10</span>s</div>
            </div>

            <button class="primary-btn" onclick="iniciarMision()">EMPEZAR MISI√ìN</button>
        </div>
    </div>

    <div id="level-screen" class="overlay" style="display: none;">
        <div class="card">
            <h2 style="color: var(--green-neon); font-size: 2rem;">¬°ALINEACI√ìN EXITOSA!</h2>
            <div style="margin: 30px 0; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05);">
                <p style="margin-bottom: 5px; opacity: 0.7;">Precisi√≥n de Hiperagudeza:</p>
                <div id="res-precision" style="color: var(--vernier-purple); font-size: 3.5rem; font-weight: 900;">0%</div>
                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">
                <p>Tiempo empleado: <span id="res-tiempo" style="font-weight: 900; color: white;">0s</span></p>
            </div>
            <button class="primary-btn" onclick="siguienteNivel()">CONTINUAR</button>
        </div>
    </div>

    <div id="ui-layer">
        <div class="stat-box"><span class="label">Nivel</span><span id="txt-nivel">1</span></div>
        <div class="stat-box"><span class="label">Vidas</span><span id="txt-vidas">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
        <div id="patient-tag">Paciente: <span id="txt-paciente">---</span></div>
    </div>

    <div id="game-area">
        <div id="timer-container"><div id="timer-fill"></div></div>
        <div id="fixed-line" class="line"></div>
        <div id="mobile-line" class="line"></div>
        <button id="confirm-btn" class="primary-btn" style="display:none;" onclick="procesarConfirmacion()">CONFIRMAR ALINEACI√ìN</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN BASE ---
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const ENTRIES = { paciente: "entry.369874016", juego: "entry.1353470174", nivel: "entry.721051298", aciertos: "entry.873272199", fallos: "entry.1030094511", fecha: "entry.845098414" };
        const audioClick = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'); 
        const audioError = new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3'); 

        // --- VARIABLES DE ESTADO ---
        let modoActual = '', nivel = 1, vidas = 3, aciertosTotales = 0, fallosTotales = 0;
        let posMovil = { x: 50, y: 70 }, esVertical = true, juegoActivo = false;
        let cronoNivel = 0, timerId, tLimiteBase = 10;

        // --- FLUJO DE MEN√öS ---
        function prepararInstruccion(modo) {
            modoActual = modo;
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'flex';
            
            const title = document.getElementById('setup-title');
            const body = document.getElementById('setup-body');
            const config = document.getElementById('time-config');

            if(modo === 'entrenamiento') {
                title.innerText = "MODO CRONOMETRADO";
                body.innerHTML = "‚Ä¢ Busca la alineaci√≥n perfecta.<br>‚Ä¢ No hay l√≠mite de tiempo, pero registraremos tu rapidez.<br>‚Ä¢ <b>Arrastra la barra morada</b> con tu dedo.<br>‚Ä¢ Dale a confirmar cuando est√©s seguro.";
                config.style.display = 'none';
            } else {
                title.innerText = "MODO CONTRARELOJ";
                body.innerHTML = "‚Ä¢ Tienes un tiempo limitado para cada nivel.<br>‚Ä¢ Si la barra superior se agota, pierdes una vida.<br>‚Ä¢ El tiempo se reduce en cada nivel superado.";
                config.style.display = 'block';
            }
        }

        function iniciarMision() {
            tLimiteBase = parseInt(document.getElementById('time-slider').value);
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            document.getElementById('confirm-btn').style.display = 'block';
            document.getElementById('txt-paciente').innerText = localStorage.getItem('pacienteActual') || "Explorador";
            
            if(modoActual === 'contrareloj') document.getElementById('timer-container').style.display = 'block';
            juegoActivo = true;
            lanzarReto();
        }

        // --- L√ìGICA DE JUEGO ---
        function lanzarReto() {
            esVertical = Math.random() > 0.5;
            const fLine = document.getElementById('fixed-line');
            const mLine = document.getElementById('mobile-line');

            if(esVertical) {
                fLine.className = mLine.className = "line v-line";
                fLine.style.left = "50%"; fLine.style.top = "15%";
                posMovil = { x: Math.random() > 0.5 ? 20 : 80, y: 60 };
            } else {
                fLine.className = mLine.className = "line h-line";
                fLine.style.top = "35%"; fLine.style.left = "15%";
                posMovil = { x: 55, y: Math.random() > 0.5 ? 20 : 80 };
            }
            actualizarUIJugador();
            iniciarTiempo();
        }

        function iniciarTiempo() {
            clearInterval(timerId);
            cronoNivel = 0;
            if(modoActual === 'contrareloj') {
                let tiempoDisponible = Math.max(2.5, tLimiteBase - (nivel * 0.4));
                let tRestante = tiempoDisponible;
                timerId = setInterval(() => {
                    tRestante -= 0.1; cronoNivel += 0.1;
                    document.getElementById('timer-fill').style.width = (tRestante / tiempoDisponible * 100) + "%";
                    if(tRestante <= 0) { clearInterval(timerId); mostrarMensajeError("¬°TIEMPO AGOTADO!"); }
                }, 100);
            } else {
                timerId = setInterval(() => { cronoNivel += 0.1; }, 100);
            }
        }

        // --- ARRASTRE T√ÅCTIL ---
        let pulsado = false;
        const movLine = document.getElementById('mobile-line');

        const onStart = (e) => { if(juegoActivo) pulsado = true; };
        const onMove = (e) => {
            if(!pulsado || !juegoActivo) return;
            const ev = e.touches ? e.touches[0] : e;
            if(esVertical) posMovil.x = (ev.clientX / window.innerWidth) * 100;
            else posMovil.y = (ev.clientY / window.innerHeight) * 100;
            actualizarUIJugador();
        };
        const onEnd = () => pulsado = false;

        movLine.addEventListener('mousedown', onStart);
        movLine.addEventListener('touchstart', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove);
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('touchend', onEnd);

        function actualizarUIJugador() {
            movLine.style.left = posMovil.x + "%";
            movLine.style.top = posMovil.y + "%";
        }

        // --- VALIDACI√ìN Y ENV√çO ---
        function procesarConfirmacion() {
            if(!juegoActivo) return;
            clearInterval(timerId);
            
            let error = esVertical ? Math.abs(50 - posMovil.x) : Math.abs(35 - posMovil.y);
            let tolerancia = Math.max(0.08, 1.7 - (nivel * 0.18));

            if(error <= tolerancia) {
                audioClick.play();
                aciertosTotales++;
                juegoActivo = false;
                let perc = Math.min(100, (100 - (error * 8))).toFixed(1);
                document.getElementById('res-precision').innerText = perc + "%";
                document.getElementById('res-tiempo').innerText = cronoNivel.toFixed(2) + "s";
                document.getElementById('level-screen').style.display = 'flex';
            } else {
                mostrarMensajeError("¬°DESALINEADO!");
            }
        }

        function mostrarMensajeError(msg) {
            juegoActivo = false;
            audioError.play();
            const el = document.getElementById('game-msg');
            el.innerText = msg;
            el.classList.add('active');
            vidas--;
            document.getElementById('txt-vidas').innerText = "‚ù§Ô∏è".repeat(Math.max(0, vidas));
            fallosTotales++;

            setTimeout(() => {
                el.classList.remove('active');
                if(vidas <= 0) finalizarYEnviar();
                else { juegoActivo = true; lanzarReto(); }
            }, 1200);
        }

        function siguienteNivel() {
            nivel++;
            document.getElementById('txt-nivel').innerText = nivel;
            document.getElementById('level-screen').style.display = 'none';
            juegoActivo = true;
            lanzarReto();
        }

        function finalizarYEnviar() {
            clearInterval(timerId);
            const data = new FormData();
            data.append(ENTRIES.paciente, localStorage.getItem('pacienteActual') || "Anon");
            data.append(ENTRIES.juego, "Vernier PRO - " + modoActual);
            data.append(ENTRIES.nivel, nivel);
            data.append(ENTRIES.aciertos, aciertosTotales);
            data.append(ENTRIES.fallos, fallosTotales);
            data.append(ENTRIES.fecha, new Date().toISOString().split('T')[0]);
            
            fetch(FORM_URL, { method: 'POST', mode: 'no-cors', body: data });
            alert("MISI√ìN FINALIZADA\nNivel alcanzado: " + nivel);
            location.reload();
        }
    </script>
</body>
</html>
