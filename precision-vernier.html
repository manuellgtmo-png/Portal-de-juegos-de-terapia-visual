<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Vernier Precision Pro - Clinical Grade v4.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           ESTILOS GLOBALES Y VARIABLES DE DISEÑO
           ========================================= */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --purple-main: #a855f7;
            --purple-glow: rgba(168, 85, 247, 0.6);
            --green-success: #22c55e;
            --green-dark: #16a34a;
            --red-alert: #f43f5e;
            --slate-text: #94a3b8;
            --white-pure: #ffffff;
            --shadow-standard: 0 10px 30px rgba(0,0,0,0.5);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Reset Completo para Aplicaciones Táctiles */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            -webkit-user-select: none;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--white-pure);
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           SISTEMA DE HUD (INTERFAZ DE USUARIO)
           ========================================= */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 30px;
            display: none; /* Se activa mediante JS */
            justify-content: space-between;
            align-items: flex-start;
            z-index: 500;
            pointer-events: none;
        }

        .hud-widget {
            background: var(--bg-secondary);
            padding: 15px 25px;
            border-radius: 22px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: var(--shadow-standard);
            text-align: center;
            min-width: 120px;
            pointer-events: auto;
        }

        .hud-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 900;
            color: var(--slate-text);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .hud-value {
            font-size: 1.8rem;
            font-weight: 900;
        }

        /* Barra de Tiempo Superior */
        #time-track {
            position: absolute;
            top: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: 260px;
            height: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--bg-primary);
            display: none;
        }

        #time-fill {
            width: 100%;
            height: 100%;
            background: var(--red-alert);
            transition: width 0.1s linear;
        }

        /* =========================================
           ESCENARIO DE TRABAJO (VERNIR STAGE)
           ========================================= */
        #stage {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* Barras Redimensionadas para mayor complejidad visual */
        .vernier-bar {
            position: absolute;
            width: 10px; /* Reducción de ancho */
            height: 110px; /* Reducción de alto */
            border-radius: 40px;
            transform-origin: center center;
            will-change: transform;
        }

        #bar-fixed {
            background-color: #475569;
            z-index: 5;
            opacity: 0.9;
        }

        #bar-player {
            background-color: var(--purple-main);
            box-shadow: 0 0 30px var(--purple-glow);
            z-index: 20;
            cursor: grab;
        }

        #bar-player:active {
            cursor: grabbing;
            filter: brightness(1.2);
        }

        /* =========================================
           CONTROLES DE PRECISIÓN (OPCIONALES)
           ========================================= */
        #precision-pad {
            position: absolute;
            right: 25px;
            top: 55%;
            transform: translateY(-50%);
            display: none;
            flex-direction: column;
            gap: 12px;
            z-index: 600;
        }

        .pad-btn {
            width: 65px;
            height: 65px;
            background: var(--bg-secondary);
            border: 2px solid var(--purple-main);
            border-radius: 18px;
            color: white;
            font-weight: 900;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pad-btn:active {
            transform: scale(0.9);
            background: var(--purple-main);
        }

        /* =========================================
           OVERLAYS, MENÚS Y MODALES
           ========================================= */
        .full-screen-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 30px;
        }

        .card-modal {
            background: var(--bg-secondary);
            padding: 50px;
            border-radius: 50px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
        }

        /* Selectores de Configuración */
        .config-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            background: rgba(0,0,0,0.25);
            padding: 18px 25px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .custom-select {
            background: var(--bg-primary);
            color: white;
            border: 1px solid var(--purple-main);
            padding: 8px 15px;
            border-radius: 12px;
            font-weight: 700;
        }

        /* Botón de Acción Principal */
        #confirm-btn {
            position: absolute;
            bottom: 45px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 500px;
            height: 90px;
            background: var(--green-success);
            color: var(--bg-primary);
            border: none;
            border-radius: 45px;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 12px 0 var(--green-dark);
            z-index: 800;
            display: none;
            cursor: pointer;
            transition: all 0.1s;
        }

        #confirm-btn:active {
            transform: translateX(-50%) translateY(8px);
            box-shadow: 0 4px 0 var(--green-dark);
        }

        /* Pantalla de Resultados Final */
        #result-screen {
            display: none;
        }

        .accuracy-hero {
            font-size: 6rem;
            font-weight: 900;
            color: var(--purple-main);
            margin: 25px 0;
            text-shadow: 0 0 40px var(--purple-glow);
        }

        /* Switch UI */
        .ui-switch {
            position: relative;
            display: inline-block;
            width: 55px;
            height: 30px;
        }
        .ui-switch input { opacity: 0; width: 0; height: 0; }
        .ui-slider {
            position: absolute; cursor: pointer; inset: 0;
            background: #334155; transition: .4s; border-radius: 30px;
        }
        .ui-slider:before {
            position: absolute; content: ""; height: 22px; width: 22px;
            left: 4px; bottom: 4px; background: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .ui-slider { background: var(--purple-main); }
        input:checked + .ui-slider:before { transform: translateX(25px); }

    </style>
</head>
<body>

    <div id="overlay-main" class="full-screen-overlay">
        <div class="card-modal">
            <h1 style="color:var(--purple-main); font-size: 2.8rem; margin-bottom: 10px; font-weight: 900;">VERNIE PRO</h1>
            <p style="color:var(--slate-text); margin-bottom: 35px;">Terapia de Hiperagudeza Visual</p>
            
            <div class="config-box">
                <span style="font-weight: 700;">Modo Cronómetro</span>
                <label class="ui-switch">
                    <input type="checkbox" id="pref-time" checked>
                    <span class="ui-slider"></span>
                </label>
            </div>

            <div class="config-box" id="time-depth">
                <span style="font-weight: 700;">Segundos Iniciales</span>
                <select id="pref-seconds" class="custom-select">
                    <option value="15">15s - Principiante</option>
                    <option value="10" selected>10s - Estándar</option>
                    <option value="5">5s - Experto</option>
                    <option value="3">3s - Misión Imposible</option>
                </select>
            </div>

            <div class="config-box">
                <span style="font-weight: 700;">Controles de Precisión</span>
                <label class="ui-switch">
                    <input type="checkbox" id="pref-btns">
                    <span class="ui-slider"></span>
                </label>
            </div>

            <button onclick="bootGame()" style="background:var(--green-success); width:100%; padding:28px; border-radius:35px; border:none; font-weight:900; font-size:1.5rem; margin-top:25px; cursor:pointer; color:var(--bg-primary);">
                INICIAR SESIÓN
            </button>
        </div>
    </div>

    <div id="result-screen" class="full-screen-overlay">
        <div class="card-modal">
            <h2 id="result-title" style="color:var(--green-success); font-size: 2.5rem;">¡NIVEL COMPLETADO!</h2>
            <div class="accuracy-hero" id="accuracy-text">98%</div>
            <p id="result-desc" style="color:var(--slate-text); line-height: 1.6; margin-bottom: 40px;">Tu alineación vernier está dentro del rango terapéutico óptimo.</p>
            
            <button id="result-btn" onclick="handleFlow()" style="background:var(--green-success); width:100%; padding:25px; border-radius:30px; border:none; font-weight:900; font-size: 1.3rem; color:var(--bg-primary);">
                CONTINUAR
            </button>
        </div>
    </div>

    <div id="ui-layer">
        <div class="hud-widget">
            <span class="hud-label">Misión</span>
            <span id="val-lvl" class="hud-value">1</span>
        </div>
        
        <div id="time-track">
            <div id="time-fill"></div>
        </div>

        <div class="hud-widget">
            <span class="hud-label">Integridad</span>
            <span id="val-hp" class="hud-value">❤️❤️❤️</span>
        </div>
    </div>

    <div id="precision-pad">
        <button class="pad-btn" onclick="nudge('ang', -2)">↺</button>
        <button class="pad-btn" onclick="nudge('ang', 2)">↻</button>
        <button class="pad-btn" onclick="nudge('x', -0.5)">←</button>
        <button class="pad-btn" onclick="nudge('x', 0.5)">→</button>
    </div>

    <div id="stage">
        <div id="bar-fixed" class="vernier-bar"></div>
        <div id="bar-player" class="vernier-bar"></div>
        <button id="confirm-btn" onclick="executeEvaluation()">CONFIRMAR ALINEACIÓN</button>
    </div>

    <script>
        /* =========================================
           CONFIGURACIÓN DE DATOS (GOOGLE SHEETS)
           ========================================= */
        const GOOGLE_DATA_ENDPOINT = "TU_URL_DE_WEB_APP_AQUI"; // Debes pegar tu URL de Apps Script aquí
        
        // Objeto de Estado Maestro
        const session = {
            level: 1,
            lives: 3,
            isActive: false,
            useTime: true,
            useBtns: false,
            initialTime: 10,
            remainingTime: 10,
            timerClock: null,
            results: [],
            patientId: "Paciente_Alpha_" + Math.floor(Math.random()*9000)
        };

        // Coordenadas de las Barras
        let fixedState = { x: 50, y: 30, ang: 0 };
        let playerState = { x: 50, y: 70, ang: 0 };

        /* =========================================
           LÓGICA DE MOTOR DE JUEGO
           ========================================= */
        
        function bootGame() {
            // Captura de Preferencias
            session.useTime = document.getElementById('pref-time').checked;
            session.useBtns = document.getElementById('pref-btns').checked;
            session.initialTime = parseInt(document.getElementById('pref-seconds').value);
            
            // UI Switch
            document.getElementById('overlay-main').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            document.getElementById('confirm-btn').style.display = 'block';
            
            if(session.useBtns) document.getElementById('precision-pad').style.display = 'flex';
            if(session.useTime) document.getElementById('time-track').style.display = 'block';
            
            startNewLevel();
        }

        function startNewLevel() {
            session.isActive = true;
            
            // Generación de Posición Fija (Evitando HUD)
            fixedState.x = 30 + Math.random() * 40;
            fixedState.y = 25 + Math.random() * 15;
            
            // Progresión de Dificultad Rotacional
            if(session.level >= 5) {
                fixedState.ang = Math.floor(Math.random() * 360);
            } else if(session.level >= 2) {
                fixedState.ang = Math.random() > 0.5 ? 0 : 90;
            } else {
                fixedState.ang = 0;
            }

            // Reset de Barra del Jugador
            playerState.x = fixedState.x + (Math.random() > 0.5 ? 20 : -20);
            playerState.y = 65; // Mantenemos separación para Vernier Real
            playerState.ang = 0;

            refreshStage();
            if(session.useTime) launchTimer();
        }

        function refreshStage() {
            const fBar = document.getElementById('bar-fixed');
            const pBar = document.getElementById('bar-player');
            
            fBar.style.left = fixedState.x + "%";
            fBar.style.top = fixedState.y + "%";
            fBar.style.transform = `translate(-50%, -50%) rotate(${fixedState.ang}deg)`;

            pBar.style.left = playerState.x + "%";
            pBar.style.top = playerState.y + "%";
            pBar.style.transform = `translate(-50%, -50%) rotate(${playerState.ang}deg)`;
        }

        /* =========================================
           SISTEMA DE CONTROL (DRAG & TOUCH)
           ========================================= */
        let isDragging = false;
        let touchStartAng = 0;
        let playerStartAng = 0;
        const playerEl = document.getElementById('bar-player');

        // Soporte Multitouch
        window.addEventListener('touchstart', (e) => {
            if(!session.isActive) return;
            
            if(e.touches.length === 2) {
                isDragging = false;
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                touchStartAng = Math.atan2(dy, dx) * 180 / Math.PI;
                playerStartAng = playerState.ang;
            } else if(e.target === playerEl) {
                isDragging = true;
            }
        }, {passive: false});

        window.addEventListener('touchmove', (e) => {
            if(!session.isActive) return;

            if(e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const currentTouchAng = Math.atan2(dy, dx) * 180 / Math.PI;
                playerState.ang = playerStartAng + (currentTouchAng - touchStartAng);
                refreshStage();
            } else if(isDragging) {
                const touch = e.touches[0];
                playerState.x = (touch.clientX / window.innerWidth) * 100;
                // Bloqueo de eje Y para forzar alineación Vernier lateral
                refreshStage();
            }
            e.preventDefault();
        }, {passive: false});

        window.addEventListener('touchend', () => isDragging = false);

        // Control con Mouse / Rueda
        window.addEventListener('wheel', (e) => {
            if(!session.isActive) return;
            playerState.ang += e.deltaY > 0 ? 3 : -3;
            refreshStage();
        });

        function nudge(axis, val) {
            if(axis === 'x') playerState.x += val;
            if(axis === 'ang') playerState.ang += val;
            refreshStage();
        }

        /* =========================================
           EVALUACIÓN, RESULTADOS Y DATOS
           ========================================= */
        
        function executeEvaluation() {
            if(!session.isActive) return;
            clearInterval(session.timerClock);
            session.isActive = false;

            // 1. Cálculo de Error de Eje (Vernier Accuracy)
            const errorX = Math.abs(fixedState.x - playerState.x);
            
            // 2. Cálculo de Error Angular (Factor Rotacional)
            let errorAng = Math.abs((fixedState.ang % 180) - (playerState.ang % 180));
            if(errorAng > 90) errorAng = Math.abs(180 - errorAng);

            // 3. Score Algorítmico (Penalizaciones: X pesa más que Ang)
            const precisionFinal = Math.max(0, 100 - (errorX * 18 + errorAng * 3));
            
            // Lógica de éxito (Umbral del 88%)
            const isSuccess = precisionFinal >= 88;
            if(!isSuccess) session.lives--;

            displayScreen(isSuccess, precisionFinal);
            postDataToCloud(precisionFinal);
        }

        function displayScreen(success, score) {
            const screen = document.getElementById('result-screen');
            const title = document.getElementById('result-title');
            const text = document.getElementById('accuracy-text');
            const desc = document.getElementById('result-desc');
            const btn = document.getElementById('result-btn');

            screen.style.display = 'flex';
            text.innerText = score.toFixed(0) + "%";
            
            if(success) {
                title.innerText = "¡MISIÓN LOGRADA!";
                title.style.color = "var(--green-success)";
                desc.innerText = "Alineación y rotación perfectas. Estás listo para el siguiente desafío.";
                btn.innerText = "SIGUIENTE NIVEL";
            } else {
                title.innerText = "FUERA DE RANGO";
                title.style.color = "var(--red-alert)";
                desc.innerText = `Precisión insuficiente. Te quedan ${session.lives} vidas para completar la sesión.`;
                btn.innerText = session.lives > 0 ? "REINTENTAR" : "VER RESUMEN FINAL";
            }
        }

        function handleFlow() {
            document.getElementById('result-screen').style.display = 'none';
            if(session.lives <= 0) {
                alert("SESIÓN TERMINADA\nNivel Alcanzado: " + session.level);
                location.reload();
            } else {
                if(document.getElementById('result-title').innerText === "¡MISIÓN LOGRADA!") {
                    session.level++;
                }
                document.getElementById('val-lvl').innerText = session.level;
                document.getElementById('val-hp').innerText = "❤️".repeat(session.lives);
                startNewLevel();
            }
        }

        function launchTimer() {
            let limit = Math.max(2, session.initialTime - (session.level * 0.8));
            session.remainingTime = limit;
            const bar = document.getElementById('time-fill');
            
            clearInterval(session.timerClock);
            session.timerClock = setInterval(() => {
                session.remainingTime -= 0.1;
                bar.style.width = (session.remainingTime / limit * 100) + "%";
                if(session.remainingTime <= 0) {
                    executeEvaluation();
                }
            }, 100);
        }

        async function postDataToCloud(val) {
            const packet = {
                user: session.patientId,
                lvl: session.level,
                acc: val.toFixed(2),
                mode: session.useTime ? "Cronometrado" : "Libre",
                stamp: new Date().toLocaleString()
            };

            console.log("Enviando a Google Sheets:", packet);

            try {
                // Fetch modo 'no-cors' para evitar problemas de seguridad del navegador
                fetch(GOOGLE_DATA_ENDPOINT, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(packet)
                });
            } catch(e) { 
                console.error("Error de Red Cloud:", e); 
            }
        }

    </script>
</body>
</html>
