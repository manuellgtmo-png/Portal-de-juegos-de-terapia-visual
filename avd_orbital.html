<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Saccadic Orbital Tracking - Perceptum Medical System v4.6</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================================================================
           SISTEMA DE DISE√ëO PERCEPTUM - ARQUITECTURA COMPLETA
           ================================================================
        */
        :root {
            --perceptum-bg: #05080a;
            --perceptum-pink: #ff007f;
            --perceptum-pink-glow: rgba(255, 0, 127, 0.6);
            --perceptum-purple: #bc13fe;
            --perceptum-cyan: #00f2ff;
            --perceptum-success: #2ed573;
            --perceptum-error: #ff4757;
            --perceptum-panel: rgba(15, 25, 35, 0.98);
            
            /* Unidades Proporcionales */
            --header-height: 12vh;
            --node-diameter: 10vh; 
            --font-size-node: 3.5vh;
            --font-size-label: 1.3vh;
            --font-size-value: 3.8vh;
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: var(--perceptum-bg);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            color: #ffffff;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        /* ----------------------------------------------------------------
           CABECERA T√âCNICA (HEADER)
           ----------------------------------------------------------------
        */
        #p-header {
            height: var(--header-height);
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 6%;
            background: var(--perceptum-panel);
            border-bottom: 0.7vh solid var(--perceptum-pink);
            box-shadow: 0 1vh 4vh rgba(0,0,0,0.9);
            position: relative;
            z-index: 9999;
        }

        .p-stat-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 100px;
        }

        .p-stat-label {
            font-size: var(--font-size-label);
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: var(--perceptum-pink);
            font-weight: 800;
            margin-bottom: 0.4vh;
        }

        .p-stat-value {
            font-size: var(--font-size-value);
            font-weight: 900;
            text-shadow: 0 0 1.5vh var(--perceptum-pink-glow);
        }

        #p-lives {
            font-size: 4vh;
            letter-spacing: 1.2vw;
            filter: drop-shadow(0 0 1vh var(--perceptum-pink));
        }

        /* ----------------------------------------------------------------
           ZONA DE ENTRENAMIENTO (CANVAS)
           ----------------------------------------------------------------
        */
        #p-canvas {
            position: relative;
            width: 100%;
            height: calc(100vh - var(--header-height));
            background: 
                radial-gradient(circle at 50% 50%, #1a0b16 0%, #05080a 100%),
                linear-gradient(rgba(255, 0, 127, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 127, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 5vh 5vh, 5vh 5vh;
            overflow: hidden;
        }

        .p-node {
            position: absolute;
            width: var(--node-diameter);
            height: var(--node-diameter);
            background: #0a0a1a;
            border: 0.5vh solid var(--perceptum-pink);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: var(--font-size-node);
            box-shadow: 0 0 2vh var(--perceptum-pink-glow);
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.17, 0.88, 0.32, 1.28), opacity 0.3s ease;
        }

        .p-node.hit {
            border-color: var(--perceptum-cyan);
            box-shadow: 0 0 5vh var(--perceptum-cyan);
            transform: scale(1.6);
            opacity: 0;
            pointer-events: none;
        }

        /* ----------------------------------------------------------------
           MODALES INTEGRALES
           ----------------------------------------------------------------
        */
        .p-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(20px);
        }

        .p-modal {
            background: #0f1923;
            width: 90%;
            max-width: 600px;
            padding: 5vh;
            border-radius: 4vh;
            border: 0.7vh solid var(--perceptum-pink);
            text-align: center;
            box-shadow: 0 0 8vh rgba(255, 0, 127, 0.4);
        }

        .p-modal h1 {
            font-size: 4.5vh;
            color: var(--perceptum-pink);
            margin-bottom: 2vh;
            font-weight: 900;
            text-transform: uppercase;
        }

        .p-modal p {
            font-size: 2vh;
            color: #ccc;
            margin-bottom: 4vh;
            line-height: 1.5;
        }

        .p-mode-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2vh;
            margin-bottom: 4vh;
        }

        .p-mode-card {
            background: #1a2632;
            border: 0.3vh solid #3e4859;
            padding: 2.5vh;
            border-radius: 2.5vh;
            cursor: pointer;
            transition: 0.3s;
        }

        .p-mode-card.active {
            border-color: var(--perceptum-pink);
            background: rgba(255, 0, 127, 0.15);
        }

        .p-btn {
            background: linear-gradient(135deg, var(--perceptum-pink), var(--perceptum-purple));
            color: white;
            padding: 2.5vh;
            border-radius: 2.5vh;
            border: none;
            width: 100%;
            font-size: 3vh;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 1vh 3vh rgba(0,0,0,0.5);
        }

        .p-btn-next {
            background: var(--perceptum-success);
        }

        .p-flash-fail {
            background-color: var(--perceptum-error) !important;
        }

        #p-timer-config {
            background: rgba(0,0,0,0.3);
            padding: 2vh;
            border-radius: 2vh;
            margin-bottom: 3vh;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--perceptum-pink);
            margin-top: 1.5vh;
        }
    </style>
</head>
<body onmousedown="triggerMiss(event)">

    <header id="p-header">
        <div class="p-stat-box">
            <span class="p-stat-label">Nivel</span>
            <span id="p-lvl-val" class="p-stat-value">1</span>
        </div>
        <div id="p-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="p-stat-box">
            <span class="p-stat-label" id="p-timer-label">Modo Libre</span>
            <span id="p-timer-val" class="p-stat-value">--</span>
        </div>
    </header>

    <div id="p-canvas"></div>

    <div id="p-modal-intro" class="p-overlay">
        <div class="p-modal">
            <h1>Saccadic Orbital</h1>
            <p>Protocolo de Seguimiento Din√°mico. Capture los objetivos en secuencia num√©rica.</p>
            <div class="p-mode-grid">
                <div class="p-mode-card active" id="p-m-free" onclick="updateMode('libre')">
                    <h3 style="font-size: 2vh; color: var(--perceptum-pink);">LIBRE</h3>
                </div>
                <div class="p-mode-card" id="p-m-flash" onclick="updateMode('flash')">
                    <h3 style="font-size: 2vh; color: var(--perceptum-pink);">FLASH</h3>
                </div>
            </div>
            <div id="p-timer-config" style="display: none;">
                <label style="font-size: 1.8vh;">TIEMPO: <span id="p-range-txt" style="color:var(--perceptum-pink)">20</span>s</label>
                <input type="range" id="p-range-input" min="10" max="60" value="20" oninput="document.getElementById('p-range-txt').innerText=this.value">
            </div>
            <button class="p-btn" onclick="startExecution()">Iniciar Protocolo</button>
        </div>
    </div>

    <div id="p-modal-next" class="p-overlay" style="display: none;">
        <div class="p-modal" style="border-color: var(--perceptum-success);">
            <h1 style="color: var(--perceptum-success);">¬°LOGRADO!</h1>
            <p>Se ha validado el control orbital. ¬øContinuar al siguiente nivel?</p>
            <button class="p-btn p-btn-next" onclick="goToNextLevel()">Siguiente Nivel</button>
        </div>
    </div>

    <div id="p-modal-end" class="p-overlay" style="display: none;">
        <div class="modal-container p-modal">
            <h1 style="color: var(--perceptum-error);">FIN DE SESI√ìN</h1>
            <div style="margin: 3vh 0;">
                <p style="font-size: 3vh;">Nivel: <span id="p-res-lvl" style="color:var(--perceptum-pink); font-weight:900;">1</span></p>
                <p style="font-size: 3vh;">Aciertos: <span id="p-res-hits" style="color:var(--perceptum-cyan); font-weight:900;">0</span></p>
            </div>
            <p id="p-sync-txt" style="color: var(--perceptum-cyan); font-weight: 800; font-size: 1.8vh;">SINCRONIZANDO CON GOOGLE SHEETS...</p>
            <button class="p-btn" onclick="location.reload()" style="margin-top: 2vh;">Reintentar</button>
        </div>
    </div>

    <script>
        /* ================================================================
           MOTOR L√ìGICO COMPLETO - v4.6 (PROGRESIVO)
           ================================================================
        */

        const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const ENTRY_IDS = {
            paciente: "entry.369874016",
            juego: "entry.1353470174",
            nivel: "entry.721051298",
            aciertos: "entry.873272199",
            fallos: "entry.1030094511",
            tiempo: "entry.1303309812",
            fecha: "entry.845098414"
        };

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let currentLvl = 1;
        let currentLives = 3;
        let currentTargetId = 1;
        let sessionHits = 0;
        let sessionFails = 0;
        let isRunning = false;
        let sessionMode = 'libre';
        let timerLimit = 20;
        let timerClock = null;
        let nodesCollection = [];

        function playMedicalSound(freq, type, dur, vol) {
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                gain.gain.setValueAtTime(vol, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + dur);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start();
                osc.stop(audioContext.currentTime + dur);
            } catch(e) {}
        }

        function updateMode(m) {
            sessionMode = m;
            document.getElementById('p-m-free').classList.toggle('active', m === 'libre');
            document.getElementById('p-m-flash').classList.toggle('active', m === 'flash');
            document.getElementById('p-timer-config').style.display = (m === 'flash') ? 'block' : 'none';
            document.getElementById('p-timer-label').innerText = (m === 'flash') ? "Reloj" : "Modo Libre";
        }

        function startExecution() {
            if (audioContext.state === 'suspended') audioContext.resume();
            if (sessionMode === 'flash') timerLimit = parseInt(document.getElementById('p-range-input').value);
            document.getElementById('p-modal-intro').style.display = 'none';
            isRunning = true;
            renderLevel();
        }

        function renderLevel() {
            if (!isRunning) return;
            const canvas = document.getElementById('p-canvas');
            canvas.innerHTML = '';
            nodesCollection = [];
            currentTargetId = 1;
            
            const nodesToSpawn = 2 + currentLvl; 

            for (let i = 1; i <= nodesToSpawn; i++) {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'p-node';
                nodeDiv.innerText = i;

                // AJUSTE DE VELOCIDAD SUAVE: Base 0.003 + incremento de 0.0003 por nivel
                const baseSpeed = 0.003;
                const increment = (currentLvl - 1) * 0.0003; 
                const finalSpeed = (baseSpeed + increment) * (Math.random() > 0.5 ? 1 : -1);

                const nodeData = {
                    dom: nodeDiv,
                    id: i,
                    angle: Math.random() * (Math.PI * 2),
                    speed: finalSpeed,
                    radiusX: (window.innerWidth * 0.18) + Math.random() * (window.innerWidth * 0.15),
                    radiusY: (window.innerHeight * 0.12) + Math.random() * (window.innerHeight * 0.15),
                    centerX: window.innerWidth / 2,
                    centerY: (window.innerHeight - (window.innerHeight * 0.12)) / 2
                };

                nodeDiv.onmousedown = (e) => {
                    e.stopPropagation();
                    handleNodeClick(nodeData);
                };

                canvas.appendChild(nodeDiv);
                nodesCollection.push(nodeData);
            }

            if (sessionMode === 'flash') startTimerSystem();
            requestAnimationFrame(physicsLoop);
        }

        function physicsLoop() {
            if (!isRunning) return;
            nodesCollection.forEach(node => {
                node.angle += node.speed;
                const posX = node.centerX + Math.cos(node.angle) * node.radiusX - (node.dom.offsetWidth / 2);
                const posY = node.centerY + Math.sin(node.angle) * node.radiusY - (node.dom.offsetHeight / 2);
                node.dom.style.left = posX + 'px';
                node.dom.style.top = posY + 'px';
            });
            requestAnimationFrame(physicsLoop);
        }

        function handleNodeClick(node) {
            if (node.id === currentTargetId) {
                playMedicalSound(800, 'sine', 0.2, 0.1);
                node.dom.classList.add('hit');
                sessionHits++;
                currentTargetId++;
                if (currentTargetId > nodesCollection.length) {
                    processWin();
                }
            } else {
                processFail();
            }
        }

        function triggerMiss(e) {
            if (isRunning && !e.target.classList.contains('p-node')) {
                processFail();
            }
        }

        function processFail() {
            playMedicalSound(150, 'sawtooth', 0.4, 0.2);
            currentLives--;
            sessionFails++;
            document.body.classList.add('p-flash-fail');
            setTimeout(() => document.body.classList.remove('p-flash-fail'), 150);
            document.getElementById('p-lives').innerText = (currentLives > 0) ? "‚ù§Ô∏è".repeat(currentLives) : "üíÄ";
            if (currentLives <= 0) {
                processGameOver();
            } else {
                renderLevel();
            }
        }

        function startTimerSystem() {
            clearInterval(timerClock);
            let timeRemains = timerLimit;
            document.getElementById('p-timer-val').innerText = timeRemains + "s";
            timerClock = setInterval(() => {
                timeRemains--;
                document.getElementById('p-timer-val').innerText = timeRemains + "s";
                if (timeRemains <= 0) {
                    clearInterval(timerClock);
                    processFail();
                }
            }, 1000);
        }

        function processWin() {
            isRunning = false;
            clearInterval(timerClock);
            playMedicalSound(1000, 'sine', 0.5, 0.1);
            document.getElementById('p-modal-next').style.display = 'flex';
        }

        function goToNextLevel() {
            currentLvl++;
            document.getElementById('p-lvl-val').innerText = currentLvl;
            document.getElementById('p-modal-next').style.display = 'none';
            if (currentLvl % 4 === 0 && currentLives < 3) {
                currentLives++;
                document.getElementById('p-lives').innerText = "‚ù§Ô∏è".repeat(currentLives);
            }
            isRunning = true;
            renderLevel();
        }

        function processGameOver() {
            isRunning = false;
            clearInterval(timerClock);
            document.getElementById('p-res-lvl').innerText = currentLvl;
            document.getElementById('p-res-hits').innerText = sessionHits;
            document.getElementById('p-modal-end').style.display = 'flex';
            sendDataToGoogle();
        }

        function sendDataToGoogle() {
            const dateStr = new Date().toISOString().split('T')[0];
            const formData = new FormData();
            formData.append(ENTRY_IDS.paciente, "PACIENTE_PERCEPTUM_ORBITAL");
            formData.append(ENTRY_IDS.juego, "Saccadic_Orbital_v4.6_Final");
            formData.append(ENTRY_IDS.nivel, currentLvl);
            formData.append(ENTRY_IDS.aciertos, sessionHits);
            formData.append(ENTRY_IDS.fallos, sessionFails);
            formData.append(ENTRY_IDS.tiempo, sessionMode === 'flash' ? timerLimit + "s" : "Libre");
            formData.append(ENTRY_IDS.fecha, dateStr);

            fetch(GOOGLE_FORM_ACTION, {
                method: "POST",
                mode: "no-cors",
                body: formData
            }).then(() => {
                document.getElementById('p-sync-txt').innerText = "‚úÖ CONEXI√ìN EXITOSA CON PERCEPTUM CLOUD";
                document.getElementById('p-sync-txt').style.color = "var(--perceptum-success)";
            }).catch(() => {
                document.getElementById('p-sync-txt').innerText = "‚ö†Ô∏è ERROR DE SINCRONIZACI√ìN";
                document.getElementById('p-sync-txt').style.color = "var(--perceptum-error)";
            });
        }
    </script>
</body>
</html>
