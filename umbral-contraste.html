<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Umbral de Contraste - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; background: #f8fafc; color: #1e293b; 
            font-family: 'Montserrat', sans-serif; overflow: hidden; touch-action: none; 
        }
        
        /* INTERFAZ ESTILO PERCEPTUM */
        #intro-screen, #result-screen, #sync-screen, #pause-screen { 
            position: fixed; inset: 0; background: rgba(30, 41, 59, 0.95); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 30px; text-align: center; z-index: 200; 
        }

        .card { 
            background: white; padding: 40px; border-radius: 40px; 
            max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); 
        }
        
        .habilidades-box { 
            background: #f0fdfa; border: 2px dashed #06b6d4; color: #0891b2; 
            padding: 15px; border-radius: 20px; font-size: 0.9rem; margin: 20px 0; 
        }
        
        button { 
            background: #06b6d4; color: white; border: none; padding: 20px 50px; 
            border-radius: 60px; font-size: 1.4rem; cursor: pointer; font-weight: 900; 
            text-transform: uppercase; box-shadow: 0 10px 0 #0891b2; transition: all 0.1s; width: 100%; 
        }
        button:active { transform: translateY(5px); box-shadow: 0 5px 0 #0891b2; }

        /* HUD */
        #ui-layer { 
            position: absolute; top: 0; width: 100%; padding: 20px; 
            display: flex; justify-content: space-between; box-sizing: border-box; 
            z-index: 100; display: none; 
        }
        .stat-box { 
            background: white; padding: 12px 20px; border-radius: 20px; 
            font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; min-width: 80px; 
        }
        .label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }

        /* √ÅREA DE JUEGO */
        #game-area { width: 100vw; height: 100vh; position: relative; cursor: crosshair; }
        #target { 
            position: absolute; width: 120px; height: 120px; 
            cursor: pointer; transition: opacity 0.3s;
            display: none;
        }

        /* BARRA DE PROGRESO */
        #prog-container { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            width: 70%; height: 12px; background: #e2e8f0; border-radius: 10px; overflow: hidden; 
        }
        #prog-fill { width: 0%; height: 100%; background: #06b6d4; transition: width 0.3s; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div class="card">
            <h1 style="margin:0; font-size: 2rem; color: #0891b2;">üëÅÔ∏è Umbral de Contraste</h1>
            <div class="habilidades-box">
                <strong>üéØ Objetivo:</strong> Detectar figuras con bajo contraste. <br>
                Mide la sensibilidad retiniana y calidad visual.
            </div>
            <p>Toca la figura antes de que desaparezca. ¬°Cada nivel ser√° m√°s dif√≠cil de ver!</p>
            <button onclick="iniciarJuego()">COMENZAR PRUEBA</button>
        </div>
    </div>

    <div id="sync-screen" style="display: none;">
        <div class="card"><h2>Sincronizando...</h2><p>Enviando resultados al expediente cl√≠nico.</p></div>
    </div>

    <div id="result-screen" style="display: none;">
        <div class="card">
            <h2 id="result-title">Sesi√≥n Completada</h2>
            <p id="result-text" style="color: #64748b;"></p>
            <button id="next-btn" onclick="location.reload()">REPETIR PRUEBA</button>
            <a href="index.html" style="display:block; margin-top:20px; color:#06b6d4; text-decoration:none; font-weight:bold;">VOLVER AL PANEL</a>
        </div>
    </div>

    <div id="ui-layer">
        <div class="stat-box"><span class="label">Nivel</span><span id="txt-nivel">1</span></div>
        <div class="stat-box"><span class="label">Contraste</span><span id="txt-contraste">100%</span></div>
        <div class="stat-box"><span class="label">Vidas</span><span id="txt-vidas">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <div id="game-area">
        <img src="https://cdn-icons-png.flaticon.com/512/5258/5258212.png" id="target" onclick="clickTarget()">
    </div>

    <div id="prog-container"><div id="prog-fill"></div></div>

    <script>
        const target = document.getElementById('target');
        const audioWin = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
        const audioClick = new Audio('https://assets.mixkit.co/active_storage/sfx/610/610-preview.mp3');

        // Configuraci√≥n Google Sheets
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const ENTRIES = { paciente: "entry.369874016", juego: "entry.1353470174", nivel: "entry.721051298", aciertos: "entry.873272199", fallos: "entry.1030094511", tiempo: "entry.1303309812", fecha: "entry.845098414" };

        let nivel = 1, vidas = 3, aciertos = 0, fallos = 0, opacidad = 1.0;
        let juegoActivo = false, timer;

        function iniciarJuego() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            juegoActivo = true;
            aparecerTarget();
        }

        function aparecerTarget() {
            if(!juegoActivo) return;
            
            // L√≥gica de opacidad: Baja 10% por nivel
            opacidad = Math.max(0.05, 1.1 - (nivel * 0.1));
            target.style.opacity = opacidad;
            document.getElementById('txt-contraste').innerText = Math.round(opacidad * 100) + "%";
            document.getElementById('txt-nivel').innerText = nivel;

            // Posici√≥n aleatoria respetando m√°rgenes
            const padding = 150;
            const x = Math.random() * (window.innerWidth - padding * 2) + padding;
            const y = Math.random() * (window.innerHeight - padding * 2) + padding;
            
            target.style.left = x + 'px';
            target.style.top = y + 'px';
            target.style.display = 'block';

            // Tiempo l√≠mite para tocar (se vuelve m√°s corto cada nivel)
            const tiempoLimite = Math.max(800, 3000 - (nivel * 200));
            clearTimeout(timer);
            timer = setTimeout(perderVida, tiempoLimite);
        }

        function clickTarget() {
            if(!juegoActivo) return;
            clearTimeout(timer);
            aciertos++;
            audioClick.play();
            
            // Efecto de brillo al acertar
            target.style.filter = "drop-shadow(0 0 20px #06b6d4)";
            setTimeout(() => {
                target.style.filter = "none";
                target.style.display = 'none';
                if(aciertos % 3 === 0) nivel++; // Sube nivel cada 3 aciertos
                actualizarProgreso();
                aparecerTarget();
            }, 200);
        }

        function perderVida() {
            fallos++;
            vidas--;
            document.getElementById('txt-vidas').innerText = "‚ù§Ô∏è".repeat(vidas);
            if(vidas <= 0) {
                finalizarJuego();
            } else {
                aparecerTarget();
            }
        }

        function actualizarProgreso() {
            const prog = (aciertos % 3) / 3 * 100;
            document.getElementById('prog-fill').style.width = prog + "%";
        }

        function finalizarJuego() {
            juegoActivo = false;
            target.style.display = 'none';
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('sync-screen').style.display = 'flex';

            const nombre = localStorage.getItem('paciente') || "An√≥nimo";
            const data = new FormData();
            data.append(ENTRIES.paciente, nombre);
            data.append(ENTRIES.juego, "Umbral de Contraste");
            data.append(ENTRIES.nivel, nivel);
            data.append(ENTRIES.aciertos, aciertos);
            data.append(ENTRIES.fallos, fallos);
            data.append(ENTRIES.tiempo, "N/A");
            data.append(ENTRIES.fecha, new Date().toISOString().split('T')[0]);

            fetch(FORM_URL, { method: 'POST', mode: 'no-cors', body: data });

            setTimeout(() => {
                document.getElementById('sync-screen').style.display = 'none';
                document.getElementById('result-screen').style.display = 'flex';
                document.getElementById('result-text').innerText = `Llegaste al nivel ${nivel} con un contraste del ${Math.round(opacidad*100)}%.`;
            }, 2000);
        }
    </script>
</body>
</html>
