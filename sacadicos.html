<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sac√°dicos Voice Ultra V2 - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --acc: #a855f7; --txt: #f8fafc; --success: #10b981; --danger: #ef4444; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--txt); height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        
        .screen { background: rgba(30, 41, 59, 0.98); padding: 3rem; border-radius: 3rem; border: 5px solid var(--acc); text-align: center; width: 90%; max-width: 800px; z-index: 100; display: none; box-shadow: 0 0 80px rgba(168, 85, 247, 0.5); }
        .active { display: block; animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.98); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        h1 { font-size: 3.5rem; color: var(--acc); margin-bottom: 2rem; text-transform: uppercase; line-height: 1; }
        p { font-size: 1.8rem; line-height: 1.4; margin-bottom: 2rem; }
        
        .config-box { background: rgba(0,0,0,0.4); padding: 2rem; border-radius: 2rem; margin-top: 1rem; border: 2px solid rgba(255,255,255,0.1); }
        .config-group { margin-bottom: 2rem; text-align: left; }
        .config-group label { display: block; font-size: 1.5rem; margin-bottom: 1rem; color: var(--success); font-weight: 900; }
        input[type="range"] { width: 100%; height: 20px; accent-color: var(--acc); cursor: pointer; }
        
        .hud { position: absolute; top: 1rem; width: 100%; display: flex; justify-content: space-around; font-weight: 900; font-size: 2rem; z-index: 50; text-shadow: 3px 3px 6px #000; pointer-events: none; }
        
        #game-area { display: none; width: 100vw; height: 100vh; position: relative; background: var(--bg); }
        .stimulus { position: absolute; font-size: var(--sz); color: var(--acc); transform: translate(-50%, -50%); filter: drop-shadow(0 0 25px var(--acc)); font-weight: 900; z-index: 60; }
        
        .btn { background: var(--success); color: #000; border: none; padding: 2rem; border-radius: 1.5rem; font-weight: 900; font-size: 2rem; cursor: pointer; width: 100%; margin-top: 1.5rem; transition: 0.2s; box-shadow: 0 10px 0 #059669; text-transform: uppercase; }
        .btn:active { transform: translateY(5px); box-shadow: 0 5px 0 #059669; }
        
        .summary-item { font-size: 2.5rem; margin: 1.5rem 0; padding: 2rem; background: rgba(255,255,255,0.05); border-radius: 1.5rem; border-left: 15px solid var(--acc); text-align: left; }
    </style>
</head>
<body>

    <div class="hud" id="hud" style="display:none">
        <div>SESI√ìN: <span id="h-ses" style="color:var(--success)">1</span></div>
        <div>NIVEL: <span id="h-lvl" style="color:var(--acc)">1</span></div>
        <div>TIEMPO: <span id="h-time" style="color:#fff">00</span></div>
        <div>VIDAS: <span id="h-lives" style="color:var(--danger)">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <div id="s-intro" class="screen active">
        <h1>INSTRUCCIONES</h1>
        <p>Sit√∫ate a <b>40 cm</b> de la pantalla.<br><br>Nombra los n√∫meros y letras que aparezcan lo m√°s r√°pido posible.</p>
        <button class="btn" onclick="nextStep('s-intro', 's-config')">CONTINUAR</button>
    </div>

    <div id="s-config" class="screen">
        <h1>AJUSTES</h1>
        <div class="config-box">
            <div class="config-group">
                <label>Tiempo de Ejercicio (Nivel): <b id="v-work">30s</b></label>
                <input type="range" id="i-work" min="10" max="120" step="10" value="30" oninput="document.getElementById('v-work').innerText = this.value + 's'">
            </div>
            <div class="config-group">
                <label>Tiempo de Descanso: <b id="v-rest">10s</b></label>
                <input type="range" id="i-rest" min="5" max="60" step="5" value="10" oninput="document.getElementById('v-rest').innerText = this.value + 's'">
            </div>
            <div class="config-group">
                <label>N√∫mero de Sesiones Totales: <b id="v-cycles">3</b></label>
                <input type="range" id="i-cycles" min="1" max="15" value="3" oninput="document.getElementById('v-cycles').innerText = this.value">
            </div>
        </div>
        <button class="btn" onclick="initVoice()">INICIAR FUEGO!</button>
    </div>

    <div id="s-rest" class="screen">
        <h1 style="color:var(--success)">DESCANSO</h1>
        <p>Relaja los ojos y parpadea...</p>
        <div id="rest-timer" style="font-size: 8rem; font-weight: 900; color: var(--acc);">10</div>
    </div>

    <div id="game-area"></div>

    <div id="s-end" class="screen">
        <h1 id="end-title">RESULTADOS</h1>
        <div id="summary"></div>
        <button class="btn" onclick="location.reload()">REPETIR TODO</button>
    </div>

    <script>
        let level = 1, lives = 3, currentVal = "", currentSession = 1;
        let workTime, restTime, totalSessions;
        let recognition, timerInt, restInt, failTimer;
        let stats = { hits: 0, errors: 0 };
        const stimuli = "123456789ABCDEFHKMNPRTUVWXY";

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, dur) {
            try {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + dur);
            } catch(e) {}
        }

        function nextStep(hide, show) {
            document.getElementById(hide).classList.remove('active');
            document.getElementById(show).classList.add('active');
        }

        function initVoice() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) return alert("Usa Google Chrome.");
            
            workTime = parseInt(document.getElementById('i-work').value);
            restTime = parseInt(document.getElementById('i-rest').value);
            totalSessions = parseInt(document.getElementById('i-cycles').value);

            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                nextStep('s-config', 'game-area');
                startLevel();
            };

            recognition.onresult = (e) => {
                let transcript = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    transcript += e.results[i][0].transcript.toUpperCase();
                }
                checkMatch(transcript);
            };

            recognition.onend = () => { if(lives > 0 && currentSession <= totalSessions) recognition.start(); };
            recognition.start();
        }

        function startLevel() {
            clearInterval(restInt);
            document.getElementById('s-rest').classList.remove('active');
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('hud').style.display = 'flex';
            updateHUD();
            
            let timeLeft = workTime;
            document.getElementById('h-time').innerText = timeLeft;
            
            timerInt = setInterval(() => {
                timeLeft--;
                document.getElementById('h-time').innerText = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(timerInt);
                    if(currentSession >= totalSessions) endGame("OBJETIVO CUMPLIDO");
                    else showRest();
                }
            }, 1000);
            spawn();
        }

        function spawn() {
            clearTimeout(failTimer); // Limpiamos cualquier timer previo para evitar bloqueos
            const area = document.getElementById('game-area');
            area.innerHTML = '';
            currentVal = stimuli[Math.floor(Math.random() * stimuli.length)];
            
            const stim = document.createElement('div');
            stim.className = 'stimulus';
            stim.id = "active-stim";
            stim.innerText = currentVal;
            
            const m = Math.max(2, 22 - level);
            stim.style.left = `${Math.random() * (100 - 2*m) + m}%`;
            stim.style.top = `${Math.random() * (75 - m) + m + 5}%`;
            stim.style.setProperty('--sz', `${Math.max(70, 160 - level*4)}px`);
            
            area.appendChild(stim);
            
            // Tiempo de reacci√≥n: empieza m√°s r√°pido y baja seg√∫n nivel
            const reactionTime = Math.max(800, 4500 - (level * 400));
            failTimer = setTimeout(() => handleFailure(), reactionTime);
        }

        function checkMatch(text) {
            const dict = { "UNO":"1","DOS":"2","TRES":"3","EQUIS":"X","EKIS":"X","CE":"C","SE":"C","SI":"C","HACE":"C","B√â":"B","VE":"B" };
            let match = text.includes(currentVal);
            for(let k in dict) if(text.includes(k) && dict[k] === currentVal) match = true;
            if(match) handleSuccess();
        }

        function handleSuccess() {
            const el = document.getElementById('active-stim');
            if(!el) return;
            el.remove(); // Eliminaci√≥n inmediata para sensaci√≥n de velocidad
            clearTimeout(failTimer);
            playTone(900, 'sine', 0.05);
            stats.hits++;
            
            // Peque√±o delay de 50ms para que el ojo no se canse pero se sienta instant√°neo
            setTimeout(spawn, 50); 
        }

        function handleFailure() {
            // Evitamos que se pegue: pausamos todo antes de descontar vida
            clearTimeout(failTimer);
            playTone(150, 'square', 0.2);
            lives--;
            stats.errors++;
            updateHUD();
            
            if(lives <= 0) {
                endGame("SIN VIDAS RESTANTES");
            } else {
                // Reiniciamos el spawn tras un peque√±o parpadeo rojo de aviso
                const area = document.getElementById('game-area');
                area.style.background = "rgba(239, 68, 68, 0.2)";
                setTimeout(() => {
                    area.style.background = var(--bg);
                    spawn();
                }, 300);
            }
        }

        function showRest() {
            clearTimeout(failTimer);
            clearInterval(timerInt);
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('s-rest').classList.add('active');
            let c = restTime;
            document.getElementById('rest-timer').innerText = c;
            restInt = setInterval(() => {
                c--;
                document.getElementById('rest-timer').innerText = c;
                if(c <= 0) {
                    currentSession++;
                    level++;
                    startLevel();
                }
            }, 1000);
        }

        function updateHUD() {
            document.getElementById('h-ses').innerText = currentSession;
            document.getElementById('h-lvl').innerText = level;
            document.getElementById('h-lives').innerText = "‚ù§Ô∏è".repeat(Math.max(0, lives));
        }

        function endGame(reason) {
            clearInterval(timerInt);
            clearInterval(restInt);
            clearTimeout(failTimer);
            try { recognition.stop(); } catch(e) {}
            
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('hud').style.display = 'none';
            
            const endScreen = document.getElementById('s-end');
            endScreen.classList.add('active');
            
            document.getElementById('summary').innerHTML = `
                <div class="summary-item">üéØ ACIERTOS: ${stats.hits}</div>
                <div class="summary-item">‚ùå ERRORES: ${stats.errors}</div>
                <div class="summary-item">üöÄ NIVEL MAX: ${level}</div>
                <div class="summary-item" style="border-color:var(--success)">üìè DISTANCIA: 40 cm</div>
            `;
        }
    </script>
</body>
</html>
