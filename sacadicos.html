<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sac√°dicos Voice Elite - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --acc: #a855f7; --txt: #f8fafc; --success: #10b981; --danger: #ef4444; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--txt); height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        
        /* UI Adaptativa */
        .screen { background: rgba(30, 41, 59, 0.98); padding: 2rem; border-radius: 2rem; border: 3px solid var(--acc); text-align: center; width: 85%; max-width: 500px; z-index: 100; display: none; box-shadow: 0 0 50px rgba(168, 85, 247, 0.3); }
        .active { display: block; animation: zoomIn 0.3s ease; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        h1 { font-size: 1.8rem; color: var(--acc); margin-bottom: 1rem; }
        p { font-size: 1.1rem; line-height: 1.4; }
        
        .config-group { margin: 1.5rem 0; text-align: left; }
        input[type="range"] { width: 100%; accent-color: var(--acc); cursor: pointer; }
        
        .hud { position: absolute; top: 1rem; width: 100%; display: flex; justify-content: space-around; font-weight: 900; font-size: 1.2rem; z-index: 50; pointer-events: none; }
        
        #game-area { display: none; width: 100vw; height: 100vh; position: relative; }
        .stimulus { position: absolute; font-size: var(--sz); color: var(--acc); transform: translate(-50%, -50%); filter: drop-shadow(0 0 15px var(--acc)); cursor: pointer; transition: color 0.1s; }
        .stimulus.warning { color: var(--danger); animation: shake 0.1s infinite; }
        @keyframes shake { 0%, 100% { transform: translate(-50%, -50%) rotate(0); } 25% { transform: translate(-50%, -50%) rotate(3deg); } 75% { transform: translate(-50%, -50%) rotate(-3deg); } }

        .btn { background: var(--success); color: #000; border: none; padding: 1.2rem; border-radius: 1rem; font-weight: 900; font-size: 1.2rem; cursor: pointer; width: 100%; margin-top: 1rem; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .mic-tag { font-size: 0.9rem; margin-top: 10px; color: var(--success); font-weight: bold; min-height: 1.2em; }
    </style>
</head>
<body>

    <div class="hud" id="hud" style="display:none">
        <div>NIVEL: <span id="h-lvl" style="color:var(--acc)">1</span></div>
        <div>TIEMPO: <span id="h-time" style="color:var(--success)">00:00</span></div>
        <div>VIDAS: <span id="h-lives" style="color:var(--danger)">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
    </div>

    <div id="s-intro" class="screen active">
        <h1>VOICE ELITE</h1>
        <p>Entrenamiento sac√°dico avanzado a <b>40 cm</b>.</p>
        
        <div class="config-group">
            <label>Tiempo de Sesi√≥n: <b id="v-work">2 min</b></label>
            <input type="range" id="i-work" min="1" max="10" value="2" oninput="document.getElementById('v-work').innerText = this.value + ' min'">
        </div>

        <div class="config-group" style="font-size: 0.9rem; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
            üó£Ô∏è Di el nombre del n√∫mero o letra.<br>
            ‚ö†Ô∏è Pierdes vida si te equivocas o tardas mucho.<br>
            üöÄ A mayor nivel, los saltos son m√°s extremos.
        </div>

        <button class="btn" onclick="initVoice()">INICIAR ENTRENAMIENTO</button>
        <div id="mic-status" class="mic-tag">Esperando micr√≥fono...</div>
    </div>

    <div id="s-rest" class="screen">
        <h1 style="color:var(--success)">¬°NIVEL COMPLETADO!</h1>
        <p>Descansa la vista unos segundos.</p>
        <div id="rest-timer" style="font-size: 3rem; font-weight: 900; color: var(--acc);">5</div>
        <button class="btn" onclick="startLevel()">SALTAR DESCANSO</button>
    </div>

    <div id="game-area"></div>

    <div id="s-end" class="screen">
        <h1 id="end-title">FIN DE SESI√ìN</h1>
        <div id="summary" style="text-align: left; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin: 15px 0;"></div>
        <button class="btn" onclick="location.reload()">REINTENTAR</button>
    </div>

    <script>
        let level = 1, lives = 3, currentVal = "", sessionTime, timerInterval;
        let recognition, failTimer, warningTimer, restInt;
        let stats = { hits: 0, errors: 0, maxLevel: 1 };
        const stimuli = "123456789ABCDEFHKMNPRTUVWXY";

        // Audio Context para sonidos sin archivos externos
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        function initVoice() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) return alert("Usa Chrome.");
            
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = true; // Velocidad de respuesta m√°xima

            recognition.onstart = () => {
                sessionTime = parseInt(document.getElementById('i-work').value) * 60;
                startLevel();
            };

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript.toUpperCase();
                }
                document.getElementById('mic-status').innerText = "Oigo: " + transcript;
                checkMatch(transcript);
            };

            recognition.onend = () => { if(lives > 0 && sessionTime > 0) recognition.start(); };
            recognition.start();
        }

        function startLevel() {
            clearInterval(restInt);
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('game-area').style.display = 'block';
            document.getElementById('hud').style.display = 'flex';
            
            if(!timerInterval) {
                timerInterval = setInterval(() => {
                    sessionTime--;
                    let m = Math.floor(sessionTime/60), s = sessionTime%60;
                    document.getElementById('h-time').innerText = `${m}:${s<10?'0':''}${s}`;
                    if(sessionTime <= 0) endGame("TIEMPO COMPLETADO");
                }, 1000);
            }
            spawn();
        }

        function spawn() {
            const area = document.getElementById('game-area');
            area.innerHTML = '';
            currentVal = stimuli[Math.floor(Math.random() * stimuli.length)];
            
            // Dificultad por nivel (tiempo y posici√≥n)
            const timeLimit = Math.max(800, 4000 - (level * 200));
            const stim = document.createElement('div');
            stim.className = 'stimulus';
            stim.id = "active-stim";
            stim.innerText = currentVal;
            
            // Posicionamiento de extremo a extremo a mayor nivel
            const margin = Math.max(5, 20 - level);
            stim.style.left = `${Math.random() * (100 - 2*margin) + margin}%`;
            stim.style.top = `${Math.random() * (80 - 2*margin) + margin + 10}%`;
            stim.style.setProperty('--sz', `${Math.max(40, 100 - level*2)}px`);
            
            area.appendChild(stim);

            warningTimer = setTimeout(() => stim.classList.add('warning'), timeLimit * 0.6);
            failTimer = setTimeout(() => handleFailure(), timeLimit);
        }

        function checkMatch(text) {
            const dict = { "UNO": "1", "DOS": "2", "TRES": "3", "EQUIS": "X", "CE": "C", "SE": "C", "SI": "C" };
            let match = text.includes(currentVal);
            for(let k in dict) if(text.includes(k) && dict[k] === currentVal) match = true;

            if(match) handleSuccess();
        }

        function handleSuccess() {
            if(!document.getElementById('active-stim')) return;
            playTone(800, 'sine', 0.1);
            clearTimeout(failTimer); clearTimeout(warningTimer);
            stats.hits++;
            level++;
            stats.maxLevel = Math.max(stats.maxLevel, level);
            updateHUD();
            
            // Cada 10 aciertos, peque√±o descanso
            if(level % 10 === 0) showRest();
            else spawn();
        }

        function handleFailure() {
            playTone(200, 'square', 0.3);
            lives--;
            stats.errors++;
            updateHUD();
            if(lives <= 0) endGame("TE QUEDASTE SIN VIDAS");
            else spawn();
        }

        function showRest() {
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('s-rest').classList.add('active');
            let c = 5;
            restInt = setInterval(() => {
                c--;
                document.getElementById('rest-timer').innerText = c;
                if(c <= 0) startLevel();
            }, 1000);
        }

        function updateHUD() {
            document.getElementById('h-lvl').innerText = level;
            document.getElementById('h-lives').innerText = "‚ù§Ô∏è".repeat(lives);
        }

        function endGame(reason) {
            clearInterval(timerInterval);
            recognition.stop();
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('hud').style.display = 'none';
            document.getElementById('end-title').innerText = reason;
            document.getElementById('summary').innerHTML = `
                üéØ Aciertos: ${stats.hits}<br>
                ‚ùå Errores: ${stats.errors}<br>
                üöÄ Nivel M√°ximo: ${stats.maxLevel}<br>
                üìè Distancia: 40 cm
            `;
            document.getElementById('s-end').classList.add('active');
            // Aqu√≠ ir√≠a el fetch a Google Sheets
        }
    </script>
</body>
</html>
