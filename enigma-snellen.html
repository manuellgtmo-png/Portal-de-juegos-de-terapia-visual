<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enigma de Snellen - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #f8fafc; color: #1e293b; font-family: 'Montserrat', sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; position: relative; }
        .bubble { position: absolute; border-radius: 50%; opacity: 0.15; animation: float 15s infinite linear; z-index: 0; pointer-events: none; bottom: -100px; }
        @keyframes float { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-110vh) rotate(360deg); } }
        #ui-layer { position: fixed; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; box-sizing: border-box; z-index: 10; }
        .stat-box { background: white; padding: 10px 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-weight: 900; border: 2px solid #e2e8f0; }
        #game-container { text-align: center; width: 100%; max-width: 600px; padding: 20px; z-index: 5; }
        #optotipo-wrapper { height: 250px; display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .optotipo { font-weight: 900; color: #0f172a; transition: all 0.3s; line-height: 1; }
        .controles { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 350px; margin: 0 auto; }
        .btn-dir { background: white; border: 4px solid #1e293b; padding: 20px; font-size: 1.8rem; border-radius: 20px; cursor: pointer; transition: 0.1s; box-shadow: 0 6px 0 #1e293b; }
        .btn-dir:active { transform: translateY(3px); box-shadow: 0 3px 0 #1e293b; background: #f1f5f9; }
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; color: white; padding: 20px; text-align: center; backdrop-filter: blur(5px); }
        .modal { background: white; color: #1e293b; padding: 40px; border-radius: 35px; max-width: 450px; box-shadow: 0 25px 60px rgba(0,0,0,0.4); }
        .btn-ready { background: #22c55e; color: white; padding: 18px 45px; border-radius: 25px; font-weight: 900; border: none; cursor: pointer; margin-top: 25px; text-transform: uppercase; font-size: 1.1rem; width: 100%; display: block; }
        #sync-screen { background: #0f172a; display: none; flex-direction: column; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #38bdf8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="stat-box">Nivel: <span id="txt-nivel">1</span></div>
        <div class="stat-box">⏱️ <span id="txt-tiempo">0s</span></div>
        <div class="stat-box">Vidas: <span id="txt-vidas">❤️❤️❤️</span></div>
    </div>

    <div id="modal-instrucciones" class="overlay">
        <div class="modal">
            <h2 style="color: #6366f1; font-size: 2rem; margin-top: 0;">¿Cómo jugar?</h2>
            <p style="font-size: 1.1rem; line-height: 1.6;">Observa la secuencia de las <b>"E"</b>. Memoriza sus posiciones y repítelas con las flechas cuando desaparezcan.</p>
            <button class="btn-ready" onclick="iniciarJuegoReal()">¡EMPEZAR!</button>
        </div>
    </div>

    <div id="modal-next" class="overlay" style="display:none;">
        <div class="modal">
            <h2 style="color: #22c55e; font-size: 2rem; margin-top: 0;">¡Muy bien!</h2>
            <p>Has completado el patrón correctamente.</p>
            <button class="btn-ready" onclick="proximoNivel()">SIGUIENTE RETO</button>
        </div>
    </div>

    <div id="sync-screen" class="overlay" style="display: none; flex-direction: column;">
        <div class="loader"></div>
        <h2 style="color: white;">Sincronizando...</h2>
    </div>

    <div id="game-container">
        <div id="optotipo-wrapper"></div>
        <p id="instruccion-fase" style="font-weight: bold; color: #64748b; margin-top: 20px;">Esperando...</p>
        <div class="controles" id="pad-controles" style="pointer-events: none; opacity: 0.3;">
            <button class="btn-dir" onclick="registrarEntrada('ARRIBA')">↑</button>
            <button class="btn-dir" onclick="registrarEntrada('ABAJO')">↓</button>
            <button class="btn-dir" onclick="registrarEntrada('IZQUIERDA')">←</button>
            <button class="btn-dir" onclick="registrarEntrada('DERECHA')">→</button>
        </div>
    </div>

    <script>
        const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const ENTRIES = {
            paciente: "entry.369874016",
            juego: "entry.1353470174",
            nivel: "entry.721051298",
            aciertos: "entry.873272199",
            fallos: "entry.1030094511",
            tiempo: "entry.1303309812"
        };

        let nivel = 1;
        let vidas = 3;
        let tiempoSec = 0;
        let timerInterval;
        let secuenciaActual = [];
        let secuenciaUsuario = [];
        let tamañoActual = 150;
        const direcciones = ["ARRIBA", "ABAJO", "IZQUIERDA", "DERECHA"];
        const rotaciones = { "ARRIBA": "-90deg", "ABAJO": "90deg", "IZQUIERDA": "180deg", "DERECHA": "0deg" };

        function iniciarJuegoReal() {
            console.log("Iniciando juego...");
            document.getElementById('modal-instrucciones').style.display = 'none';
            crearBurbujas();
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => { 
                tiempoSec++; 
                document.getElementById('txt-tiempo').innerText = tiempoSec + "s"; 
            }, 1000);
            generarPatron();
        }

        function crearBurbujas() {
            for(let i=0; i<8; i++) {
                let b = document.createElement('div');
                b.className = 'bubble';
                let size = Math.random() * 60 + 20;
                b.style.width = size + 'px';
                b.style.height = size + 'px';
                b.style.left = Math.random() * 100 + 'vw';
                b.style.background = ['#6366f1', '#22c55e', '#f59e0b', '#ec4899'][Math.floor(Math.random()*4)];
                b.style.animationDelay = Math.random() * 5 + 's';
                document.body.appendChild(b);
            }
        }

        function generarPatron() {
            secuenciaActual = [];
            secuenciaUsuario = [];
            const wrapper = document.getElementById('optotipo-wrapper');
            const numSimbolos = Math.min(6, 1 + Math.floor(nivel / 2)); 
            wrapper.innerHTML = '';
            
            document.getElementById('instruccion-fase').innerText = "Observa el patrón...";
            document.getElementById('pad-controles').style.pointer-events = "none";
            document.getElementById('pad-controles').style.opacity = "0.3";

            for(let i=0; i < numSimbolos; i++) {
                let dir = direcciones[Math.floor(Math.random() * direcciones.length)];
                secuenciaActual.push(dir);
                let el = document.createElement('div');
                el.className = 'optotipo';
                el.innerText = 'E';
                el.style.fontSize = tamañoActual + 'px';
                el.style.transform = `rotate(${rotaciones[dir]})`;
                wrapper.appendChild(el);
            }

            setTimeout(() => {
                wrapper.innerHTML = '<h1 style="font-size:4rem; color:#6366f1; margin:0;">?</h1>';
                document.getElementById('instruccion-fase').innerText = "¡REPITELO AHORA!";
                document.getElementById('pad-controles').style.pointer-events = "auto";
                document.getElementById('pad-controles').style.opacity = "1";
            }, 1000 + (numSimbolos * 700));
        }

        function registrarEntrada(dir) {
            secuenciaUsuario.push(dir);
            const index = secuenciaUsuario.length - 1;

            if (dir !== secuenciaActual[index]) {
                vidas--;
                document.getElementById('txt-vidas').innerText = "❤️".repeat(Math.max(0, vidas));
                if(vidas <= 0) {
                    finalizarJuego();
                } else {
                    alert("¡Incorrecto! Mira el patrón de nuevo.");
                    generarPatron();
                }
                return;
            }

            if (secuenciaUsuario.length === secuenciaActual.length) {
                document.getElementById('modal-next').style.display = 'flex';
            }
        }

        function proximoNivel() {
            nivel++;
            tamañoActual = Math.max(15, tamañoActual * 0.88);
            document.getElementById('txt-nivel').innerText = nivel;
            document.getElementById('modal-next').style.display = 'none';
            generarPatron();
        }

        function finalizarJuego() {
            clearInterval(timerInterval);
            document.getElementById('sync-screen').style.display = 'flex';
            
            const nombre = localStorage.getItem('pacienteActual') || "Paciente Prueba";
            const data = new FormData();
            data.append(ENTRIES.paciente, nombre);
            data.append(ENTRIES.juego, "Agudeza Estática (Snellen Seq)");
            data.append(ENTRIES.nivel, nivel);
            data.append(ENTRIES.aciertos, nivel - 1);
            data.append(ENTRIES.fallos, 3 - vidas);
            data.append(ENTRIES.tiempo, tiempoSec + "s");

            fetch(FORM_URL, { method: 'POST', mode: 'no-cors', body: data });

            setTimeout(() => {
                window.location.href = "agudeza-estatica.html";
            }, 2500);
        }
    </script>
</body>
</html>
