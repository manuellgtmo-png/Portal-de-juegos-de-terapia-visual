<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antisac√°dicos Pro - Entrenamiento Visual</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617;
            --card-bg: #1e293b;
            --accent: #a855f7;
            --text: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
            --neon-glow: 0 0 20px rgba(168, 85, 247, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* PANTALLAS DE INTERFAZ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(2, 6, 23, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--card-bg);
            padding: 50px;
            border-radius: 40px;
            border: 4px solid var(--accent);
            text-align: center;
            max-width: 800px;
            width: 90%;
            box-shadow: var(--neon-glow);
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent);
            font-size: 3.5rem;
            margin-bottom: 25px;
            text-transform: uppercase;
        }

        .instrucciones-box {
            text-align: left;
            background: rgba(0,0,0,0.3);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .instrucciones-box p {
            font-size: 1.4rem;
            line-height: 1.8;
            margin-bottom: 10px;
        }

        /* CONFIGURACI√ìN */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
            text-align: left;
        }

        .config-item label {
            display: block;
            color: var(--accent);
            font-weight: 900;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
            height: 8px;
            cursor: pointer;
        }

        .btn-action {
            background: var(--success);
            color: #000;
            border: none;
            padding: 20px 50px;
            font-size: 1.8rem;
            font-weight: 900;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, filter 0.2s;
        }

        .btn-action:hover {
            transform: scale(1.03);
            filter: brightness(1.1);
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 0;
            width: 100%;
            padding: 20px 50px;
            display: none;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 3px solid var(--accent);
            z-index: 100;
        }

        .hud-item {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            font-weight: bold;
        }

        .lives-display {
            color: var(--danger);
            font-size: 2.2rem;
            letter-spacing: 5px;
        }

        /* √ÅREA DE JUEGO */
        #game-area {
            position: relative;
            width: 100%;
            height: 100%;
            display: none;
        }

        .fixation-point {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            color: var(--accent);
            opacity: 0.3;
            user-select: none;
        }

        .distractor-dot {
            position: absolute;
            width: 55px;
            height: 55px;
            background: #ffffff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px #ffffff;
        }

        .game-stimulus {
            position: absolute;
            font-family: 'Orbitron', sans-serif;
            font-size: 10rem;
            font-weight: 900;
            color: var(--accent);
            transform: translate(-50%, -50%);
            text-shadow: 0 0 40px var(--accent);
            cursor: pointer;
            user-select: none;
        }

        /* EFECTOS VISUALES */
        .flash-red {
            animation: danger-blink 0.3s forwards;
        }

        @keyframes danger-blink {
            50% { background-color: var(--danger); }
        }

        /* MODAL DE DESCANSO / NIVEL */
        #level-modal {
            display: none;
        }
    </style>
</head>
<body>

    <div id="step1" class="overlay">
        <div class="modal">
            <h1>Antisac√°dicos</h1>
            <div class="instrucciones-box">
                <p>1. Mant√©n la distancia de <b>40 cm</b>.</p>
                <p>2. Aparecer√° un punto blanco: <b>¬°No lo mires!</b></p>
                <p>3. üëÑ <b>DI EN VOZ ALTA:</b> Vocales y N√∫meros Pares.</p>
                <p>4. üëÜ <b>TOCA LA PANTALLA:</b> Letras y N√∫meros Impares.</p>
            </div>
            <button class="btn-action" onclick="goToStep2()">SIGUIENTE</button>
        </div>
    </div>

    <div id="step2" class="overlay" style="display: none;">
        <div class="modal">
            <h1>Ajustes</h1>
            <div class="config-grid">
                <div class="config-item">
                    <label>Series por Nivel: <span id="lbl-series">3</span></label>
                    <input type="range" id="input-series" min="1" max="10" value="3" oninput="updateLabel('lbl-series', this.value)">
                </div>
                <div class="config-item">
                    <label>Tiempo de Serie (seg): <span id="lbl-work">30</span></label>
                    <input type="range" id="input-work" min="10" max="120" value="30" oninput="updateLabel('lbl-work', this.value)">
                </div>
                <div class="config-item">
                    <label>Tiempo de Descanso (seg): <span id="lbl-rest">10</span></label>
                    <input type="range" id="input-rest" min="5" max="60" value="10" oninput="updateLabel('lbl-rest', this.value)">
                </div>
            </div>
            <button class="btn-action" style="background: var(--accent); color: white;" onclick="beginGame()">¬°INICIAR!</button>
        </div>
    </div>

    <div id="hud">
        <div class="hud-item" style="color: var(--success)">TIEMPO: <span id="display-timer">30s</span></div>
        <div class="hud-item">NIVEL <span id="display-lvl">1</span> - SERIE <span id="display-serie">1</span></div>
        <div class="hud-item lives-display" id="display-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="game-area">
        <div class="fixation-point">+</div>
    </div>

    <div id="level-modal" class="overlay">
        <div class="modal" style="border-color: var(--success);">
            <h1 id="modal-title" style="color: var(--success);">¬°SERIE COMPLETADA!</h1>
            <p style="font-size: 2.2rem; margin-bottom: 10px;">Aciertos logrados: <span id="modal-hits">0</span></p>
            <p id="modal-descanso" style="color: var(--accent); font-style: italic; margin-bottom: 30px;"></p>
            <button class="btn-action" onclick="handleNextStep()">CONTINUAR ENTRENAMIENTO</button>
        </div>
    </div>

    <script>
        // --- VARIABLES DE ESTADO ---
        let configSeries, configWorkTime, configRestTime;
        let currentLevel = 1, currentSerie = 1, currentLives = 3, currentHits = 0;
        let isGameRunning = false, gameTimerInterval, currentTargetValue = "", currentMode = ""; 
        let currentTimeoutRef = null;

        // --- ARRAYS DE EST√çMULOS ---
        const listVocales = ['A', 'O', 'U'];
        const listLetras = ['X', 'P', 'T', 'K', 'S', 'M'];
        const listPares = ['2', '4', '6', '8'];
        const listImpares = ['1', '3', '5', '7', '9'];

        // --- RECONOCIMIENTO DE VOZ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechApi = new SpeechRecognition();
        speechApi.lang = 'es-ES';
        speechApi.continuous = true;
        speechApi.interimResults = false;

        // --- AUDIO ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playFeedbackSound(frequency, waveType) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = waveType;
            osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 0.12);
        }

        // --- NAVEGACI√ìN ---
        function updateLabel(id, val) { document.getElementById(id).innerText = val; }
        function goToStep2() { document.getElementById('step1').style.display = 'none'; document.getElementById('step2').style.display = 'flex'; }

        function beginGame() {
            configSeries = parseInt(document.getElementById('input-series').value);
            configWorkTime = parseInt(document.getElementById('input-work').value);
            configRestTime = parseInt(document.getElementById('input-rest').value);

            document.getElementById('step2').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('game-area').style.display = 'block';

            speechApi.start();
            initiateSerie();
        }

        // --- L√ìGICA DE JUEGO ---
        function initiateSerie() {
            currentLives = 3;
            currentHits = 0;
            isGameRunning = true;
            updateHudDisplay();
            startCountdown();
            spawnStimulusCycle();
        }

        function spawnStimulusCycle() {
            if (!isGameRunning) return;

            const area = document.getElementById('game-area');
            area.innerHTML = '<div class="fixation-point">+</div>';

            const isLeftOrigin = Math.random() > 0.5;
            const dotX = isLeftOrigin ? "20%" : "80%";
            const targetX = isLeftOrigin ? "80%" : "20%";

            // 1. Mostrar Punto Blanco (Distractor)
            const dot = document.createElement('div');
            dot.className = 'distractor-dot';
            dot.style.left = dotX;
            dot.style.top = "50%";
            area.appendChild(dot);

            // 2. Esperar para forzar Antisac√°dico
            setTimeout(() => {
                if (!isGameRunning) return;
                dot.remove();

                // 3. Seleccionar Est√≠mulo y Modo
                const randomCategory = Math.random();
                if (randomCategory < 0.25) {
                    currentTargetValue = listVocales[Math.floor(Math.random() * listVocales.length)];
                    currentMode = "VOZ";
                } else if (randomCategory < 0.50) {
                    currentTargetValue = listLetras[Math.floor(Math.random() * listLetras.length)];
                    currentMode = "TOUCH";
                } else if (randomCategory < 0.75) {
                    currentTargetValue = listPares[Math.floor(Math.random() * listPares.length)];
                    currentMode = "VOZ";
                } else {
                    currentTargetValue = listImpares[Math.floor(Math.random() * listImpares.length)];
                    currentMode = "TOUCH";
                }

                // 4. Crear el Est√≠mulo en pantalla
                const stimElement = document.createElement('div');
                stimElement.className = 'game-stimulus';
                stimElement.innerText = currentTargetValue;
                stimElement.style.left = targetX;
                stimElement.style.top = "50%";
                
                stimElement.onclick = function() {
                    if (currentMode === "TOUCH") registerHit();
                    else registerError();
                };

                area.appendChild(stimElement);

                // 5. Tiempo L√≠mite (Dificultad Progresiva por Nivel)
                const limit = Math.max(900, 2600 - (currentLevel * 180));
                currentTimeoutRef = setTimeout(() => {
                    if (area.contains(stimElement) && isGameRunning) registerError();
                }, limit);

            }, 800);
        }

        // --- MANEJO DE ENTRADAS ---
        speechApi.onresult = (event) => {
            if (!isGameRunning) return;
            const transcript = event.results[event.results.length - 1][0].transcript.toUpperCase();
            
            // Si el ni√±o habla cuando es TOUCH -> Error de inhibici√≥n
            if (currentMode === "TOUCH") {
                registerError();
                return;
            }

            if (currentMode === "VOZ" && transcript.includes(currentTargetValue)) {
                registerHit();
            }
        };

        function registerHit() {
            clearTimeout(currentTimeoutRef);
            playFeedbackSound(880, 'sine');
            currentHits++;
            document.getElementById('game-area').innerHTML = '<div class="fixation-point">+</div>';
            setTimeout(spawnStimulusCycle, 500);
        }

        function registerError() {
            clearTimeout(currentTimeoutRef);
            playFeedbackSound(200, 'square');
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 250);
            
            currentLives--;
            updateHudDisplay();

            if (currentLives <= 0) {
                stopSerieExecution();
            } else {
                document.getElementById('game-area').innerHTML = '<div class="fixation-point">+</div>';
                setTimeout(spawnStimulusCycle, 900);
            }
        }

        // --- CRON√ìMETRO Y FLUJO ---
        function startCountdown() {
            let timeLeft = configWorkTime;
            gameTimerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('display-timer').innerText = timeLeft + "s";
                if (timeLeft <= 0) {
                    clearInterval(gameTimerInterval);
                    stopSerieExecution();
                }
            }, 1000);
        }

        function stopSerieExecution() {
            isGameRunning = false;
            clearInterval(gameTimerInterval);
            document.getElementById('modal-hits').innerText = currentHits;
            document.getElementById('modal-descanso').innerText = `Descansa ${configRestTime} segundos antes de la siguiente fase.`;
            document.getElementById('level-modal').style.display = 'flex';
        }

        function handleNextStep() {
            document.getElementById('level-modal').style.display = 'none';
            if (currentSerie < configSeries) {
                currentSerie++;
            } else {
                currentSerie = 1;
                currentLevel++;
                document.getElementById('modal-title').innerText = "¬°NIVEL SUPERADO!";
            }
            updateHudDisplay();
            initiateSerie();
        }

        function updateHudDisplay() {
            document.getElementById('display-lvl').innerText = currentLevel;
            document.getElementById('display-serie').innerText = currentSerie;
            document.getElementById('display-lives').innerText = "‚ù§Ô∏è".repeat(currentLives);
        }

        speechApi.onend = () => { if(isGameRunning) speechApi.start(); };
    </script>
</body>
</html>
