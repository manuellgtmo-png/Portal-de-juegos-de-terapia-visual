<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antisac√°dicos Elite - Reconocimiento Reforzado</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #020617; --panel: #1e293b; --purple: #a855f7; --green: #10b981; --red: #ef4444; --white: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body, html { width: 100%; height: 100%; background: var(--bg); color: var(--white); font-family: 'Montserrat', sans-serif; overflow: hidden; }
        .overlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); display: flex; align-items: center; justify-content: center; z-index: 5000; padding: 20px; }
        .card { background: var(--panel); padding: 45px; border-radius: 40px; border: 5px solid var(--purple); text-align: center; max-width: 750px; width: 100%; box-shadow: 0 0 60px rgba(168, 85, 247, 0.4); }
        h1 { font-family: 'Orbitron'; font-size: 3rem; color: var(--purple); margin-bottom: 25px; letter-spacing: 3px; }
        .instr { text-align: left; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 20px; margin-bottom: 30px; font-size: 1.3rem; line-height: 1.8; border-left: 8px solid var(--purple); }
        .config-row { margin-bottom: 25px; text-align: left; }
        .config-row label { display: block; font-weight: 900; color: var(--purple); margin-bottom: 10px; font-size: 1.2rem; }
        input[type="range"] { width: 100%; height: 12px; accent-color: var(--purple); cursor: pointer; }
        .btn { background: var(--green); color: #000; border: none; padding: 22px; font-size: 1.8rem; font-weight: 900; border-radius: 20px; cursor: pointer; width: 100%; box-shadow: 0 8px 0 #065f46; transition: 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: 0 4px 0 #065f46; }
        #hud { position: absolute; top: 0; width: 100%; padding: 25px 50px; display: none; justify-content: space-between; align-items: center; z-index: 1000; background: linear-gradient(to bottom, rgba(2,6,23,0.9), transparent); }
        .stat { font-family: 'Orbitron'; font-size: 1.6rem; font-weight: 700; }
        #stage { position: relative; width: 100vw; height: 100vh; display: none; }
        .cross { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; color: var(--purple); opacity: 0.2; }
        .dot { position: absolute; width: 55px; height: 55px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 40px #fff; z-index: 10; }
        .stim { position: absolute; font-family: 'Orbitron'; font-size: 10rem; font-weight: 900; color: var(--purple); transform: translate(-50%, -50%); text-shadow: 0 0 50px var(--purple); cursor: pointer; z-index: 100; }
        .flash-red { animation: f-red 0.3s ease; }
        @keyframes f-red { 50% { background: var(--red); } }
        .summary-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 1.2rem; }
        .summary-table td { padding: 12px; border-bottom: 1px solid rgba(168, 85, 247, 0.2); text-align: left; }
        .summary-val { font-weight: 900; color: var(--green); text-align: right; font-family: 'Orbitron'; }
    </style>
</head>
<body>

    <div id="scr-intro" class="overlay">
        <div class="card">
            <h1>ANTISAC√ÅDICOS</h1>
            <div class="instr">
                <p>üìç Distancia de trabajo: <b>40 cm</b></p>
                <p>üëÅÔ∏è Punto blanco: <b>¬°IGN√ìRALO!</b> Mira al lado opuesto.</p>
                <p>üëÑ <b>DILO:</b> Vocales y N√∫meros Pares.</p>
                <p>üëÜ <b>T√ìCALO:</b> Letras y N√∫meros Impares.</p>
            </div>
            <button class="btn" onclick="navToConfig()">CONTINUAR</button>
        </div>
    </div>

    <div id="scr-config" class="overlay" style="display:none">
        <div class="card">
            <h1>AJUSTES</h1>
            <div class="instr">
                <div class="config-row">
                    <label>Series por Nivel: <span id="v-ser">3</span></label>
                    <input type="range" id="i-ser" min="1" max="10" value="3" oninput="document.getElementById('v-ser').innerText=this.value">
                </div>
                <div class="config-row">
                    <label>Tiempo por Serie: <span id="v-time">30</span>s</label>
                    <input type="range" id="i-time" min="10" max="60" value="30" oninput="document.getElementById('v-time').innerText=this.value">
                </div>
                <div class="config-row">
                    <label>Tiempo de Descanso: <span id="v-rest">5</span>s</label>
                    <input type="range" id="i-rest" min="3" max="15" value="5" oninput="document.getElementById('v-rest').innerText=this.value">
                </div>
            </div>
            <button class="btn" style="background: var(--purple); color: white;" onclick="bootGame()">INICIAR JUEGO</button>
        </div>
    </div>

    <div id="hud">
        <div class="stat" style="color:var(--green)" id="h-time">30s</div>
        <div class="stat" id="h-lvl">NIVEL 1 - SERIE 1</div>
        <div class="stat" style="color:var(--red)" id="h-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="stage"><div class="cross">+</div></div>

    <div id="scr-rest" class="overlay" style="display:none">
        <div class="card" style="border-color: var(--green)">
            <h1 id="rest-title">¬°SERIE LOGRADA!</h1>
            <p style="font-size: 2.2rem; margin: 20px 0;">Aciertos: <span id="rest-hits">0</span></p>
            <p id="rest-timer-msg" style="color: var(--purple); font-weight: 900; font-size: 1.5rem;"></p>
            <button id="btn-next" class="btn" style="display:none" onclick="flowControl()">CONTINUAR</button>
        </div>
    </div>

    <div id="scr-final" class="overlay" style="display:none">
        <div class="card" style="border-color: var(--red)">
            <h1>FIN DEL JUEGO</h1>
            <table class="summary-table">
                <tr><td>Nivel M√°ximo Alcanzado:</td><td class="summary-val" id="f-lvl">1</td></tr>
                <tr><td>Series Completadas:</td><td class="summary-val" id="f-ser">0</td></tr>
                <tr><td>Aciertos Totales:</td><td class="summary-val" id="f-hits">0</td></tr>
            </table>
            <button class="btn" style="background: var(--purple); color: white;" onclick="location.reload()">VOLVER A EMPEZAR</button>
        </div>
    </div>

    <script>
        let cfg_series, cfg_duration, cfg_rest;
        let lvl = 1, serie = 1, lives = 3, totalHits = 0, currentHits = 0, lvlBonusCounter = 0;
        let isRunning = false, masterClock, spawnTimer, reactTimer, nextTurnTimer;
        let currentTarget = "", currentMode = "";

        const voc = ['A','E','O','U'], cons = ['X','P','T','K','S'], pares = ['2','4','6','8'], impares = ['1','3','5','7','9'];

        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speech = new Recognition();
        speech.lang = 'es-ES'; speech.continuous = true;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(freq) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq; gain.gain.value = 0.1;
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function navToConfig() { document.getElementById('scr-intro').style.display = 'none'; document.getElementById('scr-config').style.display = 'flex'; }

        function bootGame() {
            cfg_series = parseInt(document.getElementById('i-ser').value);
            cfg_duration = parseInt(document.getElementById('i-time').value);
            cfg_rest = parseInt(document.getElementById('i-rest').value);
            document.getElementById('scr-config').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('stage').style.display = 'block';
            speech.start();
            runSerie();
        }

        function runSerie() { currentHits = 0; isRunning = true; updateHUD(); startTimer(); generate(); }

        function generate() {
            if (!isRunning) return;
            const s = document.getElementById('stage');
            s.innerHTML = '<div class="cross">+</div>'; 

            const isLeft = Math.random() > 0.5;
            const dotPos = isLeft ? "22%" : "78%";
            const stimPos = isLeft ? "78%" : "22%";

            const d = document.createElement('div');
            d.className = 'dot'; d.style.left = dotPos; d.style.top = "50%";
            s.appendChild(d);

            spawnTimer = setTimeout(() => {
                if (!isRunning) return;
                d.remove();
                const roll = Math.random();
                if (roll < 0.25) { currentTarget = voc[Math.floor(Math.random()*voc.length)]; currentMode = "VOZ"; }
                else if (roll < 0.5) { currentTarget = cons[Math.floor(Math.random()*cons.length)]; currentMode = "TOUCH"; }
                else if (roll < 0.75) { currentTarget = pares[Math.floor(Math.random()*pares.length)]; currentMode = "VOZ"; }
                else { currentTarget = impares[Math.floor(Math.random()*impares.length)]; currentMode = "TOUCH"; }

                const el = document.createElement('div');
                el.className = 'stim'; el.innerText = currentTarget; el.style.left = stimPos; el.style.top = "50%";
                el.onclick = (e) => { e.stopPropagation(); if (currentMode === "TOUCH") processHit(); else processMiss(); };
                s.appendChild(el);

                const limit = Math.max(800, 2500 - (lvl * 150));
                reactTimer = setTimeout(() => { if (isRunning && s.contains(el)) processMiss(); }, limit);
            }, 800);
        }

        speech.onresult = (e) => {
            if (!isRunning) return;
            const raw = e.results[e.results.length - 1][0].transcript.toUpperCase();
            
            // --- DICCIONARIO FLEXIBLE ---
            const match = {
                'A': ['A', 'HA', 'LA'],
                'E': ['E', 'HE', 'EH', 'DE', 'B'],
                'O': ['O', 'OH', 'DO'],
                'U': ['U', 'UH', 'TU', 'T√ö', 'Y√ö'],
                '2': ['2', 'DOS'],
                '4': ['4', 'CUATRO'],
                '6': ['6', 'SEIS'],
                '8': ['8', 'OCHO']
            };

            let isCorrect = false;
            if (match[currentTarget]) {
                isCorrect = match[currentTarget].some(v => raw.includes(v));
            }

            if (currentMode === "TOUCH") { processMiss(); return; }
            if (currentMode === "VOZ" && isCorrect) processHit();
        };

        function processHit() {
            killTimers();
            playBeep(880);
            currentHits++; totalHits++;
            document.getElementById('stage').innerHTML = '<div class="cross">+</div>';
            nextTurnTimer = setTimeout(generate, 400);
        }

        function processMiss() {
            killTimers();
            playBeep(220);
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 300);
            lives--; updateHUD();
            if (lives <= 0) gameOver();
            else {
                document.getElementById('stage').innerHTML = '<div class="cross">+</div>';
                nextTurnTimer = setTimeout(generate, 800);
            }
        }

        function killTimers() { clearTimeout(spawnTimer); clearTimeout(reactTimer); clearTimeout(nextTurnTimer); }

        function startTimer() {
            let t = cfg_duration;
            masterClock = setInterval(() => {
                t--; document.getElementById('h-time').innerText = t + "s";
                if (t <= 0) { clearInterval(masterClock); pauseSerie(); }
            }, 1000);
        }

        function pauseSerie() {
            isRunning = false; killTimers();
            document.getElementById('rest-hits').innerText = currentHits;
            document.getElementById('scr-rest').style.display = 'flex';
            document.getElementById('btn-next').style.display = 'none';
            let rt = cfg_rest;
            const rInterval = setInterval(() => {
                document.getElementById('rest-timer-msg').innerText = `Descansa ${rt} segundos...`;
                rt--;
                if (rt < 0) { clearInterval(rInterval); document.getElementById('rest-timer-msg').innerText = "¬°Listo!"; document.getElementById('btn-next').style.display = 'block'; }
            }, 1000);
        }

        function flowControl() {
            document.getElementById('scr-rest').style.display = 'none';
            if (serie < cfg_series) serie++; 
            else { 
                serie = 1; lvl++; lvlBonusCounter++;
                if (lvlBonusCounter >= 6) { lives = Math.min(5, lives + 1); lvlBonusCounter = 0; document.getElementById('rest-title').innerText = "¬°NIVEL 6 SUPERADO: +1 VIDA!"; }
                else document.getElementById('rest-title').innerText = "¬°NIVEL SUPERADO!";
            }
            runSerie();
        }

        function gameOver() {
            isRunning = false; clearInterval(masterClock); killTimers();
            document.getElementById('f-lvl').innerText = lvl;
            document.getElementById('f-ser').innerText = ((lvl - 1) * cfg_series) + (serie - 1);
            document.getElementById('f-hits').innerText = totalHits;
            document.getElementById('hud').style.display = 'none';
            document.getElementById('stage').style.display = 'none';
            document.getElementById('scr-final').style.display = 'flex';
        }

        function updateHUD() {
            document.getElementById('h-lvl').innerText = `NIVEL ${lvl} - SERIE ${serie}`;
            document.getElementById('h-lives').innerText = "‚ù§Ô∏è".repeat(Math.max(0, lives));
        }
        speech.onend = () => { if (isRunning) speech.start(); };
    </script>
</body>
</html>
