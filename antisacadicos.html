<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antisac√°dicos Elite - Sistema de Entrenamiento</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617;
            --panel: #1e293b;
            --purple: #a855f7;
            --green: #10b981;
            --red: #ef4444;
            --white: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body, html { width: 100%; height: 100%; background: var(--bg); color: var(--white); font-family: 'Montserrat', sans-serif; overflow: hidden; }

        /* --- UI LAYERS --- */
        .overlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); display: flex; align-items: center; justify-content: center; z-index: 5000; padding: 20px; }
        .card { background: var(--panel); padding: 45px; border-radius: 40px; border: 5px solid var(--purple); text-align: center; max-width: 750px; width: 100%; box-shadow: 0 0 60px rgba(168, 85, 247, 0.4); }
        
        h1 { font-family: 'Orbitron'; font-size: 3rem; color: var(--purple); margin-bottom: 25px; letter-spacing: 3px; }
        .instr { text-align: left; background: rgba(0,0,0,0.3); padding: 30px; border-radius: 20px; margin-bottom: 30px; font-size: 1.3rem; line-height: 1.8; border-left: 8px solid var(--purple); }
        
        /* --- CONTROLES --- */
        .config-row { margin-bottom: 25px; text-align: left; }
        .config-row label { display: block; font-weight: 900; color: var(--purple); margin-bottom: 10px; font-size: 1.2rem; }
        input[type="range"] { width: 100%; height: 12px; accent-color: var(--purple); cursor: pointer; }

        .btn { background: var(--green); color: #000; border: none; padding: 22px; font-size: 1.8rem; font-weight: 900; border-radius: 20px; cursor: pointer; width: 100%; box-shadow: 0 8px 0 #065f46; transition: 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: 0 4px 0 #065f46; }

        /* --- HUD --- */
        #hud { position: absolute; top: 0; width: 100%; padding: 25px 50px; display: none; justify-content: space-between; align-items: center; z-index: 1000; background: linear-gradient(to bottom, rgba(2,6,23,0.9), transparent); }
        .stat { font-family: 'Orbitron'; font-size: 1.6rem; font-weight: 700; }

        /* --- GAME STAGE --- */
        #stage { position: relative; width: 100vw; height: 100vh; display: none; }
        .cross { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; color: var(--purple); opacity: 0.2; }
        .dot { position: absolute; width: 55px; height: 55px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 40px #fff; z-index: 10; }
        .stim { position: absolute; font-family: 'Orbitron'; font-size: 10rem; font-weight: 900; color: var(--purple); transform: translate(-50%, -50%); text-shadow: 0 0 50px var(--purple); cursor: pointer; z-index: 100; }

        /* --- FEEDBACK --- */
        .flash-red { animation: f-red 0.3s ease; }
        @keyframes f-red { 50% { background: var(--red); } }

        /* --- FINAL SUMMARY TABLE --- */
        .summary-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 1.2rem; }
        .summary-table td { padding: 12px; border-bottom: 1px solid rgba(168, 85, 247, 0.2); text-align: left; }
        .summary-val { font-weight: 900; color: var(--green); text-align: right; font-family: 'Orbitron'; }
    </style>
</head>
<body>

    <div id="scr-intro" class="overlay">
        <div class="card">
            <h1>ANTISAC√ÅDICOS</h1>
            <div class="instr">
                <p>üìç Distancia de trabajo: <b>40 cm</b></p>
                <p>üëÅÔ∏è Punto blanco: <b>¬°IGN√ìRALO!</b> Mira al lado opuesto.</p>
                <p>üëÑ <b>DILO:</b> Vocales y N√∫meros Pares (2, 4, 6, 8).</p>
                <p>üëÜ <b>T√ìCALO:</b> Letras y N√∫meros Impares (1, 3, 5, 7, 9).</p>
            </div>
            <button class="btn" onclick="navToConfig()">CONTINUAR</button>
        </div>
    </div>

    <div id="scr-config" class="overlay" style="display:none">
        <div class="card">
            <h1>AJUSTES</h1>
            <div class="instr">
                <div class="config-row">
                    <label>Series por Nivel: <span id="v-ser">3</span></label>
                    <input type="range" id="i-ser" min="1" max="10" value="3" oninput="document.getElementById('v-ser').innerText=this.value">
                </div>
                <div class="config-row">
                    <label>Tiempo por Serie: <span id="v-time">30</span>s</label>
                    <input type="range" id="i-time" min="10" max="60" value="30" oninput="document.getElementById('v-time').innerText=this.value">
                </div>
            </div>
            <button class="btn" style="background: var(--purple); color: white;" onclick="bootGame()">INICIAR JUEGO</button>
        </div>
    </div>

    <div id="hud">
        <div class="stat" style="color:var(--green)" id="h-time">30s</div>
        <div class="stat" id="h-lvl">NIVEL 1 - SERIE 1</div>
        <div class="stat" style="color:var(--red)" id="h-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="stage"><div class="cross">+</div></div>

    <div id="scr-rest" class="overlay" style="display:none">
        <div class="card" style="border-color: var(--green)">
            <h1 id="rest-title">¬°SERIE LOGRADA!</h1>
            <p style="font-size: 2.2rem; margin: 20px 0;">Aciertos: <span id="rest-hits">0</span></p>
            <p id="rest-msg" style="color: var(--purple); font-style: italic; margin-bottom: 30px;"></p>
            <button class="btn" onclick="flowControl()">SIGUIENTE PASO</button>
        </div>
    </div>

    <div id="scr-final" class="overlay" style="display:none">
        <div class="card" style="border-color: var(--red)">
            <h1>FIN DEL JUEGO</h1>
            <table class="summary-table">
                <tr><td>Nivel M√°ximo Alcanzado:</td><td class="summary-val" id="f-lvl">1</td></tr>
                <tr><td>Series Completadas:</td><td class="summary-val" id="f-ser">0</td></tr>
                <tr><td>Aciertos Totales:</td><td class="summary-val" id="f-hits">0</td></tr>
            </table>
            <button class="btn" style="background: var(--purple); color: white;" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let cfg_series, cfg_duration;
        let lvl = 1, serie = 1, lives = 3, totalHits = 0, currentHits = 0, lvlBonusCounter = 0;
        let isRunning = false, masterClock, spawnTimer, reactTimer;
        let currentTarget = "", currentMode = "";

        const voc = ['A','E','O','U'], cons = ['X','P','T','K','S'], pares = ['2','4','6','8'], impares = ['1','3','5','7','9'];

        // --- MOTORES ---
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speech = new Recognition();
        speech.lang = 'es-ES';
        speech.continuous = true;

        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function beep(f, t) {
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
            g.gain.setValueAtTime(0.1, audio.currentTime);
            o.connect(g); g.connect(audio.destination);
            o.start(); o.stop(audio.currentTime + 0.15);
        }

        // --- NAVEGACI√ìN ---
        function navToConfig() {
            document.getElementById('scr-intro').style.display = 'none';
            document.getElementById('scr-config').style.display = 'flex';
        }

        function bootGame() {
            cfg_series = parseInt(document.getElementById('i-ser').value);
            cfg_duration = parseInt(document.getElementById('i-time').value);
            document.getElementById('scr-config').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('stage').style.display = 'block';
            speech.start();
            runSerie();
        }

        // --- CICLO DE JUEGO ---
        function runSerie() {
            currentHits = 0;
            isRunning = true;
            updateHUD();
            startTimer();
            generate();
        }

        function generate() {
            if (!isRunning) return;
            const s = document.getElementById('stage');
            s.innerHTML = '<div class="cross">+</div>';

            const isLeft = Math.random() > 0.5;
            const dotPos = isLeft ? "22%" : "78%";
            const stimPos = isLeft ? "78%" : "22%";

            // 1. Mostrar punto distractor
            const d = document.createElement('div');
            d.className = 'dot'; d.style.left = dotPos; d.style.top = "50%";
            s.appendChild(d);

            // 2. Aparecer est√≠mulo tras delay
            spawnTimer = setTimeout(() => {
                if (!isRunning) return;
                d.remove();
                
                const roll = Math.random();
                if (roll < 0.25) { currentTarget = voc[Math.floor(Math.random()*voc.length)]; currentMode = "VOZ"; }
                else if (roll < 0.5) { currentTarget = cons[Math.floor(Math.random()*cons.length)]; currentMode = "TOUCH"; }
                else if (roll < 0.75) { currentTarget = pares[Math.floor(Math.random()*pares.length)]; currentMode = "VOZ"; }
                else { currentTarget = impares[Math.floor(Math.random()*impares.length)]; currentMode = "TOUCH"; }

                const el = document.createElement('div');
                el.className = 'stim'; el.innerText = currentTarget;
                el.style.left = stimPos; el.style.top = "50%";
                
                // Evento click/touch
                el.onclick = () => {
                    if (currentMode === "TOUCH") processHit();
                    else processMiss();
                };

                s.appendChild(el);

                // Tiempo de respuesta progresivo
                const limit = Math.max(850, 2600 - (lvl * 160));
                reactTimer = setTimeout(() => {
                    if (isRunning && s.contains(el)) processMiss();
                }, limit);

            }, 850);
        }

        // --- CAPTURA DE VOZ ---
        speech.onresult = (e) => {
            if (!isRunning) return;
            const raw = e.results[e.results.length - 1][0].transcript.toUpperCase();
            
            // Variantes fon√©ticas para E y U
            const isE = (currentTarget === 'E' && (raw.includes('E') || raw.includes('HE') || raw.includes('EH') || raw.includes('DE')));
            const isU = (currentTarget === 'U' && (raw.includes('U') || raw.includes('UH') || raw.includes('OOU') || raw.includes('T√ö')));

            // Error de inhibici√≥n: si habla cuando debe tocar
            if (currentMode === "TOUCH") { processMiss(); return; }

            if (currentMode === "VOZ" && (raw.includes(currentTarget) || isE || isU)) {
                processHit();
            }
        };

        function processHit() {
            clearTimeout(reactTimer);
            beep(880, 'sine');
            currentHits++; totalHits++;
            document.getElementById('stage').innerHTML = '<div class="cross">+</div>';
            setTimeout(generate, 500);
        }

        function processMiss() {
            clearTimeout(reactTimer);
            clearTimeout(spawnTimer);
            beep(220, 'square');
            
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 300);
            
            lives--;
            updateHUD();

            if (lives <= 0) {
                gameOver();
            } else {
                document.getElementById('stage').innerHTML = '<div class="cross">+</div>';
                setTimeout(generate, 900);
            }
        }

        // --- RELOJ Y FLUJO ---
        function startTimer() {
            let t = cfg_duration;
            masterClock = setInterval(() => {
                t--;
                document.getElementById('h-time').innerText = t + "s";
                if (t <= 0) { clearInterval(masterClock); pauseSerie(); }
            }, 1000);
        }

        function pauseSerie() {
            isRunning = false;
            clearTimeout(spawnTimer);
            clearTimeout(reactTimer);
            document.getElementById('rest-hits').innerText = currentHits;
            document.getElementById('rest-msg').innerText = "Prep√°rate para la siguiente fase.";
            document.getElementById('scr-rest').style.display = 'flex';
        }

        function flowControl() {
            document.getElementById('scr-rest').style.display = 'none';
            if (serie < cfg_series) {
                serie++;
                document.getElementById('rest-title').innerText = "¬°SERIE LOGRADA!";
            } else {
                serie = 1; lvl++;
                lvlBonusCounter++;
                // REGLA: 1 vida cada 6 niveles [cite: 2026-02-04]
                if (lvlBonusCounter >= 6) {
                    lives = Math.min(5, lives + 1);
                    lvlBonusCounter = 0;
                    document.getElementById('rest-title').innerText = "¬°NIVEL 6 SUPERADO: +1 VIDA!";
                } else {
                    document.getElementById('rest-title').innerText = "¬°NIVEL SUPERADO!";
                }
            }
            runSerie();
        }

        function gameOver() {
            isRunning = false;
            clearInterval(masterClock);
            clearTimeout(spawnTimer);
            clearTimeout(reactTimer);
            
            // Llenar tabla resumen
            document.getElementById('f-lvl').innerText = lvl;
            document.getElementById('f-ser').innerText = ((lvl - 1) * cfg_series) + (serie - 1);
            document.getElementById('f-hits').innerText = totalHits;
            
            document.getElementById('hud').style.display = 'none';
            document.getElementById('stage').style.display = 'none';
            document.getElementById('scr-final').style.display = 'flex';
        }

        function updateHUD() {
            document.getElementById('h-lvl').innerText = `NIVEL ${lvl} - SERIE ${serie}`;
            document.getElementById('h-lives').innerText = "‚ù§Ô∏è".repeat(Math.max(0, lives));
        }

        speech.onend = () => { if (isRunning) speech.start(); };
    </script>
</body>
</html>
