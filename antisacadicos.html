<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antisac√°dicos Elite - Sistema Completo</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #020617;
            --card-bg: #1e293b;
            --accent-color: #a855f7;
            --text-color: #f8fafc;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --overlay-bg: rgba(2, 6, 23, 0.95);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- CAPAS DE INTERFAZ --- */
        .full-screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .main-modal {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 40px;
            border: 5px solid var(--accent-color);
            text-align: center;
            max-width: 850px;
            width: 100%;
            box-shadow: 0 0 60px rgba(168, 85, 247, 0.4);
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            color: var(--accent-color);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .instructions-container {
            text-align: left;
            background: rgba(0,0,0,0.4);
            padding: 30px;
            border-radius: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .instructions-container p {
            font-size: 1.5rem;
            line-height: 1.6;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .icon-guide {
            font-size: 2rem;
            margin-right: 15px;
        }

        /* --- CONFIGURACI√ìN --- */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 40px;
            text-align: left;
        }

        .settings-item label {
            display: block;
            color: var(--accent-color);
            font-weight: 900;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .range-slider {
            width: 100%;
            accent-color: var(--accent-color);
            height: 12px;
            cursor: pointer;
            border-radius: 10px;
        }

        .btn-universal {
            background: var(--success-color);
            color: #000;
            border: none;
            padding: 25px 60px;
            font-size: 2rem;
            font-weight: 900;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 10px 0 #065f46;
        }

        .btn-universal:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #065f46;
        }

        /* --- HUD (HEADS-UP DISPLAY) --- */
        #game-hud {
            position: absolute;
            top: 0;
            width: 100%;
            padding: 25px 60px;
            display: none;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(15,23,42,1), rgba(15,23,42,0));
            z-index: 1000;
        }

        .hud-data {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .lives-container {
            font-size: 2.5rem;
            letter-spacing: 8px;
            filter: drop-shadow(0 0 10px var(--danger-color));
        }

        /* --- √ÅREA DE ACCI√ìN --- */
        #stage {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: none;
        }

        .center-cross {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 7rem;
            color: var(--accent-color);
            opacity: 0.2;
        }

        .antisaccadic-dot {
            position: absolute;
            width: 60px;
            height: 60px;
            background: #FFFFFF;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 40px #FFFFFF;
            z-index: 50;
        }

        .target-stimulus {
            position: absolute;
            font-family: 'Orbitron', sans-serif;
            font-size: 11rem;
            font-weight: 900;
            color: var(--accent-color);
            transform: translate(-50%, -50%);
            text-shadow: 0 0 50px var(--accent-color);
            z-index: 100;
            cursor: pointer;
        }

        /* --- FEEDBACK VISUAL --- */
        .screen-flash-error {
            animation: errorFlash 0.4s cubic-bezier(0.455, 0.03, 0.515, 0.95);
        }

        @keyframes errorFlash {
            0% { background-color: transparent; }
            50% { background-color: var(--danger-color); }
            100% { background-color: transparent; }
        }

        /* --- MODAL DE RESUMEN --- */
        #summary-layer {
            display: none;
        }
    </style>
</head>
<body>

    <div id="ui-step1" class="full-screen-overlay">
        <div class="main-modal">
            <h1>Antisac√°dicos Elite</h1>
            <div class="instructions-container">
                <p><span class="icon-guide">üìè</span> Distancia de trabajo: <b>40 cm</b>.</p>
                <p><span class="icon-guide">üö´</span> Si ves un punto blanco: <b>¬°NO LO MIRES!</b></p>
                <p><span class="icon-guide">üëÑ</span> <b>DILO:</b> Vocales y N√∫meros Pares (2, 4, 6, 8).</p>
                <p><span class="icon-guide">üëÜ</span> <b>T√ìCALO:</b> Letras y N√∫meros Impares (1, 3, 5, 7, 9).</p>
            </div>
            <button class="btn-universal" onclick="navToConfig()">ENTENDIDO</button>
        </div>
    </div>

    <div id="ui-step2" class="full-screen-overlay" style="display: none;">
        <div class="main-modal">
            <h1>Configuraci√≥n</h1>
            <div class="settings-grid">
                <div class="settings-item">
                    <label>Series por Nivel: <span id="txt-series">3</span></label>
                    <input type="range" id="input-series" class="range-slider" min="1" max="10" value="3" oninput="syncLabel('txt-series', this.value)">
                </div>
                <div class="settings-item">
                    <label>Duraci√≥n de Serie (seg): <span id="txt-work">30</span></label>
                    <input type="range" id="input-work" class="range-slider" min="10" max="120" value="30" oninput="syncLabel('txt-work', this.value)">
                </div>
                <div class="settings-item">
                    <label>Descanso (seg): <span id="txt-rest">10</span></label>
                    <input type="range" id="input-rest" class="range-slider" min="5" max="60" value="10" oninput="syncLabel('txt-rest', this.value)">
                </div>
            </div>
            <button class="btn-universal" style="background: var(--accent-color); color: white;" onclick="launchGameEngine()">COMENZAR</button>
        </div>
    </div>

    <div id="game-hud">
        <div class="hud-data" style="color: var(--success-color)">TIEMPO: <span id="hud-timer">30s</span></div>
        <div class="hud-data" id="hud-status">NIVEL 1 - SERIE 1</div>
        <div class="hud-data lives-container" id="hud-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <div id="stage">
        <div class="center-cross">+</div>
    </div>

    <div id="summary-layer" class="full-screen-overlay">
        <div class="main-modal" style="border-color: var(--success-color);">
            <h1 id="sum-title" style="color: var(--success-color);">¬°LOGRADO!</h1>
            <p style="font-size: 2.5rem; font-weight: 900; margin-bottom: 10px;">Aciertos: <span id="sum-hits">0</span></p>
            <p id="sum-msg" style="color: var(--accent-color); font-style: italic; font-size: 1.4rem; margin-bottom: 30px;"></p>
            <button class="btn-universal" onclick="proceedToNextCycle()">SIGUIENTE PASO</button>
        </div>
    </div>

    <script>
        // --- CONSTANTES Y ESTADOS ---
        let cfgSeries, cfgWorkTime, cfgRestTime;
        let gameLvl = 1, gameSerie = 1, gameLives = 3, gameHits = 0;
        let isEngineActive = false;
        let mainClockInterval;
        let currentTarget = "";
        let currentActionRequired = ""; // "VOZ" o "TOUCH"
        
        // Referencias de temporizadores para limpieza profunda
        let spawnTimerRef = null;
        let limitTimerRef = null;

        const vocales = ['A', 'E', 'O', 'U'];
        const letras = ['X', 'P', 'T', 'K', 'S', 'M', 'N', 'Z'];
        const pares = ['2', '4', '6', '8'];
        const impares = ['1', '3', '5', '7', '9'];

        // --- MOTOR DE VOZ ---
        const RecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechEngine = new RecognitionAPI();
        speechEngine.lang = 'es-ES';
        speechEngine.continuous = true;
        speechEngine.interimResults = false;

        // --- SISTEMA DE AUDIO (Beeps) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function emitSound(freq, type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        }

        // --- NAVEGACI√ìN ---
        function syncLabel(id, v) { document.getElementById(id).innerText = v; }
        function navToConfig() { 
            document.getElementById('ui-step1').style.display = 'none'; 
            document.getElementById('ui-step2').style.display = 'flex'; 
        }

        function launchGameEngine() {
            cfgSeries = parseInt(document.getElementById('input-series').value);
            cfgWorkTime = parseInt(document.getElementById('input-work').value);
            cfgRestTime = parseInt(document.getElementById('input-rest').value);

            document.getElementById('ui-step2').style.display = 'none';
            document.getElementById('game-hud').style.display = 'flex';
            document.getElementById('stage').style.display = 'block';

            speechEngine.start();
            setupNewSerie();
        }

        // --- CICLO DE SERIE ---
        function setupNewSerie() {
            gameHits = 0;
            isEngineActive = true;
            refreshHudDisplay();
            startMainClock();
            triggerSpawnProcess();
        }

        function triggerSpawnProcess() {
            if (!isEngineActive) return;

            const stage = document.getElementById('stage');
            stage.innerHTML = '<div class="center-cross">+</div>';

            const sideIsLeft = Math.random() > 0.5;
            const dotPos = sideIsLeft ? "20%" : "80%";
            const stimPos = sideIsLeft ? "80%" : "20%";

            // 1. Crear Punto Sac√°dico (Distractor)
            const dot = document.createElement('div');
            dot.className = 'antisaccadic-dot';
            dot.style.left = dotPos;
            dot.style.top = "50%";
            stage.appendChild(dot);

            // 2. Proceso de Antisac√°dico: El est√≠mulo aparece despu√©s del punto
            spawnTimerRef = setTimeout(() => {
                if (!isEngineActive) return;
                dot.remove();

                // Decidir categor√≠a
                const rand = Math.random();
                if (rand < 0.25) {
                    currentTarget = vocales[Math.floor(Math.random() * vocales.length)];
                    currentActionRequired = "VOZ";
                } else if (rand < 0.50) {
                    currentTarget = letras[Math.floor(Math.random() * letras.length)];
                    currentActionRequired = "TOUCH";
                } else if (rand < 0.75) {
                    currentTarget = pares[Math.floor(Math.random() * pares.length)];
                    currentActionRequired = "VOZ";
                } else {
                    currentTarget = impares[Math.floor(Math.random() * impares.length)];
                    currentActionRequired = "TOUCH";
                }

                // Crear Est√≠mulo
                const stim = document.createElement('div');
                stim.className = 'target-stimulus';
                stim.innerText = currentTarget;
                stim.style.left = stimPos;
                stim.style.top = "50%";
                
                // Evento Touch/Click
                stim.onclick = function() {
                    if (currentActionRequired === "TOUCH") handlePositiveAction();
                    else handleNegativeAction();
                };

                stage.appendChild(stim);

                // Tiempo de respuesta (Dificultad escalada por nivel)
                const reactionLimit = Math.max(850, 2600 - (gameLvl * 180));
                limitTimerRef = setTimeout(() => {
                    if (isEngineActive && stage.contains(stim)) handleNegativeAction();
                }, reactionLimit);

            }, 850);
        }

        // --- MANEJO DE RESULTADOS ---
        speechEngine.onresult = (e) => {
            if (!isEngineActive) return;
            const text = e.results[e.results.length - 1][0].transcript.toUpperCase();
            
            // L√≥gica Inhibitoria: Si habla cuando debe tocar -> ERROR
            if (currentActionRequired === "TOUCH") {
                handleNegativeAction();
                return;
            }

            if (currentActionRequired === "VOZ" && text.includes(currentTarget)) {
                handlePositiveAction();
            }
        };

        function handlePositiveAction() {
            clearTimeout(limitTimerRef);
            emitSound(880, 'sine');
            gameHits++;
            document.getElementById('stage').innerHTML = '<div class="center-cross">+</div>';
            setTimeout(triggerSpawnProcess, 500);
        }

        function handleNegativeAction() {
            clearTimeout(limitTimerRef);
            clearTimeout(spawnTimerRef);
            emitSound(220, 'square');
            
            document.body.classList.add('screen-flash-error');
            setTimeout(() => document.body.classList.remove('screen-flash-error'), 400);
            
            gameLives--;
            refreshHudDisplay();

            if (gameLives <= 0) {
                terminateToInstructions();
            } else {
                document.getElementById('stage').innerHTML = '<div class="center-cross">+</div>';
                setTimeout(triggerSpawnProcess, 900);
            }
        }

        // --- RELOJ Y PROGRESI√ìN ---
        function startMainClock() {
            let remain = cfgWorkTime;
            mainClockInterval = setInterval(() => {
                remain--;
                document.getElementById('hud-timer').innerText = remain + "s";
                if (remain <= 0) {
                    clearInterval(mainClockInterval);
                    concludeSerie();
                }
            }, 1000);
        }

        function concludeSerie() {
            isEngineActive = false;
            clearTimeout(spawnTimerRef);
            clearTimeout(limitTimerRef);
            
            document.getElementById('sum-hits').innerText = gameHits;
            document.getElementById('sum-msg').innerText = `Pausa de ${cfgRestTime} segundos antes de continuar.`;
            document.getElementById('summary-layer').style.display = 'flex';
        }

        function terminateToInstructions() {
            isEngineActive = false;
            clearInterval(mainClockInterval);
            clearTimeout(spawnTimerRef);
            clearTimeout(limitTimerRef);

            // Reset total de estado
            gameLvl = 1; gameSerie = 1; gameLives = 3;
            
            document.getElementById('stage').style.display = 'none';
            document.getElementById('game-hud').style.display = 'none';
            document.getElementById('ui-step1').style.display = 'flex';
        }

        function proceedToNextCycle() {
            document.getElementById('summary-layer').style.display = 'none';
            
            if (gameSerie < cfgSeries) {
                gameSerie++;
            } else {
                gameSerie = 1;
                gameLvl++;
                gameLives = Math.min(5, gameLives + 1); // Premio: +1 vida al subir nivel (m√°ximo 5)
                document.getElementById('sum-title').innerText = "¬°NIVEL SUPERADO!";
            }
            
            setupNewSerie();
        }

        function refreshHudDisplay() {
            document.getElementById('hud-status').innerText = `NIVEL ${gameLvl} - SERIE ${gameSerie}`;
            document.getElementById('hud-lives').innerText = "‚ù§Ô∏è".repeat(Math.max(0, gameLives));
        }

        speechEngine.onend = () => { if(isEngineActive) speechEngine.start(); };
    </script>
</body>
</html>
