<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Barrido Lineal Pro - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05080a;
            --accent: #00f2ff;
            --secondary: #bc13fe;
            --error: #ff4757;
            --success: #2ed573;
            --panel: rgba(15, 25, 35, 0.95);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg); font-family: 'Montserrat', sans-serif;
            overflow: hidden; color: white; -webkit-user-select: none;
            touch-action: none;
        }

        /* HEADER */
        #header {
            height: 90px; display: flex; justify-content: space-between;
            align-items: center; padding: 0 40px; background: var(--panel);
            border-bottom: 4px solid var(--secondary); box-shadow: 0 5px 25px rgba(0,0,0,0.8);
            position: relative; z-index: 1000;
        }

        .stat-group { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); font-weight: 800; }
        .stat-value { font-size: 2rem; font-weight: 900; }
        #v-lives { font-size: 2.5rem; letter-spacing: 10px; filter: drop-shadow(0 0 10px var(--secondary)); }

        /* ESCENARIO */
        #game-area {
            position: relative; width: 100%; height: calc(100vh - 90px);
            background: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        .target {
            position: absolute; width: 80px; height: 80px;
            background: var(--secondary); border: 4px solid var(--accent);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-weight: 900; font-size: 2rem;
            box-shadow: 0 0 30px rgba(188, 19, 254, 0.6);
            cursor: pointer; transition: transform 0.1s;
            z-index: 500;
        }

        .target:active { transform: scale(0.9); }

        .laser-line {
            position: absolute; height: 4px; background: var(--accent);
            box-shadow: 0 0 15px var(--accent); transform-origin: left center;
            pointer-events: none; z-index: 100;
        }

        /* MODALES */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center;
            z-index: 5000; backdrop-filter: blur(15px);
        }

        .modal {
            background: #0f1923; padding: 60px; border-radius: 50px;
            border: 5px solid var(--secondary); width: 90%; max-width: 650px;
            text-align: center; box-shadow: 0 0 100px rgba(188, 19, 254, 0.3);
        }

        .btn-play {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white; padding: 30px; border-radius: 25px; border: none;
            width: 100%; font-size: 2rem; font-weight: 900; letter-spacing: 5px;
            margin-top: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.5);
        }

        .results-table { width: 100%; margin: 30px 0; border-spacing: 0 15px; }
        .results-table td { padding: 20px; background: rgba(255,255,255,0.05); font-size: 1.8rem; }
        .td-label { border-radius: 20px 0 0 20px; color: var(--accent); font-weight: 700; }
        .td-val { border-radius: 0 20px 20px 0; text-align: right; font-weight: 900; }

        .flash-red { animation: flashError 0.3s; }
        @keyframes flashError { 50% { background: var(--error); } }
    </style>
</head>
<body>

    <header id="header">
        <div class="stat-group"><span class="stat-label">Nivel</span><span id="v-lvl" class="stat-value">1</span></div>
        <div id="v-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="stat-group"><span class="stat-label">Progreso</span><span class="stat-value"><span id="v-hits">0</span>/10</span></div>
    </header>

    <div id="game-area"></div>

    <div id="modal-start" class="overlay">
        <div class="modal">
            <h1 style="font-size: 3.5rem; color: var(--accent);">BARRIDO LINEAL</h1>
            <p style="font-size: 1.5rem;">Sigue la secuencia de objetivos. La velocidad y el desorden aumentan en cada nivel.</p>
            <button class="btn-play" onclick="initGame()">EMPEZAR</button>
        </div>
    </div>

    <div id="modal-res" class="overlay" style="display:none;">
        <div class="modal">
            <h1 style="color: var(--error);">SESI√ìN FINALIZADA</h1>
            <table class="results-table">
                <tr><td class="td-label">Nivel Alcanzado:</td><td id="res-lvl" class="td-val">1</td></tr>
                <tr><td class="td-label">Aciertos Totales:</td><td id="res-hits" class="td-val">0</td></tr>
            </table>
            <p id="sync-msg" style="color: var(--accent); font-weight: 900;">SINCRONIZANDO CON LA NUBE...</p>
            <button class="btn-play" onclick="location.reload()">REPETIR</button>
        </div>
    </div>

    <script>
        const FORM_ID = "1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg";
        const ENTRIES = {
            paciente: "entry.369874016",
            juego: "entry.1353470174",
            nivel: "entry.721051298",
            aciertos: "entry.873272199",
            fallos: "entry.1030094511",
            fecha: "entry.845098414"
        };

        let lvl = 1, hits = 0, totalHits = 0, totalFails = 0, lives = 3, active = false;
        const area = document.getElementById('game-area');

        function initGame() {
            document.getElementById('modal-start').style.display = 'none';
            active = true;
            spawnTarget();
        }

        function spawnTarget() {
            if(!active) return;
            area.innerHTML = '';
            
            const t = document.createElement('div');
            t.className = 'target';
            
            // Posici√≥n aleatoria con margen de seguridad para tablet
            const padding = 100;
            const x = padding + Math.random() * (window.innerWidth - padding * 2);
            const y = padding + Math.random() * (area.offsetHeight - padding * 2);
            
            t.style.left = `${x}px`;
            t.style.top = `${y}px`;
            t.innerHTML = hits + 1;
            
            // Tiempo de reacci√≥n decreciente
            const timeLimit = Math.max(600, 3000 - (lvl * 200));
            
            const timer = setTimeout(() => {
                if(t.parentElement) {
                    totalFails++;
                    handleMistake();
                }
            }, timeLimit);

            t.onclick = (e) => {
                e.stopPropagation();
                clearTimeout(timer);
                hits++;
                totalHits++;
                document.getElementById('v-hits').innerText = hits;
                
                if(hits >= 10) {
                    levelUp();
                } else {
                    spawnTarget();
                }
            };

            area.appendChild(t);
        }

        function handleMistake() {
            lives--;
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 300);
            updateLives();
            if(lives <= 0) endGame(); else spawnTarget();
        }

        function updateLives() {
            document.getElementById('v-lives').innerText = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
        }

        function levelUp() {
            lvl++;
            hits = 0;
            if(lvl % 4 === 0 && lives < 3) lives++;
            updateLives();
            document.getElementById('v-lvl').innerText = lvl;
            document.getElementById('v-hits').innerText = '0';
            
            // Breve pausa de √©xito
            active = false;
            area.innerHTML = `<h1 style="position:absolute; top:40%; width:100%; text-align:center; color:var(--success); font-size:4rem;">¬°NIVEL ${lvl}!</h1>`;
            setTimeout(() => { active = true; spawnTarget(); }, 1200);
        }

        function endGame() {
            active = false;
            document.getElementById('res-lvl').innerText = lvl;
            document.getElementById('res-hits').innerText = totalHits;
            document.getElementById('modal-res').style.display = 'flex';
            sendToCloud();
        }

        function sendToCloud() {
            const fecha = new Date().toISOString().split('T')[0];
            const query = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse?` +
                `${ENTRIES.paciente}=PACIENTE_BARRIDO&${ENTRIES.juego}=Barrido_Lineal_Infinite&` +
                `${ENTRIES.nivel}=${lvl}&${ENTRIES.aciertos}=${totalHits}&` +
                `${ENTRIES.fallos}=${totalFails}&${ENTRIES.fecha}=${fecha}&submit=Submit`;

            const beacon = new Image();
            beacon.src = query;
            beacon.onload = beacon.onerror = () => {
                const msg = document.getElementById('sync-msg');
                msg.innerText = "‚úÖ SESI√ìN SINCRONIZADA";
                msg.style.color = "var(--success)";
            };
        }
    </script>
</body>
</html>
