<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>T√∫nel Snellen Pro - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           CONFIGURACI√ìN DE VARIABLES Y RESET
           ========================================= */
        :root {
            --bg-deep: #0b101b;
            --accent-primary: #bc13fe;
            --neon-glow: #00f2ff;
            --error-red: #ff4757;
            --success-green: #22c55e;
            --panel-alpha: rgba(28, 35, 49, 0.98);
            --shadow-extreme: 0 15px 50px rgba(0,0,0,0.8);
            --font-family: 'Montserrat', sans-serif;
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-deep);
            font-family: var(--font-family);
            overflow: hidden;
            color: #ffffff;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        /* =========================================
           CABECERA (HEADER) - DISE√ëO EXTENDIDO
           ========================================= */
        header {
            height: 100px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 50px;
            background: var(--panel-alpha);
            border-bottom: 6px solid var(--accent-primary);
            box-shadow: var(--shadow-extreme);
            position: relative;
            z-index: 5000;
        }

        .stat-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 150px;
        }

        .stat-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--neon-glow);
            font-weight: 900;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
        }

        #lives-container {
            font-size: 3rem;
            letter-spacing: 15px;
            filter: drop-shadow(0 0 15px var(--accent-primary));
            transition: all 0.3s ease;
        }

        /* =========================================
           ESCENARIO DE JUEGO (CANVAS/STAGE)
           ========================================= */
        #game-arena {
            position: relative;
            width: 100%;
            height: calc(100vh - 300px);
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #1a1f2c 0%, #070a12 100%);
            overflow: hidden;
            perspective: 1500px;
        }

        .snellen-e {
            position: absolute;
            font-weight: 900;
            color: #ffffff;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 30px var(--neon-glow), 0 0 60px rgba(0, 242, 255, 0.3);
            will-change: transform, opacity;
            line-height: 0.8;
        }

        /* =========================================
           CONTROLES T√ÅCTILES - √ÅREA INFERIOR
           ========================================= */
        footer {
            height: 200px;
            background: #111622;
            border-top: 4px solid #2e3748;
            position: absolute;
            bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 4000;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 35px;
            width: 100%;
            max-width: 1000px;
            padding: 0 40px;
        }

        .btn-input {
            background: #1c2331;
            border: 6px solid var(--accent-primary);
            border-radius: 40px;
            color: white;
            font-size: 4rem;
            height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 14px 0 var(--accent-primary);
            position: relative;
        }

        .btn-input:active {
            transform: translateY(10px);
            box-shadow: 0 4px 0 var(--accent-primary);
            background-color: var(--accent-primary);
        }

        /* =========================================
           MODALES Y OVERLAYS PROFESIONALES
           ========================================= */
        .overlay-screen {
            position: fixed;
            inset: 0;
            background: rgba(4, 6, 12, 0.99);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 40px;
            backdrop-filter: blur(20px);
        }

        .modal-box {
            background: #1c2331;
            padding: 70px;
            border-radius: 70px;
            border: 8px solid var(--accent-primary);
            width: 100%;
            max-width: 750px;
            text-align: center;
            box-shadow: 0 0 100px rgba(188, 19, 254, 0.4);
        }

        .modal-box h1 {
            color: var(--neon-glow);
            font-weight: 900;
            font-size: 4rem;
            margin-bottom: 40px;
            letter-spacing: -2px;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            text-align: left;
            margin-bottom: 30px;
            font-size: 1.6rem;
            color: #e0e0e0;
        }

        .instruction-num {
            background: var(--accent-primary);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-right: 25px;
            flex-shrink: 0;
            box-shadow: 0 0 20px var(--accent-primary);
        }

        .btn-cta {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--neon-glow) 100%);
            color: white;
            padding: 35px;
            border-radius: 30px;
            border: none;
            font-weight: 900;
            width: 100%;
            margin-top: 40px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 2rem;
            letter-spacing: 4px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        /* =========================================
           RESULTADOS Y TABLA DE DATOS
           ========================================= */
        .results-table {
            width: 100%;
            margin: 40px 0;
            border-collapse: separate;
            border-spacing: 0 15px;
        }

        .results-table td {
            padding: 25px;
            background: rgba(255,255,255,0.05);
            font-size: 1.8rem;
        }

        .results-table td:first-child {
            border-radius: 25px 0 0 25px;
            color: var(--neon-glow);
            font-weight: 800;
            border-left: 6px solid var(--neon-glow);
        }

        .results-table td:last-child {
            border-radius: 0 25px 25px 0;
            text-align: right;
            font-weight: 900;
        }

        /* FEEDBACKS */
        .flash-red { background-color: var(--error-red) !important; }
        .flash-green { background-color: var(--success-green) !important; }

    </style>
</head>
<body>

    <form id="gs-form" action="https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse" method="POST" target="secret-frame" style="display:none;">
        <input type="hidden" name="entry.369874016" id="f-paciente" value="PACIENTE_SNELLEN_01">
        <input type="hidden" name="entry.1353470174" id="f-juego" value="Tunel_Snellen_Infinite_V2">
        <input type="hidden" name="entry.721051298" id="f-nivel">
        <input type="hidden" name="entry.873272199" id="f-aciertos">
        <input type="hidden" name="entry.1030094511" id="f-fallos">
        <input type="hidden" name="entry.845098414" id="f-fecha">
    </form>
    <iframe name="secret-frame" id="secret-frame" style="display:none;"></iframe>

    <header>
        <div class="stat-block">
            <span class="stat-label">Nivel</span>
            <span id="ui-level" class="stat-value">1</span>
        </div>
        <div id="lives-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="stat-block">
            <span class="stat-label">Progreso</span>
            <span class="stat-value"><span id="ui-hits">0</span> / 7</span>
        </div>
    </header>

    <div id="game-arena"></div>

    <footer>
        <div class="control-grid" id="control-mount"></div>
    </footer>

    <div id="screen-intro" class="overlay-screen">
        <div class="modal-box">
            <h1>T√öNEL SNELLEN</h1>
            <div class="instruction-item">
                <div class="instruction-num">1</div>
                <div>Observa la letra "E" y su direcci√≥n.</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-num">2</div>
                <div>Toca la flecha correcta r√°pidamente.</div>
            </div>
            <div class="instruction-item">
                <div class="instruction-num">3</div>
                <div>Gana vida extra cada 4 niveles. ‚ù§Ô∏è</div>
            </div>
            <button class="btn-cta" onclick="startSession()">EMPEZAR TERAPIA</button>
        </div>
    </div>

    <div id="screen-results" class="overlay-screen" style="display:none;">
        <div class="modal-box">
            <h1 style="color: var(--error-red);">SESI√ìN TERMINADA</h1>
            <table class="results-table">
                <tr><td>Nivel Final:</td><td id="res-lvl">1</td></tr>
                <tr><td>Aciertos:</td><td id="res-hits">0</td></tr>
                <tr><td>Fallos:</td><td id="res-fails">0</td></tr>
            </table>
            <p id="gs-status" style="font-weight: 900; color: var(--neon-glow); margin-bottom: 20px;">SINCRONIZANDO...</p>
            <button class="btn-cta" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <script>
        /* =========================================
           L√ìGICA DEL JUEGO - MOTOR COMPLETO
           ========================================= */
        
        let level = 1;
        let hitsInCurrentLevel = 0;
        let totalHits = 0;
        let totalFails = 0;
        let lives = 3;
        let isRunning = false;
        let targetRotation = 0;

        const arena = document.getElementById('game-arena');
        const mount = document.getElementById('control-mount');

        function startSession() {
            document.getElementById('screen-intro').style.display = 'none';
            isRunning = true;
            nextChallenge();
        }

        /* RECONSTRUCCI√ìN DE CONTROLES (SHUFFLE) */
        function refreshControls() {
            mount.innerHTML = '';
            const configs = [
                { rot: 180, icon: '‚¨ÖÔ∏è' },
                { rot: 270, icon: '‚¨ÜÔ∏è' },
                { rot: 90, icon: '‚¨áÔ∏è' },
                { rot: 0, icon: '‚û°Ô∏è' }
            ];

            // Mezcla aleatoria robusta
            configs.sort(() => Math.random() - 0.5);

            configs.forEach(conf => {
                const btn = document.createElement('div');
                btn.className = 'btn-input';
                btn.innerHTML = conf.icon;
                
                // Soporte Multi-Touch
                btn.onmousedown = (e) => { e.preventDefault(); processInput(conf.rot); };
                btn.ontouchstart = (e) => { e.preventDefault(); processInput(conf.rot); };
                
                mount.appendChild(btn);
            });
        }

        /* GENERACI√ìN DE EST√çMULO DIN√ÅMICO */
        function nextChallenge() {
            if (!isRunning) return;
            
            arena.innerHTML = '';
            refreshControls();

            const e = document.createElement('div');
            e.className = 'snellen-e';
            
            const rotations = [0, 90, 180, 270];
            targetRotation = rotations[Math.floor(Math.random() * rotations.length)];
            
            // Tama√±o decreciente por nivel
            const currentSize = Math.max(25, 170 - (level * 8));
            e.style.fontSize = currentSize + 'px';
            e.innerHTML = 'E';
            e.style.transform = `rotate(${targetRotation}deg)`;
            arena.appendChild(e);

            // Velocidad incremental
            const speed = Math.max(400, 5000 - (level * 450));
            
            const animation = e.animate([
                { transform: `rotate(${targetRotation}deg) scale(0.01)`, opacity: 0 },
                { opacity: 1, offset: 0.1 },
                { transform: `rotate(${targetRotation}deg) scale(11)`, opacity: 0 }
            ], {
                duration: speed,
                easing: 'ease-in'
            });

            animation.onfinish = () => {
                if (e.parentElement && isRunning) {
                    totalFails++;
                    handleMistake();
                }
            };
        }

        function processInput(inputRot) {
            if (!isRunning) return;

            if (inputRot === targetRotation) {
                hitsInCurrentLevel++;
                totalHits++;
                document.getElementById('ui-hits').innerText = hitsInCurrentLevel;

                if (hitsInCurrentLevel >= 7) {
                    levelUp();
                } else {
                    nextChallenge();
                }
            } else {
                totalFails++;
                handleMistake();
            }
        }

        function handleMistake() {
            lives--;
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 250);
            
            updateLivesUI();

            if (lives <= 0) {
                endGame();
            } else {
                nextChallenge();
            }
        }

        function updateLivesUI() {
            document.getElementById('lives-container').innerText = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
        }

        function levelUp() {
            // Regla de Perceptum: Vida extra cada 4 niveles
            if (level % 4 === 0 && lives < 3) {
                lives++;
                updateLivesUI();
            }

            level++;
            hitsInCurrentLevel = 0;
            document.getElementById('ui-level').innerText = level;
            document.getElementById('ui-hits').innerText = '0';
            
            // Pausa visual breve entre niveles
            isRunning = false;
            arena.innerHTML = `<h2 style="font-size:3rem; color:var(--success-green);">¬°NIVEL ${level}!</h2>`;
            setTimeout(() => {
                isRunning = true;
                nextChallenge();
            }, 1000);
        }

        function endGame() {
            isRunning = false;
            arena.innerHTML = '';
            
            document.getElementById('res-lvl').innerText = level;
            document.getElementById('res-hits').innerText = totalHits;
            document.getElementById('res-fails').innerText = totalFails;
            document.getElementById('screen-results').style.display = 'flex';

            // ENV√çO DE DATOS MEDIANTE FORMULARIO OCULTO (EL M√ÅS SEGURO)
            document.getElementById('f-nivel').value = level;
            document.getElementById('f-aciertos').value = totalHits;
            document.getElementById('f-fallos').value = totalFails;
            document.getElementById('f-fecha').value = new Date().toLocaleDateString();
            
            const form = document.getElementById('gs-form');
            form.submit();

            // Simulaci√≥n de respuesta visual
            setTimeout(() => {
                document.getElementById('gs-status').innerText = "‚úÖ DATOS GUARDADOS";
                document.getElementById('gs-status').style.color = "var(--success-green)";
            }, 2000);
        }
    </script>
</body>
</html>
