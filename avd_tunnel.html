<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√∫nel Snellen Pro - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b101b; --accent: #bc13fe; --neon: #00f2ff; --error: #ff4757; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: 'Montserrat', sans-serif; overflow: hidden; color: white; transition: background 0.2s; }
        
        #header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(28,35,49,0.9); border-bottom: 2px solid var(--accent); z-index: 100; }
        #stage { position: relative; width: 100%; height: calc(100vh - 200px); display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #1a1f2c 0%, #0b101b 100%); }
        
        .snellen-e { position: absolute; font-weight: 900; color: white; opacity: 0; pointer-events: none; text-shadow: 0 0 15px var(--neon); }
        
        #controls { height: 140px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: #161b2a; }
        .control-btn { background: #242b3d; border: 2px solid var(--accent); border-radius: 20px; color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; box-shadow: 0 5px 0 var(--accent); -webkit-tap-highlight-color: transparent; }
        .control-btn:active { transform: translateY(4px); box-shadow: none; background: var(--accent); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal { background: #1c2331; padding: 30px; border-radius: 35px; border: 3px solid var(--accent); width: 100%; max-width: 400px; text-align: center; }
        .btn-main { background: linear-gradient(45deg, var(--accent), var(--neon)); color: white; padding: 15px; border-radius: 15px; border: none; font-weight: 900; width: 100%; margin-top: 20px; cursor: pointer; text-transform: uppercase; font-size: 1.1rem; }
        
        .flash-red { background-color: var(--error) !important; }
        .step { text-align: left; margin: 15px 0; font-size: 0.9rem; line-height: 1.4; border-left: 3px solid var(--neon); padding-left: 10px; }
    </style>
</head>
<body>
    <div id="header">
        <div style="font-weight:900; color:var(--neon)">NIVEL: <span id="v-lvl">1</span></div>
        <div id="v-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div style="font-weight:900;">ACIERTOS: <span id="v-hits">0</span></div>
    </div>

    <div id="stage"></div>

    <div id="controls">
        <div class="control-btn" onclick="checkDir(180)">‚¨ÖÔ∏è</div>
        <div class="control-btn" onclick="checkDir(270)">‚¨ÜÔ∏è</div>
        <div class="control-btn" onclick="checkDir(90)">‚¨áÔ∏è</div>
        <div class="control-btn" onclick="checkDir(0)">‚û°Ô∏è</div>
    </div>

    <div id="intro-modal" class="overlay">
        <div class="modal">
            <h1 style="color:var(--neon); font-weight:900; margin-bottom:10px;">C√ìMO ENTRENAR</h1>
            <div class="step"><b>1. Observa el centro:</b> Una letra "E" aparecer√° y se acercar√° hacia ti.</div>
            <div class="step"><b>2. Identifica:</b> Mira hacia d√≥nde apuntan las patas de la letra.</div>
            <div class="step"><b>3. Responde:</b> Presiona la flecha correspondiente en los botones de abajo.</div>
            <div class="step"><b>4. Cuidado:</b> Si fallas o la letra se escapa, perder√°s una vida.</div>
            <button class="btn-main" onclick="startGame()">¬°ENTENDIDO, EMPEZAR!</button>
        </div>
    </div>

    <div id="res-modal" class="overlay" style="display:none;">
        <div class="modal">
            <h2 style="color:var(--neon); font-weight:900;">RESULTADOS</h2>
            <div id="res-stats" style="margin:25px 0; text-align:left; font-size: 1.2rem; line-height: 2;"></div>
            <button class="btn-main" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <script>
        let lvl=1, hits=0, lives=3, active=false, currentRot=0;
        const stage = document.getElementById('stage');

        function startGame() {
            document.getElementById('intro-modal').style.display = 'none';
            active = true;
            spawn();
        }

        function spawn() {
            if(!active) return;
            
            // LIMPIEZA TOTAL: Borramos cualquier rastro anterior
            stage.innerHTML = '';
            
            const e = document.createElement('div');
            e.className = 'snellen-e';
            const rots = [0, 90, 180, 270];
            currentRot = rots[Math.floor(Math.random()*4)];
            
            // El tama√±o se reduce con el nivel para mayor dificultad
            e.style.fontSize = Math.max(25, 110 - (lvl * 4)) + 'px';
            e.innerHTML = 'E';
            e.style.transform = `rotate(${currentRot}deg)`;
            stage.appendChild(e);

            const speed = Math.max(700, 4000 - (lvl * 300));
            const anim = e.animate([
                { transform: `rotate(${currentRot}deg) scale(0.1)`, opacity: 0 },
                { opacity: 1, offset: 0.2 },
                { transform: `rotate(${currentRot}deg) scale(7)`, opacity: 0 }
            ], { duration: speed, iterations: 1, easing: 'ease-in' });

            anim.onfinish = () => { 
                if(e.parentElement && active) { 
                    handleFail(); 
                } 
            };
        }

        function checkDir(d) {
            if(!active) return;
            
            if(d === currentRot) {
                hits++;
                document.getElementById('v-hits').innerText = hits;
                if(hits % 4 === 0) { 
                    lvl++; 
                    document.getElementById('v-lvl').innerText = lvl; 
                }
                spawn();
            } else {
                handleFail();
            }
        }

        function handleFail() {
            lives--;
            // Feedback visual de error
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 200);
            
            document.getElementById('v-lives').innerText = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
            
            if(lives <= 0) {
                end();
            } else {
                spawn(); // Limpia y lanza la siguiente
            }
        }

        function end() {
            active = false;
            stage.innerHTML = '';
            document.getElementById('res-modal').style.display = 'flex';
            document.getElementById('res-stats').innerHTML = `
                <b>‚Ä¢ Nivel alcanzado:</b> ${lvl}<br>
                <b>‚Ä¢ Aciertos totales:</b> ${hits}<br>
                <b>‚Ä¢ Precisi√≥n:</b> ${Math.round((hits/(hits + (3-lives)))*100) || 0}%
            `;
        }
    </script>
</body>
</html>
