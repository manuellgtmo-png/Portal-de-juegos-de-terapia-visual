<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√∫nel Snellen Pro - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b101b; --accent: #bc13fe; --neon: #00f2ff; --error: #ff4757; --success: #22c55e; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: 'Montserrat', sans-serif; overflow: hidden; color: white; transition: background 0.2s; }
        
        #header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(28,35,49,0.9); border-bottom: 2px solid var(--accent); z-index: 100; }
        #stage { position: relative; width: 100%; height: calc(100vh - 200px); display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #1a1f2c 0%, #0b101b 100%); }
        
        .snellen-e { position: absolute; font-weight: 900; color: white; opacity: 0; pointer-events: none; text-shadow: 0 0 15px var(--neon); }
        
        #controls { height: 140px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: #161b2a; }
        .control-btn { background: #242b3d; border: 2px solid var(--accent); border-radius: 20px; color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; box-shadow: 0 5px 0 var(--accent); -webkit-tap-highlight-color: transparent; }
        .control-btn:active { transform: translateY(4px); box-shadow: none; background: var(--accent); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal { background: #1c2331; padding: 30px; border-radius: 35px; border: 3px solid var(--accent); width: 100%; max-width: 400px; text-align: center; }
        .btn-main { background: linear-gradient(45deg, var(--accent), var(--neon)); color: white; padding: 15px; border-radius: 15px; border: none; font-weight: 900; width: 100%; margin-top: 20px; cursor: pointer; text-transform: uppercase; font-size: 1.1rem; }
        
        .flash-red { background-color: var(--error) !important; }
        .flash-green { background-color: var(--success) !important; }
        .step { text-align: left; margin: 15px 0; font-size: 0.9rem; line-height: 1.4; border-left: 3px solid var(--neon); padding-left: 10px; }
    </style>
</head>
<body>
    <div id="header">
        <div style="font-weight:900; color:var(--neon)">NIVEL: <span id="v-lvl">1</span></div>
        <div id="v-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div style="font-weight:900;">HITS: <span id="v-hits">0</span>/7</div>
    </div>

    <div id="stage"></div>
    <div id="controls"></div>

    <div id="intro-modal" class="overlay">
        <div class="modal">
            <h1 style="color:var(--neon); font-weight:900;">T√öNEL SNELLEN</h1>
            <div class="step"><b>1. Orientaci√≥n:</b> Identifica hacia d√≥nde apunta la letra.</div>
            <div class="step"><b>2. Dinamismo:</b> Los botones cambian de lugar en cada turno.</div>
            <div class="step"><b>3. Recompensa:</b> ¬°Cada 4 niveles superados ganas una vida! ‚ù§Ô∏è</div>
            <button class="btn-main" onclick="startGame()">EMPEZAR ENTRENAMIENTO</button>
        </div>
    </div>

    <div id="level-modal" class="overlay" style="display:none;">
        <div class="modal">
            <h2 id="lvl-title" style="color:var(--neon); font-weight:900;">¬°NIVEL COMPLETADO!</h2>
            <p id="lvl-msg">Has logrado los 7 aciertos.</p>
            <button class="btn-main" onclick="nextLevel()">Siguiente Nivel</button>
        </div>
    </div>

    <div id="res-modal" class="overlay" style="display:none;">
        <div class="modal">
            <h2 style="color:var(--neon); font-weight:900;">FIN</h2>
            <div id="res-stats" style="margin:25px 0; text-align:left;"></div>
            <button class="btn-main" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <script>
        let lvl=1, hits=0, totalHits=0, lives=3, active=false, currentRot=0;
        const stage = document.getElementById('stage');
        const controls = document.getElementById('controls');

        function startGame() {
            document.getElementById('intro-modal').style.display = 'none';
            active = true;
            spawn();
        }

        function shuffleControls() {
            controls.innerHTML = '';
            const btns = [
                { rot: 180, icon: '‚¨ÖÔ∏è' }, { rot: 270, icon: '‚¨ÜÔ∏è' },
                { rot: 90, icon: '‚¨áÔ∏è' }, { rot: 0, icon: '‚û°Ô∏è' }
            ];
            btns.sort(() => Math.random() - 0.5);
            btns.forEach(b => {
                const div = document.createElement('div');
                div.className = 'control-btn';
                div.innerHTML = b.icon;
                div.onclick = () => checkDir(b.rot);
                controls.appendChild(div);
            });
        }

        function spawn() {
            if(!active) return;
            stage.innerHTML = '';
            shuffleControls();
            
            const e = document.createElement('div');
            e.className = 'snellen-e';
            const rots = [0, 90, 180, 270];
            currentRot = rots[Math.floor(Math.random()*4)];
            
            e.style.fontSize = Math.max(25, 110 - (lvl * 4)) + 'px';
            e.innerHTML = 'E';
            e.style.transform = `rotate(${currentRot}deg)`;
            stage.appendChild(e);

            const speed = Math.max(650, 4200 - (lvl * 350));
            const anim = e.animate([
                { transform: `rotate(${currentRot}deg) scale(0.1)`, opacity: 0 },
                { opacity: 1, offset: 0.2 },
                { transform: `rotate(${currentRot}deg) scale(7)`, opacity: 0 }
            ], { duration: speed, iterations: 1, easing: 'ease-in' });

            anim.onfinish = () => { if(e.parentElement && active) handleFail(); };
        }

        function checkDir(d) {
            if(!active) return;
            if(d === currentRot) {
                hits++;
                totalHits++;
                document.getElementById('v-hits').innerText = hits;
                if(hits >= 7) pauseForLevel();
                else spawn();
            } else {
                handleFail();
            }
        }

        function pauseForLevel() {
            active = false;
            stage.innerHTML = '';
            const modal = document.getElementById('level-modal');
            const title = document.getElementById('lvl-title');
            const msg = document.getElementById('lvl-msg');
            
            // L√≥gica de vida extra cada 4 niveles
            if(lvl % 4 === 0 && lives < 3) {
                lives++;
                title.innerText = "¬°VIDA EXTRA CONCEDIDA!";
                title.style.color = "var(--success)";
                msg.innerText = "Excelente precisi√≥n. Has recuperado un ‚ù§Ô∏è por tu constancia.";
                document.body.classList.add('flash-green');
                setTimeout(() => document.body.classList.remove('flash-green'), 500);
            } else {
                title.innerText = "¬°NIVEL COMPLETADO!";
                title.style.color = "var(--neon)";
                msg.innerText = "Has logrado los 7 aciertos.";
            }
            
            modal.style.display = 'flex';
        }

        function nextLevel() {
            lvl++;
            hits = 0;
            document.getElementById('v-lvl').innerText = lvl;
            document.getElementById('v-hits').innerText = '0';
            document.getElementById('v-lives').innerText = "‚ù§Ô∏è".repeat(lives);
            document.getElementById('level-modal').style.display = 'none';
            active = true;
            spawn();
        }

        function handleFail() {
            lives--;
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 200);
            document.getElementById('v-lives').innerText = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
            if(lives <= 0) end();
            else spawn();
        }

        function end() {
            active = false;
            stage.innerHTML = '';
            document.getElementById('res-modal').style.display = 'flex';
            document.getElementById('res-stats').innerHTML = `
                <b>‚Ä¢ Nivel alcanzado:</b> ${lvl}<br>
                <b>‚Ä¢ Aciertos totales:</b> ${totalHits}<br>
                <b>‚Ä¢ Precisi√≥n:</b> ${Math.round((totalHits/(totalHits + (3-lives)))*100) || 0}%
            `;
        }
    </script>
</body>
</html>
