<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>T√∫nel Snellen Pro - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b101b;
            --accent: #bc13fe;
            --neon: #00f2ff;
            --error: #ff4757;
            --success: #22c55e;
            --panel: rgba(28, 35, 49, 0.95);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            color: white;
            transition: background 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
        }

        /* HEADER DETALLADO */
        #header {
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            background: var(--panel);
            border-bottom: 3px solid var(--accent);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: relative;
            z-index: 1000;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--neon);
            font-weight: 700;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 900;
        }

        /* ESCENARIO DE JUEGO */
        #stage {
            position: relative;
            width: 100%;
            height: calc(100vh - 210px);
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, #1a1f2c 0%, #0b101b 100%);
            perspective: 1000px;
        }

        .snellen-e {
            position: absolute;
            font-weight: 900;
            color: white;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 20px var(--neon), 0 0 40px rgba(0, 242, 255, 0.3);
            will-change: transform, opacity;
        }

        /* CONTROLES T√ÅCTILES PROFESIONALES */
        #controls-container {
            height: 140px;
            background: #161b2a;
            border-top: 2px solid #2e3748;
            position: absolute;
            bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: env(safe-area-inset-bottom);
        }

        #controls-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 600px;
            padding: 0 15px;
        }

        .control-btn {
            background: #242b3d;
            border: 3px solid var(--accent);
            border-radius: 20px;
            color: white;
            font-size: 2rem;
            height: 85px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 0 var(--accent);
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 var(--accent);
            background: var(--accent);
        }

        /* MODALES Y OVERLAYS COMPLETO */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 8, 15, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: #1c2331;
            padding: 40px;
            border-radius: 40px;
            border: 4px solid var(--accent);
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 0 50px rgba(188, 19, 254, 0.3);
        }

        .modal h1 {
            color: var(--neon);
            font-weight: 900;
            font-size: 2.8rem;
            margin: 0 0 20px 0;
            text-shadow: 0 0 15px rgba(0, 242, 255, 0.5);
        }

        .instruction-box {
            text-align: left;
            margin: 25px 0;
        }

        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 18px;
            font-size: 1.25rem;
            line-height: 1.4;
        }

        .step-num {
            background: var(--accent);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-right: 15px;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .btn-main {
            background: linear-gradient(45deg, var(--accent), var(--neon));
            color: white;
            padding: 22px;
            border-radius: 20px;
            border: none;
            font-weight: 900;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 1.4rem;
            letter-spacing: 2px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .btn-main:active {
            transform: scale(0.95);
        }

        /* FEEDBACK VISUAL */
        .flash-red { background-color: var(--error) !important; }
        .flash-green { background-color: var(--success) !important; }

        #result-table {
            width: 100%;
            margin: 25px 0;
            border-collapse: collapse;
        }

        #result-table td {
            padding: 12px;
            border-bottom: 1px solid #3e4859;
            font-size: 1.2rem;
        }

        .label-cell { font-weight: 700; color: var(--neon); }
        .value-cell { text-align: right; font-weight: 900; }

    </style>
</head>
<body>

    <div id="header">
        <div class="stat-box">
            <span class="stat-label">Nivel</span>
            <span id="v-lvl" class="stat-value">1</span>
        </div>
        <div id="v-lives" style="font-size: 2rem; letter-spacing: 5px;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="stat-box">
            <span class="stat-label">Aciertos</span>
            <span class="stat-value"><span id="v-hits">0</span>/7</span>
        </div>
    </div>

    <div id="stage"></div>

    <div id="controls-container">
        <div id="controls-grid"></div>
    </div>

    <div id="intro-modal" class="overlay">
        <div class="modal">
            <h1>T√öNEL SNELLEN</h1>
            <div class="instruction-box">
                <div class="step">
                    <div class="step-num">1</div>
                    <div>Identifica la orientaci√≥n de la letra "E" mientras se acerca.</div>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <div>Presiona la flecha correcta. ¬°Cuidado! Los botones cambian de lugar.</div>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <div>Completa 7 aciertos para subir de nivel y recuperar vidas.</div>
                </div>
            </div>
            <button class="btn-main" onclick="startGame()">¬°EMPEZAR JUEGO!</button>
        </div>
    </div>

    <div id="level-modal" class="overlay" style="display:none;">
        <div class="modal">
            <h2 id="lvl-title" style="color:var(--neon); font-weight:900; font-size: 2rem; margin:0;">¬°NIVEL SUPERADO!</h2>
            <p id="lvl-msg" style="font-size: 1.3rem; margin: 25px 0;">Preparando el siguiente desaf√≠o...</p>
            <button class="btn-main" onclick="nextLevel()">CONTINUAR</button>
        </div>
    </div>

    <div id="res-modal" class="overlay" style="display:none;">
        <div class="modal">
            <h1>FIN DEL JUEGO</h1>
            <table id="result-table">
                <tr><td class="label-cell">Nivel Final:</td><td id="res-lvl" class="value-cell">0</td></tr>
                <tr><td class="label-cell">Aciertos:</td><td id="res-hits" class="value-cell">0</td></tr>
                <tr><td class="label-cell">Fallos:</td><td id="res-fails" class="value-cell">0</td></tr>
            </table>
            <p id="status-msg" style="color: var(--neon); font-weight: 700;">Enviando datos al servidor...</p>
            <button class="btn-main" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE CONEXI√ìN (Google Forms) ---
        const FORM_ID = "1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg";
        const ENTRY_PACIENTE = "entry.369874016";
        const ENTRY_JUEGO = "entry.1353470174";
        const ENTRY_NIVEL = "entry.721051298";
        const ENTRY_ACIERTOS = "entry.873272199";
        const ENTRY_FALLOS = "entry.1030094511";
        const ENTRY_EXTRA = "entry.1303309812";
        const ENTRY_FECHA = "entry.845098414";

        // --- VARIABLES DE ESTADO ---
        let lvl = 1;
        let hits = 0;
        let totalHits = 0;
        let totalFails = 0;
        let lives = 3;
        let active = false;
        let currentRot = 0;
        const stage = document.getElementById('stage');
        const controlsGrid = document.getElementById('controls-grid');

        // --- L√ìGICA DE INICIO ---
        function startGame() {
            document.getElementById('intro-modal').style.display = 'none';
            active = true;
            spawn();
        }

        // --- SISTEMA ANTIMEMORIA (SHUFFLE) ---
        function shuffleControls() {
            controlsGrid.innerHTML = '';
            const btns = [
                { rot: 180, icon: '‚¨ÖÔ∏è' },
                { rot: 270, icon: '‚¨ÜÔ∏è' },
                { rot: 90, icon: '‚¨áÔ∏è' },
                { rot: 0, icon: '‚û°Ô∏è' }
            ];
            
            btns.sort(() => Math.random() - 0.5);
            
            btns.forEach(b => {
                const div = document.createElement('div');
                div.className = 'control-btn';
                div.innerHTML = b.icon;
                div.onmousedown = (e) => { e.preventDefault(); checkDir(b.rot); };
                div.ontouchstart = (e) => { e.preventDefault(); checkDir(b.rot); };
                controlsGrid.appendChild(div);
            });
        }

        // --- GENERACI√ìN DE TARGETS ---
        function spawn() {
            if(!active) return;
            stage.innerHTML = '';
            shuffleControls();
            
            const e = document.createElement('div');
            e.className = 'snellen-e';
            const orientations = [0, 90, 180, 270];
            currentRot = orientations[Math.floor(Math.random() * orientations.length)];
            
            // Tama√±o din√°mico basado en nivel
            const baseSize = Math.max(30, 140 - (lvl * 5));
            e.style.fontSize = baseSize + 'px';
            e.innerHTML = 'E';
            e.style.transform = `rotate(${currentRot}deg)`;
            stage.appendChild(e);

            // Velocidad progresiva
            const duration = Math.max(550, 4500 - (lvl * 400));
            
            const animation = e.animate([
                { transform: `rotate(${currentRot}deg) scale(0.1)`, opacity: 0 },
                { opacity: 1, offset: 0.15 },
                { transform: `rotate(${currentRot}deg) scale(8)`, opacity: 0 }
            ], {
                duration: duration,
                easing: 'ease-in'
            });

            animation.onfinish = () => {
                if(e.parentElement && active) {
                    totalFails++;
                    handleFail();
                }
            };
        }

        // --- VALIDACI√ìN ---
        function checkDir(userSelection) {
            if(!active) return;
            
            if(userSelection === currentRot) {
                hits++;
                totalHits++;
                document.getElementById('v-hits').innerText = hits;
                
                if(hits >= 7) {
                    pauseForLevel();
                } else {
                    spawn();
                }
            } else {
                totalFails++;
                handleFail();
            }
        }

        function handleFail() {
            lives--;
            document.body.classList.add('flash-red');
            setTimeout(() => document.body.classList.remove('flash-red'), 200);
            
            updateLivesUI();
            
            if(lives <= 0) {
                endGame();
            } else {
                spawn();
            }
        }

        function updateLivesUI() {
            const display = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
            document.getElementById('v-lives').innerText = display;
        }

        // --- GESTI√ìN DE NIVELES ---
        function pauseForLevel() {
            active = false;
            stage.innerHTML = '';
            
            const modal = document.getElementById('level-modal');
            const title = document.getElementById('lvl-title');
            const msg = document.getElementById('lvl-msg');

            if(lvl % 4 === 0 && lives < 3) {
                lives++;
                title.innerText = "¬°BONUS DE VIDA!";
                title.style.color = "var(--success)";
                msg.innerText = "Tu constancia ha restaurado un ‚ù§Ô∏è.";
                document.body.classList.add('flash-green');
                setTimeout(() => document.body.classList.remove('flash-green'), 600);
            } else {
                title.innerText = "¬°NIVEL SUPERADO!";
                title.style.color = "var(--neon)";
                msg.innerText = "Has completado los 7 aciertos.";
            }
            
            updateLivesUI();
            modal.style.display = 'flex';
        }

        function nextLevel() {
            lvl++;
            hits = 0;
            document.getElementById('v-lvl').innerText = lvl;
            document.getElementById('v-hits').innerText = '0';
            document.getElementById('level-modal').style.display = 'none';
            active = true;
            spawn();
        }

        // --- FINALIZACI√ìN Y ENV√çO ---
        function endGame() {
            active = false;
            stage.innerHTML = '';
            
            document.getElementById('res-lvl').innerText = lvl;
            document.getElementById('res-hits').innerText = totalHits;
            document.getElementById('res-fails').innerText = totalFails;
            document.getElementById('res-modal').style.display = 'flex';
            
            registrarEnSheets();
        }

        function registrarEnSheets() {
            const fecha = new Date().toISOString().split('T')[0];
            const paciente = "PACIENTE_SNELLEN"; // O capturar de variable global si existe
            const juego = "Tunel_Snellen_Dinamico";

            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse?` +
                        `${ENTRY_PACIENTE}=${encodeURIComponent(paciente)}&` +
                        `${ENTRY_JUEGO}=${encodeURIComponent(juego)}&` +
                        `${ENTRY_NIVEL}=${lvl}&` +
                        `${ENTRY_ACIERTOS}=${totalHits}&` +
                        `${ENTRY_FALLOS}=${totalFails}&` +
                        `${ENTRY_EXTRA}=N/A&` +
                        `${ENTRY_FECHA}=${fecha}&` +
                        `submit=Submit`;

            fetch(url, { mode: 'no-cors' })
                .then(() => {
                    document.getElementById('status-msg').innerText = "‚úÖ Datos sincronizados con √©xito.";
                })
                .catch(() => {
                    document.getElementById('status-msg').innerText = "‚ö†Ô∏è Error de conexi√≥n, datos no guardados.";
                });
        }
    </script>
</body>
</html>
