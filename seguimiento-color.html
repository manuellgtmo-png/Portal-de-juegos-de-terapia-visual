<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento M√°gico - Perceptum</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Montserrat', sans-serif; overflow: hidden; touch-action: none; }
        #intro-screen, #result-screen {
            position: fixed; inset: 0; background: #1e293b;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center; z-index: 200;
        }
        .card { background: white; color: #1e293b; padding: 30px; border-radius: 30px; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .habilidades { background: #e0e7ff; color: #4338ca; padding: 12px; border-radius: 15px; font-size: 0.9rem; margin: 15px 0; font-weight: bold; }
        button { background: #22c55e; color: white; border: none; padding: 18px 40px; border-radius: 50px; font-size: 1.2rem; cursor: pointer; font-weight: 900; text-transform: uppercase; }
        #ui-layer { position: absolute; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; box-sizing: border-box; pointer-events: none; z-index: 100; display: none; }
        .stat-box { background: rgba(255,255,255,0.15); backdrop-filter: blur(5px); padding: 10px 20px; border-radius: 20px; }
        canvas { display: block; cursor: crosshair; }
        #goal-bar-container { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 60%; height: 10px; background: rgba(255,255,255,0.2); border-radius: 10px; display:none; }
        #goal-bar-fill { width: 0%; height: 100%; background: #22c55e; border-radius: 10px; transition: width 0.3s; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div class="card">
            <h1 style="margin:0;">üåà Seguimiento M√°gico</h1>
            <div class="habilidades">üéØ Habilidades: Seguimiento, Fijaci√≥n y Sac√°dicos.</div>
            <p>Mant√©n el contacto con el c√≠rculo. ¬°Cuidado! A veces saltar√° de lugar para poner a prueba tus ojos.</p>
            <button onclick="iniciarJuego()">¬°Empezar Nivel 1!</button>
        </div>
    </div>

    <div id="result-screen" style="display: none;">
        <div class="card">
            <h2 id="result-title">¬°Nivel Completado!</h2>
            <p id="result-text"></p>
            <button id="next-btn" onclick="proximoNivel()">Siguiente Nivel</button>
        </div>
    </div>

    <div id="ui-layer">
        <div class="stat-box">Nivel: <span id="txt-nivel">1</span></div>
        <div class="stat-box">Meta: <span id="txt-meta">0</span>s</div>
        <div class="stat-box" id="txt-vidas">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>
    
    <div id="goal-bar-container"><div id="goal-bar-fill"></div></div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let nivelActual = 1;
        let vidas = 3;
        let segundosContacto = 0;
        let tiempoMeta = 15; 
        let juegoActivo = false;
        let enContacto = false;
        let framesFuera = 0;
        let ultimoSalto = 0;

        let x, y, dx, dy, radio;
        const colores = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF'];

        function ajustarDificultad() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Est√≠mulo mucho m√°s grande al inicio
            radio = Math.max(30, 110 - (nivelActual * 8)); 
            let velocidad = 1.8 + (nivelActual * 0.4);
            dx = velocidad; dy = velocidad;
            tiempoMeta = 10 + (nivelActual * 5);
            
            x = Math.random() * (canvas.width - radio * 2) + radio;
            y = Math.random() * (canvas.height - radio * 2) + radio;
        }

        function saltarEstimulo() {
            x = Math.random() * (canvas.width - radio * 2) + radio;
            y = Math.random() * (canvas.height - radio * 2) + radio;
            enContacto = false; // Forzar a que lo busquen
        }

        function iniciarJuego() {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            document.getElementById('goal-bar-container').style.display = 'block';
            
            ajustarDificultad();
            segundosContacto = 0;
            if(nivelActual === 1) vidas = 3;
            
            actualizarUI();
            juegoActivo = true;
            render();
        }

        function actualizarUI() {
            document.getElementById('txt-nivel').innerText = nivelActual;
            document.getElementById('txt-vidas').innerText = "‚ù§Ô∏è".repeat(vidas);
            document.getElementById('txt-meta').innerText = tiempoMeta - segundosContacto;
            document.getElementById('goal-bar-fill').style.width = (segundosContacto / tiempoMeta * 100) + "%";
        }

        // Detecci√≥n t√°ctil y mouse
        const check = (ex, ey) => {
            let dist = Math.sqrt((ex - x)**2 + (ey - y)**2);
            enContacto = dist < radio;
        };
        canvas.addEventListener('mousemove', (e) => check(e.clientX, e.clientY));
        canvas.addEventListener('touchmove', (e) => check(e.touches[0].clientX, e.touches[0].clientY));

        function render() {
            if(!juegoActivo) return;

            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!enContacto) {
                framesFuera++;
                ctx.globalAlpha = 0.3;
                if(framesFuera > 100) { // Margen de error para ni√±os
                    vidas--;
                    framesFuera = 0;
                    actualizarUI();
                    if(vidas <= 0) return finalizarJuego(false);
                }
            } else {
                framesFuera = 0;
                ctx.globalAlpha = 1.0;
                
                // L√≥gica de progreso y saltos
                if(Math.random() < 0.016) { // Aproox cada segundo de contacto
                   // Contador interno simple
                }
            }

            // Dibujar c√≠rculo
            ctx.beginPath();
            ctx.arc(x, y, radio, 0, Math.PI * 2);
            ctx.fillStyle = colores[(nivelActual - 1) % colores.length];
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 6;
            ctx.stroke();
            ctx.closePath();
            ctx.globalAlpha = 1.0;

            // Movimiento
            x += dx; y += dy;
            if(x + radio > canvas.width || x - radio < 0) dx = -dx;
            if(y + radio > canvas.height || y - radio < 0) dy = -dy;

            requestAnimationFrame(render);
        }

        // Cron√≥metro de contacto efectivo
        setInterval(() => {
            if(juegoActivo && enContacto) {
                segundosContacto++;
                actualizarUI();
                
                // Cada 5 segundos de contacto, el est√≠mulo SALTA
                if(segundosContacto % 5 === 0 && segundosContacto !== ultimoSalto) {
                    ultimoSalto = segundosContacto;
                    saltarEstimulo();
                }

                if(segundosContacto >= tiempoMeta) finalizarJuego(true);
            }
        }, 1000);

        function finalizarJuego(exito) {
            juegoActivo = false;
            document.getElementById('result-screen').style.display = 'flex';
            document.getElementById('result-title').innerText = exito ? "¬°Nivel Logrado!" : "¬°Int√©ntalo de nuevo!";
            document.getElementById('next-btn').innerText = exito ? "Siguiente Nivel" : "Reintentar";
        }

        function proximoNivel() {
            if(vidas > 0 && segundosContacto >= tiempoMeta) nivelActual++;
            iniciarJuego();
        }
    </script>
</body>
</html>
