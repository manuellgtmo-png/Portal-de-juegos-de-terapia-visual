<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Barrido Lineal Pro - Perceptum Terapia Visual</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ARQUITECTURA DE DISE√ëO PERCEPTUM --- */
        :root {
            --bg-color: #05080a;
            --accent-color: #00f2ff;
            --secondary-color: #bc13fe;
            --error-color: #ff4757;
            --success-color: #2ed573;
            --panel-bg: rgba(15, 25, 35, 0.98);
            --neon-glow: 0 0 20px rgba(0, 242, 255, 0.6);
            --purple-glow: 0 0 25px rgba(188, 19, 254, 0.5);
            --font-main: 'Montserrat', sans-serif;
        }

        * { box-sizing: border-box; outline: none; }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg-color); font-family: var(--font-main);
            overflow: hidden; color: white; -webkit-user-select: none;
            touch-action: none; transition: background 0.15s ease-in-out;
        }

        /* --- HEADER DE ALTO IMPACTO --- */
        #main-header {
            height: 110px; width: 100%; display: flex; justify-content: space-between;
            align-items: center; padding: 0 60px; background: var(--panel-bg);
            border-bottom: 6px solid var(--secondary-color);
            box-shadow: 0 12px 50px rgba(0,0,0,0.9);
            position: relative; z-index: 2000;
        }

        .stat-box { display: flex; flex-direction: column; align-items: center; min-width: 140px; }
        .stat-label { font-size: 1rem; text-transform: uppercase; letter-spacing: 4px; color: var(--accent-color); font-weight: 800; margin-bottom: 8px; }
        .stat-value { font-size: 2.6rem; font-weight: 900; text-shadow: var(--neon-glow); transition: all 0.3s; }
        
        #lives-display { font-size: 3.2rem; letter-spacing: 18px; filter: drop-shadow(0 0 20px var(--secondary-color)); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #timer-display { color: var(--error-color); }

        /* --- ESCENARIO DE TERAPIA --- */
        #stage {
            position: relative; width: 100%; height: calc(100vh - 110px);
            background-image: 
                radial-gradient(circle at 50% 50%, #111d29 0%, #05080a 100%),
                linear-gradient(rgba(0, 242, 255, 0.03) 2px, transparent 2px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 2px, transparent 2px);
            background-size: 100% 100%, 80px 80px, 80px 80px;
            overflow: hidden; cursor: crosshair;
        }

        /* --- OBJETIVOS DIN√ÅMICOS --- */
        .target-node {
            position: absolute; width: 90px; height: 90px;
            background: #1a2332; border: 5px solid var(--secondary-color);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-weight: 900; font-size: 2.5rem;
            box-shadow: var(--purple-glow); cursor: pointer;
            z-index: 500; color: white;
            animation: nodePop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: transform 0.2s, opacity 0.2s, border-color 0.2s, box-shadow 0.2s;
        }

        @keyframes nodePop { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .target-node.hit-success {
            border-color: var(--accent-color);
            box-shadow: 0 0 60px var(--accent-color), inset 0 0 25px var(--accent-color);
            transform: scale(1.7); opacity: 0; pointer-events: none;
        }

        /* --- MODALES Y OVERLAYS --- */
        .full-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.98);
            display: flex; align-items: center; justify-content: center;
            z-index: 9000; backdrop-filter: blur(30px);
        }

        .modal-box {
            background: #0f1923; padding: 65px; border-radius: 80px;
            border: 8px solid var(--secondary-color); width: 90%; max-width: 750px;
            text-align: center; box-shadow: 0 0 150px rgba(188, 19, 254, 0.4);
        }

        .modal-box h1 { font-size: 4.2rem; color: var(--accent-color); margin: 0 0 20px 0; text-shadow: 0 0 40px var(--accent-color); font-weight: 900; }
        .modal-box p { font-size: 1.8rem; margin-bottom: 45px; color: rgba(255,255,255,0.85); line-height: 1.4; }

        /* --- CONTROLES DE INTERFAZ --- */
        .selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 35px; margin: 45px 0; }
        .selection-card {
            background: #1a2632; border: 5px solid #3e4859; padding: 35px;
            border-radius: 40px; cursor: pointer; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .selection-card.active { border-color: var(--accent-color); background: rgba(0, 242, 255, 0.18); transform: translateY(-12px); box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
        .selection-card h3 { margin: 0 0 12px 0; font-size: 1.8rem; color: var(--accent-color); text-transform: uppercase; }

        .action-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white; padding: 30px; border-radius: 35px; border: none;
            width: 100%; font-size: 2.6rem; font-weight: 900; cursor: pointer;
            letter-spacing: 6px; box-shadow: 0 25px 50px rgba(0,0,0,0.7);
            transition: all 0.3s;
        }
        .action-btn:hover { filter: brightness(1.2); transform: scale(1.02); }
        .action-btn:active { transform: scale(0.96); }

        /* --- TABLA DE RESULTADOS PROFESIONAL --- */
        .results-wrapper { width: 100%; margin: 45px 0; border-collapse: separate; border-spacing: 0 22px; }
        .results-wrapper td { padding: 28px; background: rgba(255,255,255,0.07); font-size: 2.2rem; }
        .res-key { border-radius: 35px 0 0 35px; color: var(--accent-color); font-weight: 800; text-align: left; padding-left: 40px !important; }
        .res-val { border-radius: 0 35px 35px 0; text-align: right; font-weight: 900; padding-right: 40px !important; }

        /* --- COMPONENTES ADICIONALES --- */
        .flash-red-alert { background-color: var(--error-color) !important; }
        input[type="range"] { width: 100%; height: 18px; border-radius: 12px; accent-color: var(--accent-color); margin: 30px 0; cursor: pointer; }
        
        #next-level-overlay { display: none; }
    </style>
</head>
<body onmousedown="handleStageClick(event)">

    <header id="main-header">
        <div class="stat-box"><span class="stat-label">Nivel</span><span id="v-lvl" class="stat-value">1</span></div>
        <div id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="stat-group stat-box"><span class="stat-label" id="t-label">Modo Libre</span><span id="v-timer" class="stat-value">--</span></div>
    </header>

    <div id="stage"></div>

    <div id="modal-start" class="full-overlay">
        <div class="modal-box">
            <h1>BARRIDO LINEAL</h1>
            <p>Escanea y toca los n√∫meros en orden secuencial.</p>
            <div class="selection-grid">
                <div class="selection-card active" id="opt-libre" onclick="selectGameMode('libre')">
                    <h3>MODO LIBRE</h3>
                    <small>Sin presi√≥n de tiempo</small>
                </div>
                <div class="selection-card" id="opt-flash" onclick="selectGameMode('flash')">
                    <h3>CAZADOR FLASH</h3>
                    <small>Reto cronometrado</small>
                </div>
            </div>
            <div id="timer-config" style="display:none; margin: 35px 0; padding: 30px; background: rgba(0,0,0,0.3); border-radius: 35px;">
                <label style="font-size: 1.7rem; font-weight: 800;">TIEMPO L√çMITE: <span id="val-t" style="color:var(--accent-color)">15</span>s</label>
                <input type="range" id="input-t" min="5" max="40" value="15" oninput="document.getElementById('val-t').innerText=this.value">
            </div>
            <button class="action-btn" onclick="initiateSession()">INICIAR TERAPIA</button>
        </div>
    </div>

    <div id="next-level-overlay" class="full-overlay">
        <div class="modal-box" style="border-color: var(--success-color);">
            <h1 style="color: var(--success-color);">¬°NIVEL COMPLETADO!</h1>
            <p style="font-size: 1.8rem;">Excelente barrido visual. ¬øPreparado para el siguiente nivel?</p>
            <button class="action-btn" onclick="moveToNextLevel()" style="background: var(--success-color);">SIGUIENTE NIVEL</button>
        </div>
    </div>

    <div id="modal-res" class="full-overlay" style="display:none;">
        <div class="modal-box">
            <h1 style="color: var(--error-color);">SESI√ìN FINALIZADA</h1>
            <table class="results-wrapper">
                <tr><td class="res-key">Nivel Alcanzado:</td><td id="res-lvl" class="res-val">1</td></tr>
                <tr><td class="res-key">Aciertos Totales:</td><td id="res-hits" class="res-val">0</td></tr>
            </table>
            <p id="cloud-log" style="color: var(--accent-color); font-weight: 900; letter-spacing: 3px;">SINCRONIZANDO CON PERCEPTUM CLOUD...</p>
            <button class="action-btn" onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE NUBE (ESTRICTA) ---
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const ENTRIES = {
            paciente: "entry.369874016",
            juego: "entry.1353470174",
            nivel: "entry.721051298",
            aciertos: "entry.873272199",
            fallos: "entry.1030094511",
            tiempo: "entry.1303309812",
            fecha: "entry.845098414"
        };

        // --- MOTOR DE AUDIO ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        function playTherapySound(freq, type, duration, volume) {
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                gain.gain.setValueAtTime(volume, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                osc.connect(gain); gain.connect(audioContext.destination);
                osc.start(); osc.stop(audioContext.currentTime + duration);
            } catch(e) {}
        }

        // --- L√ìGICA DE JUEGO ---
        let level = 1, lives = 3, nextNumber = 1, totalHits = 0, totalFails = 0;
        let isSessionActive = false, gameMode = 'libre', timeLimit = 15, timeLeft = 0, clock = null;
        let positions = [];

        function selectGameMode(m) {
            gameMode = m;
            document.getElementById('opt-libre').classList.toggle('active', m === 'libre');
            document.getElementById('opt-flash').classList.toggle('active', m === 'flash');
            document.getElementById('timer-config').style.display = m === 'flash' ? 'block' : 'none';
            document.getElementById('t-label').innerText = m === 'flash' ? "Cron√≥metro" : "Modo Libre";
        }

        function initiateSession() {
            if (audioContext.state === 'suspended') audioContext.resume();
            if (gameMode === 'flash') timeLimit = parseInt(document.getElementById('input-t').value);
            document.getElementById('modal-start').style.display = 'none';
            isSessionActive = true;
            renderLevel();
        }

        function renderLevel() {
            if (!isSessionActive) return;
            const stage = document.getElementById('stage');
            stage.innerHTML = '';
            nextNumber = 1;
            positions = [];
            const count = 2 + level;

            for (let i = 1; i <= count; i++) {
                const node = document.createElement('div');
                node.className = 'target-node';
                node.innerText = i;

                let x, y, isOverlapping;
                let tries = 0;
                do {
                    isOverlapping = false;
                    x = 80 + Math.random() * (window.innerWidth - 180);
                    y = 80 + Math.random() * (stage.offsetHeight - 180);
                    for (let p of positions) {
                        if (Math.hypot(x - p.x, y - p.y) < 120) {
                            isOverlapping = true; break;
                        }
                    }
                    tries++;
                } while (isOverlapping && tries < 100);

                positions.push({ x, y });
                node.style.left = `${x}px`;
                node.style.top = `${y}px`;
                node.onmousedown = (e) => { e.stopPropagation(); validateHit(i, node); };
                stage.appendChild(node);
            }
            if (gameMode === 'flash') startTimer();
        }

        function validateHit(num, el) {
            if (!isSessionActive) return;
            if (num === nextNumber) {
                playTherapySound(850, 'sine', 0.2, 0.15);
                el.classList.add('hit-success');
                totalHits++; nextNumber++;
                if (nextNumber > (2 + level)) {
                    clearInterval(clock);
                    pauseForNextLevel();
                }
            } else {
                processMistake();
            }
        }

        function handleStageClick(e) {
            if (isSessionActive && !e.target.classList.contains('target-node')) {
                processMistake();
            }
        }

        function processMistake() {
            playTherapySound(140, 'sawtooth', 0.4, 0.2);
            lives--; totalFails++;
            document.body.classList.add('flash-red-alert');
            setTimeout(() => document.body.classList.remove('flash-red-alert'), 250);
            updateLivesUI();
            if (lives <= 0) terminateSession(); else renderLevel();
        }

        function startTimer() {
            clearInterval(clock);
            timeLeft = timeLimit;
            document.getElementById('v-timer').innerText = timeLeft + "s";
            clock = setInterval(() => {
                timeLeft--;
                document.getElementById('v-timer').innerText = timeLeft + "s";
                if (timeLeft <= 0) { clearInterval(clock); processMistake(); }
            }, 1000);
        }

        function pauseForNextLevel() {
            isSessionActive = false;
            playTherapySound(1200, 'sine', 0.4, 0.1);
            document.getElementById('next-level-overlay').style.display = 'flex';
        }

        function moveToNextLevel() {
            level++;
            document.getElementById('v-lvl').innerText = level;
            document.getElementById('next-level-overlay').style.display = 'none';
            if (level % 4 === 0 && lives < 3) {
                lives++; updateLivesUI();
            }
            isSessionActive = true;
            renderLevel();
        }

        function updateLivesUI() {
            const container = document.getElementById('lives-display');
            container.innerText = lives > 0 ? "‚ù§Ô∏è".repeat(lives) : "üíÄ";
        }

        function terminateSession() {
            isSessionActive = false;
            clearInterval(clock);
            document.getElementById('res-lvl').innerText = level;
            document.getElementById('res-hits').innerText = totalHits;
            document.getElementById('modal-res').style.display = 'flex';
            syncToCloud();
        }

        function syncToCloud() {
            const dateStr = new Date().toISOString().split('T')[0];
            const data = new URLSearchParams();
            data.append(ENTRIES.paciente, "PACIENTE_BARRIDO");
            data.append(ENTRIES.juego, "Barrido_Lineal_PRO");
            data.append(ENTRIES.nivel, level);
            data.append(ENTRIES.aciertos, totalHits);
            data.append(ENTRIES.fallos, totalFails);
            data.append(ENTRIES.tiempo, timeLimit + "s");
            data.append(ENTRIES.fecha, dateStr);

            fetch(GOOGLE_FORM_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: data
            }).then(() => {
                const log = document.getElementById('cloud-log');
                log.innerText = "‚úÖ SESI√ìN SINCRONIZADA CON √âXITO";
                log.style.color = "var(--success-color)";
            }).catch(() => {
                document.getElementById('cloud-log').innerText = "‚ö†Ô∏è ERROR DE CONEXI√ìN";
            });
        }
    </script>
</body>
</html>
